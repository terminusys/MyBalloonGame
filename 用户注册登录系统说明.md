# 👤 用户注册登录系统说明 v3.0.0

## 更新时间：2026年2月12日

---

## 🎯 重大升级

游戏现在需要**注册和登录**才能开始！所有用户数据（钻石、金币）都保存在云端数据库中。

---

## ⚠️ 部署前必须操作

### 第一步：创建用户表（5分钟）

1. **打开 Supabase Dashboard**
   ```
   https://supabase.com/dashboard/project/ksctfambipodjbrtjaby
   ```

2. **进入 SQL Editor**（左侧菜单）

3. **运行SQL脚本**
   - 打开文件：`setup_users_table.sql`
   - 复制全部内容
   - 粘贴到 SQL 编辑器
   - 点击 **"Run"** 按钮

4. **验证创建成功**
   ```sql
   SELECT * FROM public.game_users;
   ```
   应该看到一个空表（0行）✅

---

## 🎮 用户使用流程

### 新用户：注册流程

1. **访问游戏**
   ```
   https://my-balloon-game.vercel.app/
   ```

2. **看到登录界面**
   - 用户名输入框
   - 密码输入框
   - "🚀 登录"按钮
   - "📝 注册新账号"按钮

3. **点击"📝 注册新账号"**
   - 进入注册表单

4. **填写注册信息**
   
   **必填项**：
   - ✅ 用户名（2-20字符）
   - ✅ 密码（至少6个字符）
   - ✅ 确认密码

   **可选项**：
   - 国家（下拉选择）
   - 地区/城市
   - 性别（下拉选择）
   - 年龄
   - 手机号

5. **点击"✅ 提交注册"**
   - 系统验证信息
   - 检查用户名是否已存在
   - 创建新账号

6. **注册成功**
   - 自动返回登录界面
   - 用户名已自动填充
   - 输入密码即可登录

### 老用户：登录流程

1. **访问游戏**
2. **在登录界面输入**
   - 用户名
   - 密码
3. **点击"🚀 登录"**
4. **登录成功**
   - 自动加载游戏数据（钻石、金币）
   - 显示欢迎信息
   - 开始游戏

### 自动登录

如果之前登录过，下次访问会**自动登录**：
- ✅ 无需再次输入账号密码
- ✅ 自动加载游戏数据
- ✅ 直接进入游戏

---

## 💾 数据存储

### 用户信息存储

所有用户信息保存在 **Supabase数据库** `game_users`表中：

| 字段 | 类型 | 说明 |
|------|------|------|
| id | 整数 | 用户ID（自动生成）|
| username | 文本 | 用户名（唯一） |
| password | 文本 | 密码 |
| country | 文本 | 国家 |
| region | 文本 | 地区 |
| gender | 文本 | 性别 |
| age | 整数 | 年龄 |
| phone | 文本 | 手机号 |
| diamonds | 整数 | 钻石数量 |
| coins_collected | 整数 | 收集的金币总数 |
| created_at | 时间戳 | 注册时间 |
| last_login | 时间戳 | 最后登录时间 |
| is_active | 布尔 | 账号是否激活 |

### 游戏数据同步

每次游戏数据变化时（收集金币、钻石等），自动保存到数据库：

```javascript
// 自动调用
saveUserGameData()
  → 更新 diamonds
  → 更新 coins_collected
  → 同时保存到 localStorage
```

**优点**：
- ✅ 数据云端保存，永不丢失
- ✅ 换设备也能继续游戏
- ✅ 数据实时同步

---

## 🔐 安全性说明

### ⚠️ 当前实现（演示版）

**密码存储**：明文存储
- ❌ 不安全
- ⚠️ 仅用于演示
- ⚠️ 不适合生产环境

**权限控制**：客户端验证
- ✅ 任何人都可以注册
- ✅ 任何人都可以读取用户信息
- ⚠️ 没有严格的权限控制

### ✅ 生产环境建议

如果要用于真实项目，需要：

1. **密码加密**
   ```sql
   -- 使用 pgcrypto 扩展
   CREATE EXTENSION IF NOT EXISTS pgcrypto;
   
   -- 注册时加密密码
   INSERT INTO game_users (username, password)
   VALUES ('user1', crypt('password123', gen_salt('bf')));
   
   -- 登录时验证
   SELECT * FROM game_users
   WHERE username = 'user1'
   AND password = crypt('password123', password);
   ```

2. **使用JWT Token**
   - 登录后返回token
   - 后续请求携带token
   - 不再传输密码

3. **严格的RLS策略**
   ```sql
   -- 只能读取自己的信息
   CREATE POLICY "用户只能读取自己的数据"
   ON game_users FOR SELECT
   USING (auth.uid() = id);
   
   -- 只能更新自己的信息
   CREATE POLICY "用户只能更新自己的数据"
   ON game_users FOR UPDATE
   USING (auth.uid() = id);
   ```

4. **邮箱验证**
   - 注册时发送验证邮件
   - 验证后才能登录

5. **防暴力破解**
   - 登录失败次数限制
   - IP黑名单
   - 验证码

---

## 📝 代码示例

### 注册新用户

```javascript
// 客户端代码
const { data, error } = await supabaseClient
  .from('game_users')
  .insert([{
    username: 'zhangsan',
    password: 'password123',  // 生产环境应加密
    country: '中国',
    region: '北京',
    gender: '男',
    age: 25,
    phone: '13800138000'
  }])
  .select()
  .single();

if (data) {
  console.log('注册成功！用户ID:', data.id);
}
```

### 用户登录

```javascript
// 客户端代码
const { data, error } = await supabaseClient
  .from('game_users')
  .select('*')
  .eq('username', 'zhangsan')
  .eq('password', 'password123')  // 生产环境应使用加密验证
  .single();

if (data) {
  console.log('登录成功！', data);
  currentUserId = data.id;
  playerName = data.username;
  gameDiamonds = data.diamonds;
}
```

### 保存游戏数据

```javascript
// 自动调用
async function saveUserGameData() {
  await supabaseClient
    .from('game_users')
    .update({
      diamonds: gameDiamonds,
      coins_collected: totalCoinsCollected
    })
    .eq('id', currentUserId);
}
```

---

## 🧪 测试验证

### 测试1：注册新用户（2分钟）

1. 访问游戏
2. 点击"📝 注册新账号"
3. 填写信息：
   - 用户名：`test001`
   - 密码：`123456`
   - 确认密码：`123456`
   - 国家：`中国`
4. 点击"✅ 提交注册"
5. **检查**：是否提示"注册成功"？
6. **检查**：是否自动返回登录界面？
7. **检查**：用户名是否已填充为`test001`？

### 测试2：登录（1分钟）

1. 在登录界面输入：
   - 用户名：`test001`
   - 密码：`123456`
2. 点击"🚀 登录"
3. **检查**：是否提示"欢迎回来，test001！"？
4. **检查**：是否显示钻石和金币数量？
5. **检查**：是否进入游戏界面？

### 测试3：数据持久化（3分钟）

1. 登录后玩游戏
2. 收集一些金币和钻石
3. 记录当前数量（例如：💎50, 🪙120）
4. 点击"🚪 退出登录"
5. 刷新页面
6. 重新登录（相同账号）
7. **检查**：钻石和金币是否和之前一样？

### 测试4：自动登录（1分钟）

1. 登录后正常玩游戏
2. 关闭浏览器标签页
3. 重新打开游戏链接
4. **检查**：是否自动登录？
5. **检查**：是否直接进入游戏？
6. **检查**：数据是否正确？

### 测试5：重复用户名（1分钟）

1. 尝试注册已存在的用户名
2. **检查**：是否提示"用户名已被使用"？
3. **检查**：是否无法注册？

---

## 🔧 管理员操作

### 查看所有用户

在 Supabase SQL Editor 中：

```sql
SELECT 
  id,
  username,
  country,
  region,
  gender,
  age,
  diamonds AS 钻石,
  coins_collected AS 金币,
  created_at AS 注册时间,
  last_login AS 最后登录
FROM game_users
ORDER BY created_at DESC;
```

### 查看用户统计

```sql
-- 总用户数
SELECT COUNT(*) AS 总用户数 FROM game_users;

-- 今日新增用户
SELECT COUNT(*) AS 今日新增 
FROM game_users 
WHERE created_at >= CURRENT_DATE;

-- 活跃用户（7天内登录过）
SELECT COUNT(*) AS 活跃用户 
FROM game_users 
WHERE last_login >= CURRENT_DATE - INTERVAL '7 days';

-- 钻石排行榜
SELECT username, diamonds, coins_collected
FROM game_users
ORDER BY diamonds DESC
LIMIT 10;
```

### 重置用户数据

```sql
-- 重置某个用户的游戏数据
UPDATE game_users
SET diamonds = 0, coins_collected = 0
WHERE username = 'test001';

-- 禁用某个用户
UPDATE game_users
SET is_active = false
WHERE username = 'baduser';

-- 删除某个用户
DELETE FROM game_users
WHERE username = 'spam_account';
```

---

## ❓ 常见问题

### Q1：忘记密码怎么办？

**当前版本**：没有找回密码功能
- 只能重新注册新账号
- 旧账号数据无法找回

**建议**：记住密码或写下来

**未来版本**：可以添加
- 邮箱验证找回密码
- 手机验证码找回密码

### Q2：可以修改用户名吗？

**回答**：不可以
- 用户名是注册时设定的
- 无法更改
- 如需更改，只能注册新账号

### Q3：数据会丢失吗？

**回答**：不会
- 所有数据保存在云端数据库
- 即使清除浏览器缓存也不会丢失
- 换设备登录也能看到数据

### Q4：同一个用户名可以在多个设备登录吗？

**回答**：可以
- 同一个账号可以在不同设备登录
- 数据会同步
- 但同时登录可能会有数据冲突

### Q5：密码安全吗？

**回答**：不安全（当前版本）
- ⚠️ 密码明文存储
- ⚠️ 任何有数据库权限的人都能看到
- ⚠️ 仅用于演示，不要用真实密码

**建议**：使用简单的测试密码，不要使用常用密码

---

## 📊 技术统计

- **新增文件**：`setup_users_table.sql`
- **修改文件**：`index.html`
- **新增代码**：~400行
- **新增功能**：注册、登录、数据持久化
- **数据库表**：1个（game_users）

---

## 🚀 未来计划

- [ ] 密码加密存储
- [ ] 邮箱验证
- [ ] 找回密码功能
- [ ] 用户头像
- [ ] 好友系统
- [ ] 排行榜
- [ ] 每日签到
- [ ] 成就系统

---

**版本：v3.0.0** | **更新时间：2026年2月12日** | **状态：✅ 已部署** 🎉
