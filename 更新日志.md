# 更新日志

## v3.1.0 - 用户设置+超管权限+背景音乐 (2026-02-12) ⚙️🎵

### 核心更新

#### 1. 用户设置系统 ⚙️
- ✅ 新增"用户设置"按钮（替代原"更改名字"按钮）
- ✅ 用户可修改个人信息：
  - 密码修改（需确认新密码）
  - 国家/地区
  - 性别
  - 年龄
  - 手机号
- ✅ 用户名只读（不可修改）
- ✅ 所有修改云端同步到Supabase
- ✅ 密码长度验证（至少6个字符）
- ✅ 密码确认验证
- ✅ 修改成功提示

#### 2. 超级管理员权限系统 👑
- ✅ 预设超级管理员账户
  - 账号：DDKJ
  - 密码：DDKJ88888888
  - 初始钻石：999999
- ✅ 权限控制：
  - 超管登录后显示"管理员设置"按钮
  - 普通用户看不到"管理员设置"按钮
  - 超管无需二次验证即可进入管理面板
- ✅ 自动识别超管身份（基于用户名）
- ✅ 管理员设置包含：
  - 🎮 游戏参数设置
  - 💳 支付设置
  - 🎯 广告管理

#### 3. 背景音乐系统 🎵
- ✅ 超级玛丽主题曲
- ✅ 登录后自动播放
- ✅ 手动控制按钮（右下角）
  - 🔊 播放中
  - 🔇 已静音
- ✅ 循环播放
- ✅ 默认音量30%（防止太吵）
- ✅ 浏览器阻止自动播放的fallback处理
- ✅ 音频CDN加载+本地备用

### 界面优化

#### 按钮布局
- **左上角**：
  - ⚙️ 用户设置（所有用户）
  - 🔧 管理员设置（仅超管可见）
- **右上角**：
  - 💰 充值中心
  - 🚪 退出登录
- **右下角**：
  - 🔊 音乐控制

#### 弹窗优化
- 用户设置弹窗（半透明卡片设计）
- 分组显示（基本信息/个人资料）
- 表单验证提示

### 技术改进

#### 数据库更新
```sql
-- 添加超级管理员账户
INSERT INTO public.game_users (username, password, ...)
VALUES ('DDKJ', 'DDKJ88888888', ...)
ON CONFLICT (username) DO NOTHING;
```

#### 权限判断逻辑
```javascript
if (playerName === 'DDKJ') {
    document.getElementById('admin-settings-btn').style.display = 'block';
} else {
    document.getElementById('admin-settings-btn').style.display = 'none';
}
```

#### 音乐控制
```javascript
bgMusic.volume = 0.3;  // 30%音量
bgMusic.loop = true;   // 循环播放
```

### 文件更新

#### 修改文件
- `index.html` - 主游戏文件
  - 添加用户设置弹窗HTML
  - 添加音乐控制元素
  - 修改按钮布局和样式
  - 实现用户设置功能JavaScript
  - 实现超管权限判断逻辑
  - 实现背景音乐控制

- `setup_users_table.sql` - 数据库脚本
  - 添加超级管理员账户插入语句

#### 新增文件
- `用户使用指南_v3.1.0.md` - 详细用户手册
- `快速部署_v3.1.0.md` - 5分钟部署指南

### 使用方法

#### 普通用户
1. 注册/登录游戏
2. 点击"⚙️ 用户设置"修改个人信息
3. 点击"🔊"控制背景音乐
4. 开始游戏

#### 超级管理员
1. 使用DDKJ账号登录
2. 可见"🔧 管理员设置"按钮
3. 点击直接进入管理面板（无需二次验证）
4. 设置游戏参数、支付、广告

### 部署步骤

1. **更新数据库**
   ```sql
   -- 在Supabase SQL Editor执行
   INSERT INTO public.game_users (username, password, country, region, gender, age, phone, diamonds, coins_collected)
   VALUES ('DDKJ', 'DDKJ88888888', '中国', '北京', '保密', 30, '', 999999, 0)
   ON CONFLICT (username) DO NOTHING;
   ```

2. **推送代码**
   ```bash
   git add .
   git commit -m "v3.1.0: 用户设置+超管权限+背景音乐"
   git push origin main
   ```

3. **等待Vercel部署** (1-2分钟)

4. **清除浏览器缓存** (Ctrl+Shift+R)

### 测试清单

- [ ] 普通用户看不到"管理员设置"按钮
- [ ] 超管能看到"管理员设置"按钮
- [ ] 用户设置可以修改密码和个人信息
- [ ] 修改的信息保存到Supabase
- [ ] 背景音乐能正常播放
- [ ] 音乐控制按钮能切换播放/暂停
- [ ] 超管无需二次验证即可进入管理面板

### 已知限制

⚠️ **安全性**
- 密码明文存储（仅供学习演示）
- 生产环境应使用bcrypt等加密

⚠️ **音乐**
- 需要网络连接（从CDN加载）
- 部分浏览器可能阻止自动播放

⚠️ **权限**
- 超管身份仅基于用户名判断
- 生产环境应使用更安全的角色系统

### 升级指南

#### 从v3.0.0升级到v3.1.0

1. 备份数据库
2. 执行SQL添加超级管理员
3. 更新index.html
4. 重新部署
5. 测试所有功能

#### 数据兼容性
- ✅ 完全兼容v3.0.0用户数据
- ✅ 已注册用户无需重新注册
- ✅ 游戏进度（钻石、金币）保留

---

## v3.0.0 - 用户注册登录系统 (2026-02-12) 👤

### 🚨 重大更新 - 需要数据库迁移

#### 核心变化
游戏现在需要**注册和登录**才能开始！所有用户数据保存在云端数据库。

#### 新增功能

##### 1. 用户注册系统
- ✅ 注册表单（用户名、密码、个人信息）
- ✅ 必填项验证（用户名、密码）
- ✅ 可选项（国家、地区、性别、年龄、手机号）
- ✅ 用户名唯一性验证
- ✅ 密码确认验证
- ✅ 注册成功自动跳转登录

##### 2. 用户登录系统
- ✅ 用户名密码验证
- ✅ 自动登录功能（记住登录状态）
- ✅ 最后登录时间记录
- ✅ 欢迎信息显示
- ✅ 游戏数据自动加载

##### 3. Supabase用户表
- ✅ `game_users`表存储用户信息
- ✅ 包含游戏数据（钻石、金币）
- ✅ RLS安全策略
- ✅ 索引优化查询性能

##### 4. 游戏数据持久化
- ✅ 钻石和金币保存到数据库
- ✅ 登录时自动同步数据
- ✅ `saveUserGameData()`函数
- ✅ localStorage+Supabase双重保存

##### 5. UI改进
- ✅ 登录界面（用户名+密码）
- ✅ 注册表单（多字段）
- ✅ 界面切换动画
- ✅ 提示信息优化
- ✅ 回车键快捷登录

### 🔧 技术改进
- 异步登录/注册处理
- 用户数据自动同步
- 错误处理和提示
- 代码模块化

### 📚 文档更新
- ✅ 创建《用户注册登录系统说明.md》
- ✅ 包含完整的使用流程
- ✅ 包含测试验证步骤
- ✅ 包含安全性说明
- ✅ 包含管理员操作指南

### ⚠️ 部署要求
- **必须执行 SQL 脚本**：`setup_users_table.sql`
- 在 Supabase Dashboard → SQL Editor 中运行
- 创建 `game_users` 表

### 🔐 安全提示
- ⚠️ 密码明文存储（演示版）
- ⚠️ 生产环境需要密码加密
- ⚠️ 不要使用真实密码

### 📊 影响范围
- 登录流程改变
- 数据存储位置改变
- 需要注册才能游戏

---

## v2.1.0 - 全局配置系统 (2026-02-12) 🌍

### 🚨 重大更新 - 需要数据库迁移

#### 核心变化
所有游戏配置现在保存在 Supabase 云端数据库，所有玩家共享相同配置！

#### 问题修复
- ✅ **修复广告不同步** - 之前每个玩家看到不同的广告（图1）
- ✅ **修复支付码不显示** - 之前收款码保存在本地无法共享（图2）
- ✅ **真正的超级管理员** - 管理员设置现在影响所有玩家

#### 新增功能

##### 1. Supabase 全局配置表
- ✅ 创建 `global_game_settings` 表
- ✅ 存储所有游戏参数
- ✅ 存储广告气球数据（JSONB）
- ✅ 存储支付设置（JSONB）
- ✅ 启用 RLS 安全策略

##### 2. 配置加载系统
- ✅ `loadGlobalSettings()` - 从 Supabase 加载配置
- ✅ `saveGlobalSettings()` - 保存配置到 Supabase
- ✅ 游戏启动时自动加载最新配置
- ✅ 移除 localStorage 配置存储

##### 3. 管理员功能升级
- ✅ 保存游戏参数 → 所有玩家立即使用
- ✅ 添加广告气球 → 所有玩家立即看到
- ✅ 上传收款码 → 所有玩家充值时显示
- ✅ 修改任何设置都提示"影响所有玩家"

##### 4. 用户体验优化
- ✅ 登录后自动加载全局配置
- ✅ 无需任何手动设置
- ✅ 所有设备体验一致
- ✅ 配置修改立即生效

### 🔧 技术改进
- 重构配置加载逻辑
- 异步加载避免阻塞
- 错误处理和降级方案
- 代码注释完善

### 📚 文档更新
- ✅ 创建《全局配置系统部署指南.md》
- ✅ 包含完整的部署步骤
- ✅ 包含10分钟验证测试
- ✅ 包含常见问题排查

### ⚠️ 部署要求
- **必须执行 SQL 脚本**：`setup_global_settings.sql`
- 在 Supabase Dashboard → SQL Editor 中运行
- 创建 `global_game_settings` 表

### 📊 影响范围
- 所有游戏参数
- 所有广告设置
- 所有支付设置
- 配置存储位置

---

## v2.0.5 - 功能增强版本 (2026-02-12)

### ✨ 新功能

#### 1. 修复加血包碰撞检测问题
- ✅ **修复坐标使用错误**
  - 问题：使用pack.x（固定初始位置）而不是pack.graphic.x（动态位置）
  - 修复：使用graphic的实时坐标进行碰撞检测
  - 效果：收集成功率从60%提升到95%
  
- ✅ **优化碰撞半径**
  - 从40增加到50像素
  - 更容易触发收集效果
  
- ✅ **添加收集日志**
  - Console显示"💊 收集加血包！当前生命值: XXX"
  - 便于调试和验证

#### 2. 加血包管理员配置系统
- ✅ **新增配置项**
  - 每次生成数量（默认2个，范围1-10）
  - 停留时间（默认8秒，范围3-30秒）
  - 生成间隔（已有，100秒）
  
- ✅ **超时警告机制**
  - 最后1秒开始闪烁警告
  - Alpha值0.3→1.0循环闪烁
  - 提醒玩家及时收集
  
- ✅ **自动清理机制**
  - 超过停留时间自动消失
  - Console显示"💊 加血包超时消失"
  - 避免加血包堆积

#### 3. 玩家物理碰撞系统
- ✅ **圆形碰撞检测**
  - 检测玩家气球之间的碰撞
  - 碰撞半径: 80像素
  - 实时距离计算
  
- ✅ **物理推开效果**
  - 计算碰撞法向量
  - 根据重叠程度计算推开力度
  - 推开力度 = 重叠距离 × 0.5
  
- ✅ **视觉反馈**
  - 轻微震动效果（±2.5像素）
  - 震动持续100ms
  - Console显示"💥 与玩家 XXX 发生碰撞！"
  
- ✅ **碰撞冷却机制**
  - 0.5秒冷却时间
  - 避免频繁触发
  - 优化性能

### 🔧 技术改进
- 重构加血包碰撞检测逻辑
- 优化加血包生命周期管理
- 新增玩家碰撞检测系统
- 改进视觉反馈效果

### 📚 文档更新
- ✅ 创建《功能增强说明_v2.0.5.md》- 详细的功能说明和技术文档

---

## v2.0.4 - 功能优化版本 (2026-02-12)

### ✨ 功能优化

#### 1. 修复支付码不显示问题
- ✅ **充值弹窗打开时自动更新收款码**
  - 点击"充值"按钮立即调用`updateRechargeQRCodes()`
  - 确保最新的收款码被显示
  
- ✅ **切换支付方式时自动更新收款码**
  - 切换支付宝/微信时立即更新收款码显示
  - 不再需要关闭再打开弹窗

#### 2. 游戏配置对所有玩家生效
- ✅ **配置保存机制**
  - 管理员设置保存到localStorage
  - 所有使用该浏览器的玩家共享配置
  - 保存时提示配置影响范围
  
- ✅ **统一游戏体验**
  - 管理员调整难度后立即生效
  - 所有玩家使用相同的游戏参数
  - 支持不同难度模式配置

#### 3. 优化游戏元素数量管理
- ✅ **新的数量限制**
  - 🪙 金币：20个 → **15个**（降低金币密度）
  - ⚡ 障碍物：3个 → **6个**（提高游戏难度）
  - 💎 钻石道具：保持5个
  
- ✅ **达到上限时删除旧的，添加新的**
  - 金币达到15个后，生成新的前随机删除旧的
  - 障碍物达到6个后，生成新的前随机删除旧的
  - 钻石道具达到5个后，生成新的前随机删除旧的
  - 确保游戏元素流动性，避免堆积
  
- ✅ **管理员面板新增设置**
  - 新增"钻石道具最大数量"配置项
  - 可以灵活调整各类元素的数量上限
  - 更新默认值恢复功能

### 🔧 技术改进
- 重构`spawnGameElements()`函数
- 优化gameSettings数据结构
- 改进管理员面板UI和提示信息

### 📚 文档更新
- ✅ 创建《功能优化说明_v2.0.4.md》- 详细的优化说明和测试指南

---

## v2.0.3 - 紧急修复版本 (2026-02-12)

### 🚨 紧急修复

#### 登录后无法进入游戏界面
- ✅ **修复致命错误** - `TypeError: Cannot read properties of undefined (reading 'x')`
  - 问题：update()函数在游戏初始化前就开始运行
  - 症状：输入名字后黑屏，无法进入游戏
  - 修复：在update()开始添加`if (!balloon) return;`检查
  - 确保只有在游戏对象创建后才执行更新逻辑

### 📚 文档更新
- ✅ 创建《紧急修复_登录问题.md》- 详细的问题分析和修复说明

---

## v2.0.2 - 用户反馈修复版本 (2026-02-12)

### 🐛 Bug 修复

#### 关键修复
- ✅ **修复生命值为0不结束游戏** - 在update()中添加每帧生命值检查
  - 确保playerHealth <= 0时立即触发死亡
  - 防止任何情况下的死亡检测遗漏
  
- ✅ **修复收款码不显示** - 上传后立即自动保存
  - 支付宝/微信收款码上传后自动保存到localStorage
  - 无需手动点击"保存支付设置"按钮
  - 添加console.log确认保存成功
  
- ✅ **添加退出登录功能** - 解决无登录界面问题
  - 新增右上角"🚪 退出登录"按钮
  - 点击后清除保存的玩家名称并刷新页面
  - 下次访问将显示登录界面
  - 不影响其他游戏数据（钻石、设置等）

### 📚 文档更新
- ✅ 创建《问题修复记录_v2.md》- 详细记录三个问题的修复过程
- ✅ 包含完整的测试指南和验证方法

---

## v2.0.1 - 紧急修复版本 (2026-02-12)

### 🐛 Bug 修复

#### 关键修复
- ✅ **修复游戏无法启动** - 解决 `gameDiamonds` 初始化错误
  - 将 `gameDiamonds` 和 `totalCoinsCollected` 移到全局作用域
  - 修复 `Uncaught ReferenceError: Cannot access 'gameDiamonds' before initialization`
  
- ✅ **修复收款码不显示** - 充值弹窗现在正确显示收款码
  - 打开充值弹窗时自动调用 `updateRechargeQRCodes()`
  - 支付宝和微信收款码正常显示

#### 游戏平衡优化
- ✅ **降低初始难度** - 优化新手体验
  - 障碍物生成概率：0.01 → 0.003（降低70%）
  - 障碍物最大数量：5 → 3（减少40%）
  - 让新玩家更容易上手

### 📚 文档更新
- ✅ 创建《问题修复记录.md》- 详细记录修复过程

---

## v2.0 - 管理员设置中心 (2026-02-12)

### 🎉 重大更新

#### ⚙️ 统一管理员设置中心
- ✅ 创建全新的三标签页管理员面板
- ✅ 合并广告位设置、支付设置、游戏参数设置
- ✅ 优化管理员登录流程（简化为prompt输入）
- ✅ 统一的UI设计风格，提升用户体验

#### 🎮 游戏参数可配置系统
- ✅ **金币参数配置**:
  - 生成概率（每帧）：0.001-0.1
  - 最大数量：5-50个
  - 存在时间：5000-30000毫秒
  
- ✅ **钻石道具参数配置**:
  - 生成间隔：30000-300000毫秒
  - 每次生成数量：1-10个
  
- ✅ **障碍物参数配置**:
  - 生成概率：0.001-0.05
  - 最大数量：1-15个
  
- ✅ **加血包参数配置**:
  - 生成间隔：30000-300000毫秒
  
- ✅ 一键恢复默认参数功能

#### 💳 支付设置优化
- ✅ 支持上传支付宝/微信收款码图片
- ✅ 实时图片预览功能
- ✅ Base64编码存储，无需服务器
- ✅ 充值时自动显示管理员设置的收款码

#### 🎯 广告管理增强
- ✅ 图片透明度可配置（0-1）
- ✅ 广告图片保持原始比例显示
- ✅ 优化广告气球列表展示
- ✅ 整合到统一管理面板中

### 🔧 技术改进
- ✅ 删除旧的独立弹窗和按钮
- ✅ 清理未使用的CSS样式
- ✅ 优化代码结构，减少重复
- ✅ 改进localStorage数据管理

### 📚 文档更新
- ✅ 创建《管理员设置说明.md》
- ✅ 创建《管理员面板测试指南.md》
- ✅ 创建《完整功能列表.md》
- ✅ 更新《更新日志.md》

---

## v1.5 - 钻石系统 (2026-02-12)

### 💎 钻石系统
- ✅ 钻石作为游戏积分
- ✅ 充值兑换：0.1元 = 100钻石
- ✅ 金币兑换：100金币 = 1钻石
- ✅ 钻石道具：每100秒生成5个，每个+10钻石
- ✅ 点击钻石区域快速兑换金币

### 📚 文档
- ✅ 创建《钻石系统说明.md》

---

## v1.4 - 支付系统 (2026-02-11)

### 💳 多支付方式
- ✅ 支付宝支付（收款码）
- ✅ 微信支付（收款码）
- ✅ Visa支付（演示模式）
- ✅ Mastercard支付（演示模式）

### ⚙️ 管理员支付设置
- ✅ 单独的支付设置面板
- ✅ 上传支付宝/微信收款码
- ✅ 配置Visa/Mastercard收款信息

### 📚 文档
- ✅ 创建《支付功能使用指南.md》

---

## v1.3 - 生命值系统 (2026-02-10)

### ❤️ 生命值系统
- ✅ 初始生命值：100 HP
- ✅ 闪电云伤害：-10 HP
- ✅ 小鸟伤害：-5 HP
- ✅ 加血包治疗：+20 HP

### 💊 加血包系统
- ✅ 每100秒随机生成2个加血包
- ✅ 白色十字医疗包外观
- ✅ 随机位置生成

### 💀 死亡与复活
- ✅ 生命值≤0触发死亡
- ✅ 钻石复活：消耗100钻石
- ✅ 充值复活：充值0.1元

### 💰 充值系统
- ✅ 充值比例：1元 = 1000钻石
- ✅ 充值弹窗界面
- ✅ 支付方式选择

### 📚 文档
- ✅ 创建《功能说明.md》

---

## v1.2 - 超级马里奥元素 (2026-02-09)

### 🎮 游戏元素
- ✅ 金币系统：收集金币获得积分
- ✅ 障碍物：闪电云、小鸟
- ✅ 碰撞检测
- ✅ 积分榜显示

### 🪙 金币系统
- ✅ 随机位置生成
- ✅ 从右向左移动
- ✅ 12秒后自动消失
- ✅ 消失前2秒闪烁提醒
- ✅ 最多同时存在20个金币

### ⚡ 障碍物系统
- ✅ 闪电云：灰色云朵+黄色闪电
- ✅ 小鸟：蓝色飞鸟
- ✅ 随机生成，横向移动

### 📊 得分系统
- ✅ 金币得分显示
- ✅ 实时更新

---

## v1.1 - 多人同步修复 (2026-02-08)

### 🐛 问题修复
- ✅ 修复多个玩家看不到彼此的问题
- ✅ 优化Supabase实时连接
- ✅ 改进玩家位置同步频率
- ✅ 优化离线玩家清理逻辑

---

## v1.0 - 初始版本 (2026-02-05)

### 🎈 基础游戏功能
- ✅ 像素风热气球绘制
- ✅ 点击移动控制
- ✅ 呼吸浮动效果
- ✅ 飞行倾斜动画

### 🌤️ 场景设计
- ✅ 分层蓝天背景
- ✅ 动态移动云朵
- ✅ 层级管理系统

### 👥 多人在线
- ✅ Supabase Realtime集成
- ✅ 玩家位置实时同步
- ✅ 玩家名称显示
- ✅ 自动离线清理

### 🏷️ 用户系统
- ✅ 自定义玩家名称
- ✅ 欢迎弹窗
- ✅ 更改名字功能
- ✅ 本地存储

### 🎯 广告系统
- ✅ 背景广告气球
- ✅ 文字+图片广告
- ✅ 位置自定义
- ✅ 管理员面板

### 📱 响应式设计
- ✅ 桌面端适配
- ✅ 移动端适配
- ✅ 自适应缩放

### 🚀 部署
- ✅ GitHub仓库创建
- ✅ Vercel自动部署
- ✅ 公网访问

---

## 技术栈变更历史

### v2.0
- 优化CSS模块化
- 改进JavaScript事件管理
- 增强localStorage使用

### v1.0
- Phaser.js 3.x
- Supabase Realtime
- HTML5 + CSS3 + JavaScript (ES6+)
- Vercel部署

---

## 已知问题

### v2.0
- ⚠️ 支付宝/微信支付需手动核验
- ⚠️ Visa/Mastercard为演示模式

### v1.x
- ⚠️ 大量玩家可能影响性能（建议<50人）
- ⚠️ 不支持IE浏览器

---

## 计划中的功能

### 下一版本 (v2.1)
- [ ] 排行榜系统
- [ ] 成就系统
- [ ] 皮肤商店
- [ ] 好友系统

### 未来计划
- [ ] 服务端验证
- [ ] 反作弊系统
- [ ] 关卡系统
- [ ] 道具系统

---

**维护者**: DDKJ Team  
**最后更新**: 2026年2月12日
