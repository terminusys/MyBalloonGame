<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¢¦å¹»çƒ­æ°”çƒé£è¡Œ</title>
    <!-- å¼•å…¥ç°ä»£å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(180deg, #1e3c72 0%, #2a5298 40%, #7fa3d1 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow: hidden;  /* é˜²æ­¢æ»šåŠ¨ */
        }
        #game-container {
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            overflow: hidden;
            max-width: 100%;   /* å“åº”å¼ï¼šä¸è¶…è¿‡å±å¹•å®½åº¦ */
            max-height: 100vh; /* å“åº”å¼ï¼šä¸è¶…è¿‡å±å¹•é«˜åº¦ */
        }
        #game-container canvas {
            display: block;
            max-width: 100%;
            max-height: 100vh;
        }
        
        /* åå­—è¾“å…¥å¼¹çª—æ ·å¼ */
        #name-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        #name-modal.hidden {
            display: none;
        }
        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 400px;
            width: 90%;
            animation: modalFadeIn 0.3s ease-out;
        }
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 6px 25px rgba(102, 126, 234, 0.8);
            }
        }
        .modal-content h2 {
            color: #fff;
            margin: 0 0 10px 0;
            font-size: 28px;
            font-weight: 700;
        }
        .modal-content p {
            color: rgba(255, 255, 255, 0.9);
            margin: 0 0 25px 0;
            font-size: 16px;
        }
        #player-name-input {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            text-align: center;
            box-sizing: border-box;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            font-weight: 600;
            outline: none;
            transition: all 0.3s;
        }
        #player-name-input:focus {
            background: #fff;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
        }
        #player-name-input::placeholder {
            color: #999;
            font-weight: 400;
        }
        #start-game-btn {
            margin-top: 20px;
            padding: 15px 40px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }
        #start-game-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(245, 87, 108, 0.4);
        }
        #start-game-btn:active {
            transform: translateY(0);
        }
        .emoji-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            #user-settings-btn, #admin-settings-btn {
                font-size: 12px;
                padding: 8px 15px;
                top: 10px;
                left: 10px;
            }
            #admin-btn {
                font-size: 12px;
                padding: 8px 15px;
                top: 50px;
                left: 10px;
            }
        }
        
        /* å¹¿å‘Šä½è®¾ç½®æŒ‰é’®æ ·å¼ */
        #admin-btn {
            position: fixed;
            top: 55px;
            left: 15px;
            padding: 10px 18px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);
            transition: all 0.3s;
            z-index: 999;
        }
        #admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(240, 147, 251, 0.6);
        }
        #admin-btn:active {
            transform: translateY(0);
        }
        
        /* ç®¡ç†å‘˜ç™»å½•å¼¹çª— */
        .panel-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .panel-content h2 {
            color: #fff;
            margin: 0 0 20px 0;
            font-size: 24px;
            text-align: center;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            color: #fff;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .btn-primary,
        .btn-secondary,
        .btn-danger {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }
        .btn-primary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-primary:hover,
        .btn-secondary:hover,
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .ad-balloon-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .ad-balloon-item h4 {
            color: #fff;
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 8px;
            display: none;
        }
        .image-preview.show {
            display: block;
        }
        
        /* æ­»äº¡å¼¹çª—æ ·å¼ */
        #death-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            backdrop-filter: blur(10px);
        }
        #death-modal.show {
            display: flex;
        }
        .death-content {
            background: linear-gradient(135deg, #434343 0%, #000000 100%);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(255, 0, 0, 0.5);
            text-align: center;
            max-width: 450px;
            width: 90%;
            border: 3px solid #FF0000;
        }
        .death-content h2 {
            color: #FF0000;
            margin: 0 0 10px 0;
            font-size: 32px;
            font-weight: 700;
            text-shadow: 0 0 10px #FF0000;
        }
        .death-content p {
            color: #fff;
            margin: 10px 0 30px 0;
            font-size: 18px;
        }
        .revive-option {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .revive-option h4 {
            color: #FFD700;
            margin: 0 0 10px 0;
            font-size: 18px;
        }
        .revive-btn {
            width: 100%;
            padding: 15px;
            margin-top: 10px;
            background: linear-gradient(135deg, #00FF00 0%, #00AA00 100%);
            color: #000;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        .revive-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 255, 0, 0.4);
        }
        .revive-btn:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        /* å……å€¼æŒ‰é’®æ ·å¼ */
        #recharge-btn {
            position: fixed;
            top: 130px;
            right: 15px;
            padding: 10px 18px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            transition: all 0.3s;
            z-index: 999;
        }
        #recharge-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
        }
        
        /* å……å€¼å¼¹çª— */
        #recharge-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2500;
            backdrop-filter: blur(5px);
        }
        #recharge-modal.show {
            display: flex;
        }
        
        /* æ”¯ä»˜æ–¹å¼æŒ‰é’® */
        .payment-methods {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
        }
        .payment-btn {
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 600;
        }
        .payment-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }
        .payment-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
        }
        .payment-content {
            display: none;
            margin-top: 20px;
        }
        .payment-content.active {
            display: block;
        }
        .qrcode-container {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            margin: 15px 0;
        }
        .qrcode-container img {
            max-width: 250px;
            max-height: 250px;
            border: 3px solid #667eea;
            border-radius: 10px;
        }
        .qrcode-placeholder {
            width: 250px;
            height: 250px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            border-radius: 10px;
            color: #999;
        }
        .card-input-group {
            margin: 15px 0;
        }
        .card-input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
            box-sizing: border-box;
            margin-top: 8px;
        }
        .card-input-group input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        .card-input-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
        }
        .warning-box {
            background: rgba(255, 152, 0, 0.2);
            border: 2px solid #FF9800;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            color: #FFE0B2;
        }
        .warning-box strong {
            color: #FFA726;
        }
        
        /* ç»Ÿä¸€ç®¡ç†å‘˜è®¾ç½®å¼¹çª— */
        #admin-settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2500;
            backdrop-filter: blur(8px);
            overflow-y: auto;
            padding: 20px 0;
        }
        #admin-settings-modal.show {
            display: flex;
        }
        
        /* æ ‡ç­¾é¡µå¯¼èˆª */
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 10px;
        }
        .admin-tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px 8px 0 0;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .admin-tab:hover {
            background: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.9);
        }
        .admin-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }
        
        /* æ ‡ç­¾é¡µå†…å®¹ */
        .admin-tab-content {
            display: none;
        }
        .admin-tab-content.active {
            display: block;
        }
        
        /* è®¾ç½®åˆ†ç»„ */
        .settings-group {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .settings-group h3 {
            color: #FFD700;
            margin: 0 0 15px 0;
            font-size: 18px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            padding-bottom: 10px;
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }
        .setting-item label {
            color: #fff;
            font-size: 14px;
            flex: 1;
        }
        .setting-item input[type="number"],
        .setting-item input[type="text"] {
            width: 120px;
            padding: 8px 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
            text-align: center;
        }
        .setting-item input:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.15);
        }
        .setting-hint {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            margin-top: 5px;
        }
        
        @media (max-width: 768px) {
            #recharge-btn {
                font-size: 12px;
                padding: 8px 15px;
                top: 110px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- ç”¨æˆ·è®¾ç½®æŒ‰é’® -->
    <button id="user-settings-btn" style="position: fixed; top: 15px; left: 15px; padding: 8px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: 2px solid rgba(255, 255, 255, 0.5); border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); transition: all 0.3s; z-index: 999; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">âš™ï¸ ç”¨æˆ·è®¾ç½®</button>
    
    <!-- é€€å‡ºç™»å½•æŒ‰é’® -->
    <button id="logout-btn" style="position: fixed; top: 15px; right: 15px; padding: 8px 15px; background: rgba(255, 255, 255, 0.2); color: white; border: 2px solid rgba(255, 255, 255, 0.5); border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); transition: all 0.3s; z-index: 999;">ğŸšª é€€å‡ºç™»å½•</button>
    
    <!-- ç»Ÿä¸€ç®¡ç†å‘˜è®¾ç½®æŒ‰é’®ï¼ˆåªå¯¹è¶…çº§ç®¡ç†å‘˜æ˜¾ç¤ºï¼‰-->
    <button id="admin-settings-btn" style="position: fixed; top: 55px; left: 15px; padding: 10px 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s; z-index: 999; display: none;">âš™ï¸ ç®¡ç†å‘˜è®¾ç½®</button>
    
    <!-- å……å€¼æŒ‰é’® -->
    <button id="recharge-btn">ğŸ’° å……å€¼</button>
    
    <!-- ç”¨æˆ·è®¾ç½®å¼¹çª— -->
    <div id="user-settings-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 2000; backdrop-filter: blur(10px);">
        <div class="panel-content" style="max-width: 500px; margin: 50px auto; max-height: 90vh; overflow-y: auto;">
            <h2 style="text-align: center; color: #fff; margin-bottom: 20px;">ğŸ‘¤ ç”¨æˆ·è®¾ç½®</h2>
            
            <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h3 style="color: #fff; margin-bottom: 15px;">ğŸ“ åŸºæœ¬ä¿¡æ¯</h3>
                
                <div class="form-group">
                    <label style="color: #fff; display: block; margin-bottom: 5px;">ç”¨æˆ·åï¼ˆä¸å¯ä¿®æ”¹ï¼‰</label>
                    <input type="text" id="user-setting-username" readonly style="background: rgba(255, 255, 255, 0.1); cursor: not-allowed;">
                </div>
                
                <div class="form-group">
                    <label style="color: #fff; display: block; margin-bottom: 5px;">ä¿®æ”¹å¯†ç </label>
                    <input type="password" id="user-setting-password" placeholder="è¾“å…¥æ–°å¯†ç ï¼ˆç•™ç©ºåˆ™ä¸ä¿®æ”¹ï¼‰">
                </div>
                
                <div class="form-group">
                    <label style="color: #fff; display: block; margin-bottom: 5px;">ç¡®è®¤æ–°å¯†ç </label>
                    <input type="password" id="user-setting-password-confirm" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                </div>
            </div>
            
            <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h3 style="color: #fff; margin-bottom: 15px;">ğŸŒ ä¸ªäººèµ„æ–™</h3>
                
                <div class="form-group">
                    <label style="color: #fff; display: block; margin-bottom: 5px;">å›½å®¶</label>
                    <select id="user-setting-country" style="width: 100%; padding: 12px; border-radius: 10px; border: none; font-size: 16px;">
                        <option value="">é€‰æ‹©å›½å®¶</option>
                        <option value="ä¸­å›½">ä¸­å›½</option>
                        <option value="ç¾å›½">ç¾å›½</option>
                        <option value="æ—¥æœ¬">æ—¥æœ¬</option>
                        <option value="éŸ©å›½">éŸ©å›½</option>
                        <option value="è‹±å›½">è‹±å›½</option>
                        <option value="æ³•å›½">æ³•å›½</option>
                        <option value="å¾·å›½">å¾·å›½</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label style="color: #fff; display: block; margin-bottom: 5px;">åœ°åŒº/åŸå¸‚</label>
                    <input type="text" id="user-setting-region" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬">
                </div>
                
                <div class="form-group">
                    <label style="color: #fff; display: block; margin-bottom: 5px;">æ€§åˆ«</label>
                    <select id="user-setting-gender" style="width: 100%; padding: 12px; border-radius: 10px; border: none; font-size: 16px;">
                        <option value="">é€‰æ‹©æ€§åˆ«</option>
                        <option value="ç”·">ç”·</option>
                        <option value="å¥³">å¥³</option>
                        <option value="ä¿å¯†">ä¿å¯†</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label style="color: #fff; display: block; margin-bottom: 5px;">å¹´é¾„</label>
                    <input type="number" id="user-setting-age" placeholder="ä¾‹å¦‚ï¼š25" min="1" max="150">
                </div>
                
                <div class="form-group">
                    <label style="color: #fff; display: block; margin-bottom: 5px;">æ‰‹æœºå·</label>
                    <input type="tel" id="user-setting-phone" placeholder="ä¾‹å¦‚ï¼š13800138000">
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn-primary" id="save-user-settings-btn">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
                <button class="btn-secondary" id="close-user-settings-btn">âŒ å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <!-- ç»Ÿä¸€ç®¡ç†å‘˜è®¾ç½®é¢æ¿ -->
    <div id="admin-settings-modal">
        <div class="panel-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <h2 style="text-align: center; color: #fff; margin-bottom: 20px;">âš™ï¸ ç®¡ç†å‘˜è®¾ç½®ä¸­å¿ƒ</h2>
            
            <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
            <div class="admin-tabs">
                <button class="admin-tab active" data-tab="game-params">ğŸ® æ¸¸æˆå‚æ•°</button>
                <button class="admin-tab" data-tab="payment">ğŸ’³ æ”¯ä»˜è®¾ç½®</button>
                <button class="admin-tab" data-tab="ads">ğŸ¯ å¹¿å‘Šç®¡ç†</button>
            </div>
            
            <!-- æ¸¸æˆå‚æ•°æ ‡ç­¾é¡µ -->
            <div class="admin-tab-content active" id="game-params-content">
                <!-- é‡‘å¸è®¾ç½® -->
                <div class="settings-group">
                    <h3>ğŸª™ é‡‘å¸å‚æ•°</h3>
                    <div class="setting-item">
                        <label>ç”Ÿæˆæ¦‚ç‡ï¼ˆæ¯å¸§ï¼‰</label>
                        <input type="number" id="coin-spawn-rate" step="0.001" min="0.001" max="0.1" value="0.02">
                    </div>
                    <div class="setting-hint">å»ºè®®å€¼ï¼š0.01-0.03ï¼Œæ•°å€¼è¶Šå¤§ç”Ÿæˆè¶Šå¿«</div>
                    
                    <div class="setting-item">
                        <label>æœ€å¤§æ•°é‡</label>
                        <input type="number" id="coin-max-count" min="5" max="50" value="20">
                    </div>
                    <div class="setting-hint">å±å¹•ä¸ŠåŒæ—¶å­˜åœ¨çš„é‡‘å¸æ•°é‡ä¸Šé™</div>
                    
                    <div class="setting-item">
                        <label>å­˜åœ¨æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</label>
                        <input type="number" id="coin-lifetime" min="5000" max="30000" step="1000" value="12000">
                    </div>
                    <div class="setting-hint">é‡‘å¸è‡ªåŠ¨æ¶ˆå¤±çš„æ—¶é—´ï¼ˆæ¨è10000-15000ï¼‰</div>
                </div>
                
                <!-- é’»çŸ³è®¾ç½® -->
                <div class="settings-group">
                    <h3>ğŸ’ é’»çŸ³é“å…·å‚æ•°</h3>
                    <div class="setting-item">
                        <label>ç”Ÿæˆé—´éš”ï¼ˆæ¯«ç§’ï¼‰</label>
                        <input type="number" id="diamond-spawn-interval" min="30000" max="300000" step="10000" value="100000">
                    </div>
                    <div class="setting-hint">æ¯æ¬¡ç”Ÿæˆé’»çŸ³çš„æ—¶é—´é—´éš”ï¼ˆæ¨è60000-120000ï¼‰</div>
                    
                    <div class="setting-item">
                        <label>æ¯æ¬¡ç”Ÿæˆæ•°é‡</label>
                        <input type="number" id="diamond-spawn-count" min="1" max="10" value="5">
                    </div>
                    <div class="setting-hint">æ¯æ¬¡ç”Ÿæˆçš„é’»çŸ³é“å…·æ•°é‡</div>
                    
                    <div class="setting-item">
                        <label>æœ€å¤§æ•°é‡</label>
                        <input type="number" id="diamond-max-count" min="1" max="20" value="5">
                    </div>
                    <div class="setting-hint">å±å¹•ä¸ŠåŒæ—¶å­˜åœ¨çš„é’»çŸ³é“å…·æ•°é‡ä¸Šé™</div>
                </div>
                
                <!-- éšœç¢ç‰©è®¾ç½® -->
                <div class="settings-group">
                    <h3>âš¡ éšœç¢ç‰©å‚æ•°</h3>
                    <div class="setting-item">
                        <label>ç”Ÿæˆæ¦‚ç‡ï¼ˆæ¯å¸§ï¼‰</label>
                        <input type="number" id="obstacle-spawn-rate" step="0.001" min="0.001" max="0.05" value="0.01">
                    </div>
                    <div class="setting-hint">å»ºè®®å€¼ï¼š0.005-0.015</div>
                    
                    <div class="setting-item">
                        <label>æœ€å¤§æ•°é‡</label>
                        <input type="number" id="obstacle-max-count" min="1" max="15" value="5">
                    </div>
                </div>
                
                <!-- åŠ è¡€åŒ…è®¾ç½® -->
                <div class="settings-group">
                    <h3>ğŸ’Š åŠ è¡€åŒ…å‚æ•°</h3>
                    <div class="setting-item">
                        <label>ç”Ÿæˆé—´éš”ï¼ˆæ¯«ç§’ï¼‰</label>
                        <input type="number" id="healthpack-interval" min="30000" max="300000" step="10000" value="100000">
                    </div>
                    <div class="setting-hint">æ¯æ¬¡ç”ŸæˆåŠ è¡€åŒ…çš„æ—¶é—´é—´éš”ï¼ˆæ¨è60000-120000ï¼‰</div>
                    
                    <div class="setting-item">
                        <label>æ¯æ¬¡ç”Ÿæˆæ•°é‡</label>
                        <input type="number" id="healthpack-count" min="1" max="10" value="2">
                    </div>
                    <div class="setting-hint">æ¯æ¬¡ç”Ÿæˆçš„åŠ è¡€åŒ…æ•°é‡ï¼ˆé»˜è®¤2ä¸ªï¼‰</div>
                    
                    <div class="setting-item">
                        <label>åœç•™æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</label>
                        <input type="number" id="healthpack-lifetime" min="3000" max="30000" step="1000" value="8000">
                    </div>
                    <div class="setting-hint">åŠ è¡€åŒ…åœ¨ç•Œé¢ä¸Šåœç•™çš„æ—¶é—´ï¼ˆé»˜è®¤8ç§’ï¼‰</div>
                </div>
                
                <div class="btn-group">
                    <button class="btn-secondary" id="reset-game-params-btn">æ¢å¤é»˜è®¤</button>
                    <button class="btn-primary" id="save-game-params-btn">ä¿å­˜å‚æ•°</button>
                </div>
            </div>
            
            <!-- æ”¯ä»˜è®¾ç½®æ ‡ç­¾é¡µ -->
            <div class="admin-tab-content" id="payment-content">
                <!-- æ”¯ä»˜å®è®¾ç½® -->
                <div class="ad-balloon-item">
                    <h4>ğŸ“± æ”¯ä»˜å®æ”¶æ¬¾è®¾ç½®</h4>
                    <div class="form-group">
                        <label>ä¸Šä¼ æ”¶æ¬¾ç å›¾ç‰‡ï¼š</label>
                        <input type="file" id="alipay-qrcode-upload" accept="image/*" />
                        <img id="alipay-qrcode-preview" class="image-preview" alt="æ”¯ä»˜å®æ”¶æ¬¾ç " />
                    </div>
                </div>
                
                <!-- å¾®ä¿¡è®¾ç½® -->
                <div class="ad-balloon-item">
                    <h4>ğŸ’š å¾®ä¿¡æ”¶æ¬¾è®¾ç½®</h4>
                    <div class="form-group">
                        <label>ä¸Šä¼ æ”¶æ¬¾ç å›¾ç‰‡ï¼š</label>
                        <input type="file" id="wechat-qrcode-upload" accept="image/*" />
                        <img id="wechat-qrcode-preview" class="image-preview" alt="å¾®ä¿¡æ”¶æ¬¾ç " />
                    </div>
                </div>
                
                <!-- Visaè®¾ç½® -->
                <div class="ad-balloon-item">
                    <h4>ğŸ’³ Visaæ”¶æ¬¾è´¦æˆ·ï¼ˆæ¼”ç¤ºï¼‰</h4>
                    <div class="form-group">
                        <label>æ”¶æ¬¾è´¦æˆ·åï¼š</label>
                        <input type="text" id="visa-account-name" placeholder="ä¾‹å¦‚ï¼šZHANG SAN" />
                    </div>
                    <div class="form-group">
                        <label>æ”¶æ¬¾å¡å·ï¼ˆå4ä½ï¼‰ï¼š</label>
                        <input type="text" id="visa-card-number" placeholder="**** **** **** 1234" />
                    </div>
                    <div class="warning-box">
                        <strong>âš ï¸ å®‰å…¨æç¤ºï¼š</strong> çœŸå®Visaæ”¯ä»˜éœ€æ¥å…¥Stripeç­‰æ”¯ä»˜ç½‘å…³ï¼
                    </div>
                </div>
                
                <!-- Mastercardè®¾ç½® -->
                <div class="ad-balloon-item">
                    <h4>ğŸ’³ Mastercardæ”¶æ¬¾è´¦æˆ·ï¼ˆæ¼”ç¤ºï¼‰</h4>
                    <div class="form-group">
                        <label>æ”¶æ¬¾è´¦æˆ·åï¼š</label>
                        <input type="text" id="mastercard-account-name" placeholder="ä¾‹å¦‚ï¼šLI SI" />
                    </div>
                    <div class="form-group">
                        <label>æ”¶æ¬¾å¡å·ï¼ˆå4ä½ï¼‰ï¼š</label>
                        <input type="text" id="mastercard-card-number" placeholder="**** **** **** 5678" />
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn-primary" id="save-payment-settings-btn">ä¿å­˜æ”¯ä»˜è®¾ç½®</button>
                </div>
            </div>
            
            <!-- å¹¿å‘Šç®¡ç†æ ‡ç­¾é¡µ -->
            <div class="admin-tab-content" id="ads-content">
                <!-- æ·»åŠ æ–°å¹¿å‘Šæ°”çƒ -->
                <div class="ad-balloon-item">
                    <h4>â• æ·»åŠ æ–°å¹¿å‘Šæ°”çƒ</h4>
                    <div class="form-group">
                        <label>å¹¿å‘Šè¯ï¼š</label>
                        <textarea id="new-ad-text" placeholder="è¯·è¾“å…¥å¹¿å‘Šè¯..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>å¹¿å‘Šå›¾ç‰‡ï¼š</label>
                        <input type="file" id="new-ad-image" accept="image/*" />
                        <img id="new-ad-image-preview" class="image-preview" alt="é¢„è§ˆ" />
                    </div>
                    <div class="form-group">
                        <label>ä½ç½® Xï¼ˆ0-800ï¼‰ï¼š</label>
                        <input type="number" id="new-ad-x" value="200" min="50" max="750" />
                    </div>
                    <div class="form-group">
                        <label>ä½ç½® Yï¼ˆ0-600ï¼‰ï¼š</label>
                        <input type="number" id="new-ad-y" value="200" min="50" max="550" />
                    </div>
                    <div class="form-group">
                        <label>å›¾ç‰‡é€æ˜åº¦ï¼ˆ0-1ï¼‰ï¼š</label>
                        <input type="number" id="new-ad-opacity" value="0.9" min="0" max="1" step="0.1" />
                    </div>
                    <button class="btn-primary" id="add-ad-balloon-btn" style="width: 100%;">æ·»åŠ å¹¿å‘Šæ°”çƒ</button>
                </div>
                
                <!-- ç°æœ‰å¹¿å‘Šæ°”çƒåˆ—è¡¨ -->
                <div id="ad-balloons-list">
                    <h4 style="color: #fff; margin-bottom: 15px;">ğŸ“‹ ç°æœ‰å¹¿å‘Šæ°”çƒ</h4>
                    <div id="ad-balloons-container"></div>
                </div>
            </div>
            
            <!-- åº•éƒ¨æŒ‰é’® -->
            <div class="btn-group" style="margin-top: 30px;">
                <button class="btn-secondary" id="close-admin-settings-btn">å…³é—­è®¾ç½®</button>
            </div>
        </div>
    </div>

    <!-- æ­»äº¡å¼¹çª— -->
    <div id="death-modal">
        <div class="death-content">
            <div class="emoji-icon">ğŸ’€</div>
            <h2>æ¸¸æˆç»“æŸ</h2>
            <p>ä½ çš„ç”Ÿå‘½å€¼å·²è€—å°½ï¼</p>
            <p style="font-size: 16px; color: #FFD700;">é€‰æ‹©å¤æ´»æ–¹å¼ï¼š</p>
            
            <div class="revive-option">
                <h4 id="revive-credits-option">æ¶ˆè€—100é’»çŸ³å¤æ´»</h4>
                <button class="revive-btn" id="revive-credits-btn">ä½¿ç”¨é’»çŸ³å¤æ´»</button>
            </div>
            
            <div class="revive-option">
                <h4>å……å€¼0.1å…ƒå¤æ´»</h4>
                <p style="color: #aaa; font-size: 14px; margin: 5px 0;">å……å€¼1å…ƒ = 1000ğŸ’é’»çŸ³ | 100ğŸª™é‡‘å¸ = 1ğŸ’é’»çŸ³</p>
                <button class="revive-btn" id="revive-pay-btn">å……å€¼å¤æ´»</button>
            </div>
        </div>
    </div>
    
    <!-- å……å€¼å¼¹çª— -->
    <div id="recharge-modal">
        <div class="panel-content" style="max-width: 600px;">
            <div class="emoji-icon">ğŸ’</div>
            <h2>å……å€¼ä¸­å¿ƒ</h2>
            <p>ğŸ’° 1å…ƒ = 1000ğŸ’é’»çŸ³ | ğŸª™ 100é‡‘å¸ = 1ğŸ’é’»çŸ³</p>
            
            <div class="form-group">
                <label>å……å€¼é‡‘é¢ï¼ˆå…ƒï¼‰ï¼š</label>
                <input type="number" id="recharge-amount" value="1" min="0.1" step="0.1" />
            </div>
            
            <div class="form-group">
                <p style="color: #00FFFF; font-size: 20px; margin: 10px 0; font-weight: bold;">
                    å°†è·å¾—ï¼š<span id="recharge-credits-preview">1000</span> ğŸ’é’»çŸ³
                </p>
            </div>
            
            <!-- æ”¯ä»˜æ–¹å¼é€‰æ‹© -->
            <div class="form-group">
                <label>é€‰æ‹©æ”¯ä»˜æ–¹å¼ï¼š</label>
                <div class="payment-methods">
                    <button class="payment-btn active" data-method="alipay">
                        ğŸ“± æ”¯ä»˜å®
                    </button>
                    <button class="payment-btn" data-method="wechat">
                        ğŸ’š å¾®ä¿¡æ”¯ä»˜
                    </button>
                    <button class="payment-btn" data-method="visa">
                        ğŸ’³ Visa
                    </button>
                    <button class="payment-btn" data-method="mastercard">
                        ğŸ’³ Mastercard
                    </button>
                </div>
            </div>
            
            <!-- æ”¯ä»˜å®æ”¯ä»˜å†…å®¹ -->
            <div class="payment-content active" id="alipay-payment">
                <h4 style="color: #1677FF; margin-bottom: 10px;">æ”¯ä»˜å®æ‰«ç æ”¯ä»˜</h4>
                <div class="qrcode-container" id="alipay-qrcode-display">
                    <div class="qrcode-placeholder">è¯·ç®¡ç†å‘˜å…ˆè®¾ç½®æ”¶æ¬¾ç </div>
                </div>
                <div class="warning-box">
                    <strong>âš ï¸ æ”¯ä»˜æµç¨‹ï¼š</strong><br>
                    1. æ‰«ç æ”¯ä»˜å¯¹åº”é‡‘é¢<br>
                    2. æ”¯ä»˜æˆåŠŸåç‚¹å‡»ä¸‹æ–¹"å·²å®Œæˆæ”¯ä»˜"<br>
                    3. ç­‰å¾…ç®¡ç†å‘˜ç¡®è®¤å……å€¼
                </div>
                <button class="btn-primary" style="width: 100%;" id="alipay-confirm-btn">âœ… å·²å®Œæˆæ”¯ä»˜</button>
            </div>
            
            <!-- å¾®ä¿¡æ”¯ä»˜å†…å®¹ -->
            <div class="payment-content" id="wechat-payment">
                <h4 style="color: #07C160; margin-bottom: 10px;">å¾®ä¿¡æ‰«ç æ”¯ä»˜</h4>
                <div class="qrcode-container" id="wechat-qrcode-display">
                    <div class="qrcode-placeholder">è¯·ç®¡ç†å‘˜å…ˆè®¾ç½®æ”¶æ¬¾ç </div>
                </div>
                <div class="warning-box">
                    <strong>âš ï¸ æ”¯ä»˜æµç¨‹ï¼š</strong><br>
                    1. æ‰«ç æ”¯ä»˜å¯¹åº”é‡‘é¢<br>
                    2. æ”¯ä»˜æˆåŠŸåç‚¹å‡»ä¸‹æ–¹"å·²å®Œæˆæ”¯ä»˜"<br>
                    3. ç­‰å¾…ç®¡ç†å‘˜ç¡®è®¤å……å€¼
                </div>
                <button class="btn-primary" style="width: 100%;" id="wechat-confirm-btn">âœ… å·²å®Œæˆæ”¯ä»˜</button>
            </div>
            
            <!-- Visaæ”¯ä»˜å†…å®¹ -->
            <div class="payment-content" id="visa-payment">
                <h4 style="color: #1A1F71; margin-bottom: 10px;">Visaå¡æ”¯ä»˜</h4>
                <div class="warning-box">
                    <strong>âš ï¸ æ¼”ç¤ºæ¨¡å¼ï¼š</strong> çœŸå®Visaæ”¯ä»˜éœ€è¦æ¥å…¥Stripeç­‰æ”¯ä»˜ç½‘å…³ï¼Œéœ€è¦åç«¯æœåŠ¡å™¨æ”¯æŒã€‚å½“å‰ä¸ºç•Œé¢æ¼”ç¤ºã€‚
                </div>
                <div class="card-input-group">
                    <label>å¡å·</label>
                    <input type="text" placeholder="1234 5678 9012 3456" maxlength="19" id="visa-card-input" />
                </div>
                <div class="card-input-row">
                    <div class="card-input-group">
                        <label>æœ‰æ•ˆæœŸ</label>
                        <input type="text" placeholder="MM/YY" maxlength="5" />
                    </div>
                    <div class="card-input-group">
                        <label>CVV</label>
                        <input type="text" placeholder="123" maxlength="3" />
                    </div>
                </div>
                <div class="card-input-group">
                    <label>æŒå¡äººå§“å</label>
                    <input type="text" placeholder="ZHANG SAN" />
                </div>
                <button class="btn-primary" style="width: 100%;" id="visa-pay-btn">ğŸ’³ æ”¯ä»˜ï¼ˆæ¼”ç¤ºï¼‰</button>
            </div>
            
            <!-- Mastercardæ”¯ä»˜å†…å®¹ -->
            <div class="payment-content" id="mastercard-payment">
                <h4 style="color: #EB001B; margin-bottom: 10px;">Mastercardæ”¯ä»˜</h4>
                <div class="warning-box">
                    <strong>âš ï¸ æ¼”ç¤ºæ¨¡å¼ï¼š</strong> çœŸå®Mastercardæ”¯ä»˜éœ€è¦æ¥å…¥Stripeç­‰æ”¯ä»˜ç½‘å…³ï¼Œéœ€è¦åç«¯æœåŠ¡å™¨æ”¯æŒã€‚å½“å‰ä¸ºç•Œé¢æ¼”ç¤ºã€‚
                </div>
                <div class="card-input-group">
                    <label>å¡å·</label>
                    <input type="text" placeholder="5678 1234 5678 9012" maxlength="19" id="mastercard-card-input" />
                </div>
                <div class="card-input-row">
                    <div class="card-input-group">
                        <label>æœ‰æ•ˆæœŸ</label>
                        <input type="text" placeholder="MM/YY" maxlength="5" />
                    </div>
                    <div class="card-input-group">
                        <label>CVV</label>
                        <input type="text" placeholder="123" maxlength="3" />
                    </div>
                </div>
                <div class="card-input-group">
                    <label>æŒå¡äººå§“å</label>
                    <input type="text" placeholder="LI SI" />
                </div>
                <button class="btn-primary" style="width: 100%;" id="mastercard-pay-btn">ğŸ’³ æ”¯ä»˜ï¼ˆæ¼”ç¤ºï¼‰</button>
            </div>
            
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn-secondary" id="cancel-recharge-btn">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <!-- åå­—è¾“å…¥å¼¹çª— -->
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="name-modal">
        <div class="modal-content">
            <div class="emoji-icon">ğŸˆ</div>
            <h2>æ¬¢è¿æ¥åˆ°çƒ­æ°”çƒä¸–ç•Œ</h2>
            <p>è¯·ç™»å½•å¼€å§‹æ¸¸æˆ</p>
            
            <input 
                type="text" 
                id="login-username" 
                placeholder="ç”¨æˆ·å" 
                maxlength="20"
                autocomplete="username"
            />
            <input 
                type="password" 
                id="login-password" 
                placeholder="å¯†ç " 
                maxlength="50"
                autocomplete="current-password"
            />
            <button id="login-btn">ğŸš€ ç™»å½•</button>
            <button id="show-register-btn" style="background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); margin-top: 10px;">ğŸ“ æ³¨å†Œæ–°è´¦å·</button>
        </div>
    </div>

    <!-- æ³¨å†Œç•Œé¢ -->
    <div id="register-modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px; max-height: 90vh;">
            <div class="emoji-icon">ğŸ“</div>
            <h2>ç”¨æˆ·æ³¨å†Œ</h2>
            <p style="margin-bottom: 20px;">è¯·å¡«å†™æ‚¨çš„ä¿¡æ¯</p>
            
            <div style="max-height: 60vh; overflow-y: auto; padding: 5px 10px;">
                <!-- å¿…å¡«é¡¹ -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: #fff; font-size: 14px; margin-bottom: 5px; font-weight: 600;">âœï¸ ç”¨æˆ·åï¼ˆå¿…å¡«ï¼‰</label>
                    <input 
                        type="text" 
                        id="register-username" 
                        placeholder="è¯·è¾“å…¥ç”¨æˆ·å" 
                        maxlength="20"
                        required
                        style="width: 100%; padding: 12px; border-radius: 10px; border: none; font-size: 16px; box-sizing: border-box;"
                    />
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: #fff; font-size: 14px; margin-bottom: 5px; font-weight: 600;">ğŸ”’ å¯†ç ï¼ˆå¿…å¡«ï¼‰</label>
                    <input 
                        type="password" 
                        id="register-password" 
                        placeholder="è‡³å°‘6ä¸ªå­—ç¬¦" 
                        maxlength="50"
                        required
                        style="width: 100%; padding: 12px; border-radius: 10px; border: none; font-size: 16px; box-sizing: border-box;"
                    />
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: #fff; font-size: 14px; margin-bottom: 5px; font-weight: 600;">ğŸ”’ ç¡®è®¤å¯†ç ï¼ˆå¿…å¡«ï¼‰</label>
                    <input 
                        type="password" 
                        id="register-password-confirm" 
                        placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " 
                        maxlength="50"
                        required
                        style="width: 100%; padding: 12px; border-radius: 10px; border: none; font-size: 16px; box-sizing: border-box;"
                    />
                </div>
                
                <div style="border-top: 1px solid rgba(255,255,255,0.2); margin: 20px 0; padding-top: 15px;">
                    <p style="color: #fff; font-size: 13px; opacity: 0.8; margin-bottom: 15px;">ä»¥ä¸‹ä¿¡æ¯ä¸ºå¯é€‰å¡«å†™ï¼š</p>
                </div>
                
                <!-- å¯é€‰é¡¹ -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #fff; font-size: 14px; margin-bottom: 5px;">ğŸŒ å›½å®¶</label>
                    <select id="register-country" style="width: 100%; padding: 12px; border-radius: 10px; border: none; font-size: 16px; box-sizing: border-box; background: white;">
                        <option value="">é€‰æ‹©å›½å®¶ï¼ˆå¯é€‰ï¼‰</option>
                        <option value="ä¸­å›½">ä¸­å›½</option>
                        <option value="ç¾å›½">ç¾å›½</option>
                        <option value="æ—¥æœ¬">æ—¥æœ¬</option>
                        <option value="éŸ©å›½">éŸ©å›½</option>
                        <option value="è‹±å›½">è‹±å›½</option>
                        <option value="æ³•å›½">æ³•å›½</option>
                        <option value="å¾·å›½">å¾·å›½</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #fff; font-size: 14px; margin-bottom: 5px;">ğŸ“ åœ°åŒº/åŸå¸‚</label>
                    <input 
                        type="text" 
                        id="register-region" 
                        placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·" 
                        maxlength="50"
                        style="width: 100%; padding: 12px; border-radius: 10px; border: none; font-size: 16px; box-sizing: border-box;"
                    />
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #fff; font-size: 14px; margin-bottom: 5px;">ğŸ‘¤ æ€§åˆ«</label>
                    <select id="register-gender" style="width: 100%; padding: 12px; border-radius: 10px; border: none; font-size: 16px; box-sizing: border-box; background: white;">
                        <option value="">é€‰æ‹©æ€§åˆ«ï¼ˆå¯é€‰ï¼‰</option>
                        <option value="ç”·">ç”·</option>
                        <option value="å¥³">å¥³</option>
                        <option value="ä¿å¯†">ä¿å¯†</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <label style="display: block; color: #fff; font-size: 14px; margin-bottom: 5px;">ğŸ‚ å¹´é¾„</label>
                        <input 
                            type="number" 
                            id="register-age" 
                            placeholder="å¹´é¾„" 
                            min="1"
                            max="150"
                            style="width: 100%; padding: 12px; border-radius: 10px; border: none; font-size: 16px; box-sizing: border-box;"
                        />
                    </div>
                    <div style="flex: 2;">
                        <label style="display: block; color: #fff; font-size: 14px; margin-bottom: 5px;">ğŸ“± æ‰‹æœºå·</label>
                        <input 
                            type="tel" 
                            id="register-phone" 
                            placeholder="æ‰‹æœºå·ç " 
                            maxlength="20"
                            style="width: 100%; padding: 12px; border-radius: 10px; border: none; font-size: 16px; box-sizing: border-box;"
                        />
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="register-submit-btn" style="flex: 2; padding: 14px; background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s;">âœ… æäº¤æ³¨å†Œ</button>
                <button id="back-to-login-btn" style="flex: 1; padding: 14px; background: #6c757d; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s;">â† è¿”å›</button>
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆå®¹å™¨ -->
    <div id="game-container"></div>
    
    <!-- èƒŒæ™¯éŸ³ä¹ -->
    <audio id="bg-music" loop preload="auto">
        <!-- æœ¬åœ°è¶…çº§ç›ä¸½éŸ³ä¹æ–‡ä»¶ï¼ˆæœ€ä¼˜å…ˆï¼Œæœ€ç¨³å®šï¼‰ -->
        <source src="./assets/music/01.%20Ground%20Theme.mp3" type="audio/mpeg">
        <!-- å¤‡ç”¨CDNæºï¼ˆå¦‚æœæœ¬åœ°æ–‡ä»¶åŠ è½½å¤±è´¥ï¼‰ -->
        <source src="https://github.com/justinvforvendetta/8bit-game-music/raw/master/Super%20Mario%20Bros%20-%20Overworld.mp3" type="audio/mpeg">
        <source src="https://www.myinstants.com/media/sounds/super-mario-bros.mp3" type="audio/mpeg">
    </audio>
    
    <!-- éŸ³ä¹æ§åˆ¶æŒ‰é’® -->
    <button id="music-toggle-btn" style="position: fixed; bottom: 15px; right: 15px; width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: 2px solid rgba(255, 255, 255, 0.5); cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s; z-index: 999;">ğŸ”Š</button>

    <!-- å¼•å…¥ Phaser.js åº“ (ä»CDNåŠ è½½) -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    
    <!-- å¼•å…¥ Supabase å®¢æˆ·ç«¯åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ==================== ç©å®¶åå­—ç®¡ç† ====================
        let playerName = '';
        let gameStarted = false;
        let playerNameTextObject = null;  // ä¿å­˜ç©å®¶åå­—æ–‡æœ¬å¯¹è±¡çš„å¼•ç”¨
        let gameScene = null;  // ä¿å­˜æ¸¸æˆåœºæ™¯å¯¹è±¡
        
        // ==================== å¹¿å‘Šä½ç®¡ç† ====================
        let adBalloons = [];  // å­˜å‚¨å¹¿å‘Šæ°”çƒæ•°æ®
        let adBalloonsObjects = [];  // å­˜å‚¨å¹¿å‘Šæ°”çƒçš„Phaserå¯¹è±¡
        
        // ==================== æ”¯ä»˜è®¾ç½®æ•°æ® ====================
        let paymentSettings = {
            alipayQRCode: null,
            wechatQRCode: null,
            visaAccountName: '',
            visaCardNumber: '',
            mastercardAccountName: '',
            mastercardCardNumber: ''
        };
        
        const ADMIN_USERNAME = 'DDKJ';
        const ADMIN_PASSWORD = 'DDKJ88888888';
        let isAdminLoggedIn = false;
        
        // ==================== Supabase é…ç½® ====================
        const SUPABASE_URL = 'https://ksctfambipodjbrtjaby.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_8MsjbT3RenOKGNyMafKv-Q_b8MNN7Qn';
        
        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
        let supabaseClient = null;
        try {
            if (typeof window.supabase !== 'undefined') {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
            } else {
                console.error('âŒ Supabase åº“æœªåŠ è½½ï¼');
            }
        } catch (error) {
            console.error('âŒ Supabase åˆå§‹åŒ–å¤±è´¥:', error);
        }
        
        // ==================== æ¸¸æˆå…ƒç´ ç”Ÿæˆå‚æ•° ====================
        let gameSettings = {
            coinSpawnRate: 0.02,        // é‡‘å¸ç”Ÿæˆæ¦‚ç‡ï¼ˆæ¯å¸§ï¼‰
            coinMaxCount: 15,           // é‡‘å¸æœ€å¤§æ•°é‡ï¼ˆæ”¹ä¸º15ä¸ªï¼‰
            coinLifeTime: 12000,        // é‡‘å¸å­˜åœ¨æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
            diamondSpawnInterval: 100000, // é’»çŸ³ç”Ÿæˆé—´éš”ï¼ˆæ¯«ç§’ï¼‰100ç§’
            diamondSpawnCount: 5,       // æ¯æ¬¡ç”Ÿæˆé’»çŸ³æ•°é‡ï¼ˆé’»çŸ³é“å…·æœ€å¤§5ä¸ªï¼‰
            diamondMaxCount: 5,         // é’»çŸ³é“å…·æœ€å¤§æ•°é‡ï¼ˆæ–°å¢ï¼‰
            obstacleSpawnRate: 0.005,   // éšœç¢ç‰©ç”Ÿæˆæ¦‚ç‡ï¼ˆæé«˜åˆ°0.005ï¼‰
            obstacleMaxCount: 6,        // éšœç¢ç‰©æœ€å¤§æ•°é‡ï¼ˆæ”¹ä¸º6ä¸ªï¼‰
            healthPackInterval: 100000, // åŠ è¡€åŒ…ç”Ÿæˆé—´éš”ï¼ˆæ¯«ç§’ï¼‰
            healthPackCount: 2,         // æ¯æ¬¡ç”ŸæˆåŠ è¡€åŒ…æ•°é‡ï¼ˆæ–°å¢ï¼‰
            healthPackLifetime: 8000    // åŠ è¡€åŒ…åœç•™æ—¶é—´ï¼ˆæ¯«ç§’ï¼Œæ–°å¢ï¼‰
        };
        
        // ==================== å…¨å±€æ¸¸æˆæ•°æ® ====================
        let currentUserId = null;           // å½“å‰ç™»å½•ç”¨æˆ·çš„ID
        let gameDiamonds = 0;               // é’»çŸ³ï¼ˆæ¸¸æˆç§¯åˆ†ï¼‰
        let totalCoinsCollected = 0;        // ç´¯è®¡æ”¶é›†çš„é‡‘å¸æ•°
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å·²ç™»å½•çš„ç”¨æˆ·
        const savedUserId = localStorage.getItem('currentUserId');
        const savedName = localStorage.getItem('balloonPlayerName');
        if (savedUserId && savedName) {
            // è‡ªåŠ¨ç™»å½•
            currentUserId = parseInt(savedUserId);
            playerName = savedName;
            console.log('ğŸ” æ£€æµ‹åˆ°å·²ç™»å½•ç”¨æˆ·:', playerName, '(ID:', currentUserId, ')');
            
            document.getElementById('name-modal').classList.add('hidden');
            document.getElementById('user-settings-btn').style.display = 'block';
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯è¶…çº§ç®¡ç†å‘˜
            if (playerName === 'DDKJ') {
                document.getElementById('admin-settings-btn').style.display = 'block';
                console.log('ğŸ‘‘ è¶…çº§ç®¡ç†å‘˜è‡ªåŠ¨ç™»å½•ï¼');
            } else {
                document.getElementById('admin-settings-btn').style.display = 'none';
            }
            
            gameStarted = true;
            
            // å¼‚æ­¥åŠ è½½ç”¨æˆ·æ•°æ®
            (async () => {
                try {
                    const { data } = await supabaseClient
                        .from('game_users')
                        .select('diamonds, coins_collected')
                        .eq('id', currentUserId)
                        .single();
                    
                    if (data) {
                        gameDiamonds = data.diamonds || 0;
                        totalCoinsCollected = data.coins_collected || 0;
                        console.log('ğŸ“Š å·²åŒæ­¥ç”¨æˆ·æ•°æ® - é’»çŸ³:', gameDiamonds, 'é‡‘å¸:', totalCoinsCollected);
                        // updateDiamonds() ä¼šåœ¨æ¸¸æˆåœºæ™¯åˆ›å»ºåè‡ªåŠ¨è°ƒç”¨
                    }
                } catch (error) {
                    console.error('âŒ åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                }
            })();
        } else {
            document.getElementById('user-settings-btn').style.display = 'none';
            console.log('ğŸšª æœªæ£€æµ‹åˆ°ç™»å½•ä¿¡æ¯ï¼Œæ˜¾ç¤ºç™»å½•ç•Œé¢');
        }
        
        // ä» localStorage è¯»å–ä¿å­˜çš„é’»çŸ³å’Œç´¯è®¡é‡‘å¸
        const savedDiamonds = localStorage.getItem('gameDiamonds');
        if (savedDiamonds) {
            gameDiamonds = parseInt(savedDiamonds) || 0;
            console.log('ğŸ’ å·²åŠ è½½é’»çŸ³:', gameDiamonds);
        }
        
        const savedCoins = localStorage.getItem('totalCoinsCollected');
        if (savedCoins) {
            totalCoinsCollected = parseInt(savedCoins) || 0;
            console.log('ğŸª™ å·²åŠ è½½ç´¯è®¡é‡‘å¸:', totalCoinsCollected);
        }
        
        // æ³¨æ„ï¼šæ¸¸æˆè®¾ç½®ç°åœ¨ä» Supabase å…¨å±€é…ç½®åŠ è½½
        // ä¸å†ä½¿ç”¨ localStorage å­˜å‚¨æ¸¸æˆè®¾ç½®ï¼Œç¡®ä¿æ‰€æœ‰ç©å®¶ä½¿ç”¨ç›¸åŒé…ç½®
        // const savedSettings = localStorage.getItem('gameSettings'); // å·²åºŸå¼ƒ
        console.log('âš™ï¸ æ¸¸æˆè®¾ç½®å°†åœ¨ç™»å½•åä» Supabase åŠ è½½');
        
        // ==================== ç”¨æˆ·ç™»å½•å’Œæ³¨å†Œç³»ç»Ÿ ====================
        
        // ç™»å½•æŒ‰é’®
        document.getElementById('login-btn').addEventListener('click', handleLogin);
        
        // æ˜¾ç¤ºæ³¨å†Œç•Œé¢
        document.getElementById('show-register-btn').addEventListener('click', function() {
            document.getElementById('name-modal').style.display = 'none';
            document.getElementById('register-modal').style.display = 'flex';
        });
        
        // è¿”å›ç™»å½•ç•Œé¢
        document.getElementById('back-to-login-btn').addEventListener('click', function() {
            document.getElementById('register-modal').style.display = 'none';
            document.getElementById('name-modal').style.display = 'flex';
        });
        
        // æäº¤æ³¨å†Œ
        document.getElementById('register-submit-btn').addEventListener('click', handleRegister);
        
        // å›è½¦é”®ç™»å½•
        document.getElementById('login-username').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('login-password').focus();
            }
        });
        document.getElementById('login-password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });
        
        // ç™»å½•å¤„ç†å‡½æ•°
        async function handleLogin() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            
            if (!username || !password) {
                alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼');
                return;
            }
            
            try {
                console.log('ğŸ” å°è¯•ç™»å½•ï¼Œç”¨æˆ·å:', username);
                
                // ä»SupabaseæŸ¥è¯¢ç”¨æˆ·ï¼ˆä¸ä½¿ç”¨singleï¼Œé¿å…406é”™è¯¯ï¼‰
                const { data, error } = await supabaseClient
                    .from('game_users')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password);  // æ³¨æ„ï¼šç”Ÿäº§ç¯å¢ƒåº”è¯¥ä½¿ç”¨åŠ å¯†å¯†ç 
                
                if (error) {
                    console.error('âŒ æ•°æ®åº“æŸ¥è¯¢é”™è¯¯:', error);
                    alert('âŒ ç™»å½•å¤±è´¥ï¼šæ•°æ®åº“è¿æ¥é”™è¯¯ï¼\n' + error.message);
                    return;
                }
                
                if (!data || data.length === 0) {
                    console.error('âŒ æœªæ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·');
                    alert('âŒ ç™»å½•å¤±è´¥ï¼šç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼');
                    return;
                }
                
                // è·å–ç¬¬ä¸€ä¸ªåŒ¹é…çš„ç”¨æˆ·
                const user = data[0];
                if (user) {
                    console.log('âœ… ç™»å½•æˆåŠŸï¼ç”¨æˆ·:', user);
                    
                    // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
                    currentUserId = user.id;
                    playerName = user.username;
                    gameDiamonds = user.diamonds || 0;
                    totalCoinsCollected = user.coins_collected || 0;
                    
                    // æ›´æ–°æœ€åç™»å½•æ—¶é—´
                    await supabaseClient
                        .from('game_users')
                        .update({ last_login: new Date().toISOString() })
                        .eq('id', currentUserId);
                    
                    // ä¿å­˜åˆ°localStorage
                    localStorage.setItem('currentUserId', currentUserId);
                    localStorage.setItem('balloonPlayerName', playerName);
                    localStorage.setItem('gameDiamonds', gameDiamonds);
                    localStorage.setItem('totalCoinsCollected', totalCoinsCollected);
                    
                    // å¼€å§‹æ¸¸æˆï¼ˆUI ä¼šåœ¨æ¸¸æˆåœºæ™¯åˆ›å»ºæ—¶è‡ªåŠ¨æ›´æ–°ï¼‰
                    await startGameAfterLogin();
                    
                    alert('âœ… æ¬¢è¿å›æ¥ï¼Œ' + playerName + 'ï¼\n\nğŸ’ é’»çŸ³ï¼š' + gameDiamonds + '\nğŸª™ é‡‘å¸ï¼š' + totalCoinsCollected);
                }
            } catch (error) {
                console.error('âŒ ç™»å½•å¼‚å¸¸:', error);
                alert('âŒ ç™»å½•å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // æ³¨å†Œå¤„ç†å‡½æ•°
        async function handleRegister() {
            const username = document.getElementById('register-username').value.trim();
            const password = document.getElementById('register-password').value;
            const passwordConfirm = document.getElementById('register-password-confirm').value;
            const country = document.getElementById('register-country').value;
            const region = document.getElementById('register-region').value.trim();
            const gender = document.getElementById('register-gender').value;
            const age = document.getElementById('register-age').value;
            const phone = document.getElementById('register-phone').value.trim();
            
            // éªŒè¯å¿…å¡«é¡¹
            if (!username) {
                alert('âŒ è¯·è¾“å…¥ç”¨æˆ·åï¼');
                return;
            }
            
            if (username.length < 2) {
                alert('âŒ ç”¨æˆ·åè‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦ï¼');
                return;
            }
            
            if (!password) {
                alert('âŒ è¯·è¾“å…¥å¯†ç ï¼');
                return;
            }
            
            if (password.length < 6) {
                alert('âŒ å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦ï¼');
                return;
            }
            
            if (password !== passwordConfirm) {
                alert('âŒ ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼');
                return;
            }
            
            try {
                console.log('ğŸ“ å°è¯•æ³¨å†Œï¼Œç”¨æˆ·å:', username);
                
                // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
                const { data: existingUser } = await supabaseClient
                    .from('game_users')
                    .select('username')
                    .eq('username', username)
                    .single();
                
                if (existingUser) {
                    alert('âŒ ç”¨æˆ·åå·²è¢«ä½¿ç”¨ï¼Œè¯·æ¢ä¸€ä¸ªï¼');
                    return;
                }
                
                // æ’å…¥æ–°ç”¨æˆ·
                const { data, error } = await supabaseClient
                    .from('game_users')
                    .insert([{
                        username: username,
                        password: password,  // æ³¨æ„ï¼šç”Ÿäº§ç¯å¢ƒåº”è¯¥åŠ å¯†
                        country: country || null,
                        region: region || null,
                        gender: gender || null,
                        age: age ? parseInt(age) : null,
                        phone: phone || null,
                        diamonds: 0,
                        coins_collected: 0
                    }])
                    .select()
                    .single();
                
                if (error) {
                    console.error('âŒ æ³¨å†Œå¤±è´¥:', error);
                    alert('âŒ æ³¨å†Œå¤±è´¥ï¼š' + error.message);
                    return;
                }
                
                if (data) {
                    console.log('âœ… æ³¨å†ŒæˆåŠŸï¼æ–°ç”¨æˆ·:', data);
                    
                    alert('âœ… æ³¨å†ŒæˆåŠŸï¼\n\næ¬¢è¿åŠ å…¥çƒ­æ°”çƒä¸–ç•Œï¼Œ' + username + 'ï¼\n\nè¯·ä½¿ç”¨åˆšæ‰çš„ç”¨æˆ·åå’Œå¯†ç ç™»å½•ã€‚');
                    
                    // è¿”å›ç™»å½•ç•Œé¢ï¼Œå¹¶è‡ªåŠ¨å¡«å……ç”¨æˆ·å
                    document.getElementById('register-modal').style.display = 'none';
                    document.getElementById('name-modal').style.display = 'flex';
                    document.getElementById('login-username').value = username;
                    document.getElementById('login-password').focus();
                    
                    // æ¸…ç©ºæ³¨å†Œè¡¨å•
                    document.getElementById('register-username').value = '';
                    document.getElementById('register-password').value = '';
                    document.getElementById('register-password-confirm').value = '';
                    document.getElementById('register-country').value = '';
                    document.getElementById('register-region').value = '';
                    document.getElementById('register-gender').value = '';
                    document.getElementById('register-age').value = '';
                    document.getElementById('register-phone').value = '';
                }
            } catch (error) {
                console.error('âŒ æ³¨å†Œå¼‚å¸¸:', error);
                alert('âŒ æ³¨å†Œå¤±è´¥ï¼š' + error.message);
            }
        }
        
        // ç™»å½•åå¯åŠ¨æ¸¸æˆ
        async function startGameAfterLogin() {
            document.getElementById('name-modal').classList.add('hidden');
            document.getElementById('user-settings-btn').style.display = 'block';
            
            console.log('âœ… ç”¨æˆ·å·²ç™»å½•:', playerName);
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯è¶…çº§ç®¡ç†å‘˜
            if (playerName === 'DDKJ') {
                document.getElementById('admin-settings-btn').style.display = 'block';
                console.log('ğŸ‘‘ è¶…çº§ç®¡ç†å‘˜ç™»å½•ï¼');
            } else {
                document.getElementById('admin-settings-btn').style.display = 'none';
            }
            
            // å°è¯•æ’­æ”¾èƒŒæ™¯éŸ³ä¹
            tryAutoPlayMusic();
            
            // å¦‚æœæ˜¯é¦–æ¬¡å¯åŠ¨æ¸¸æˆ
            if (!gameStarted) {
                console.log('ğŸˆ æ¸¸æˆé¦–æ¬¡å¯åŠ¨ï¼Œç©å®¶:', playerName);
                
                // åŠ è½½å…¨å±€é…ç½®
                console.log('ğŸ”„ æ­£åœ¨åŠ è½½å…¨å±€æ¸¸æˆé…ç½®...');
                await loadGlobalSettings();
                
                gameStarted = true;
                
                // å¦‚æœæ¸¸æˆåœºæ™¯å·²ç»åˆ›å»ºï¼Œç«‹å³åˆå§‹åŒ–
                if (gameScene) {
                    console.log('ğŸš€ åœºæ™¯å·²å­˜åœ¨ï¼Œç«‹å³åˆå§‹åŒ–æ¸¸æˆ...');
                    try {
                        initializeGame.call(gameScene);
                        console.log('âœ… æ¸¸æˆåˆå§‹åŒ–å®Œæˆï¼');
                    } catch (error) {
                        console.error('âŒ æ¸¸æˆåˆå§‹åŒ–å¤±è´¥:', error);
                    }
                } else {
                    console.log('â³ åœºæ™¯æœªåˆ›å»ºï¼Œç­‰å¾… Phaser åœºæ™¯åˆå§‹åŒ–...');
                }
            }
        }
        
        // ==================== èƒŒæ™¯éŸ³ä¹æ§åˆ¶ ====================
        
        const bgMusic = document.getElementById('bg-music');
        const musicToggleBtn = document.getElementById('music-toggle-btn');
        let isMusicPlaying = false;
        
        // ç›‘å¬éŸ³é¢‘åŠ è½½çŠ¶æ€
        bgMusic.addEventListener('loadeddata', function() {
            console.log('âœ… éŸ³é¢‘æ–‡ä»¶åŠ è½½æˆåŠŸ');
        });
        
        bgMusic.addEventListener('error', function(e) {
            console.error('âŒ éŸ³é¢‘åŠ è½½å¤±è´¥:', e);
            console.error('âŒ é”™è¯¯è¯¦æƒ…:', bgMusic.error);
            // å°è¯•åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªéŸ³æº
            const sources = bgMusic.querySelectorAll('source');
            const currentSrc = bgMusic.currentSrc;
            console.log('âŒ å½“å‰å¤±è´¥çš„éŸ³æº:', currentSrc);
            console.log('ğŸ’¡ æç¤ºï¼šå¦‚æœæ‰€æœ‰éŸ³æºéƒ½å¤±è´¥ï¼Œè¯·è€ƒè™‘ä¸Šä¼ æœ¬åœ°éŸ³ä¹æ–‡ä»¶');
        });
        
        bgMusic.addEventListener('canplay', function() {
            console.log('âœ… éŸ³é¢‘å¯ä»¥æ’­æ”¾äº†');
        });
        
        // å°è¯•è‡ªåŠ¨æ’­æ”¾èƒŒæ™¯éŸ³ä¹
        function tryAutoPlayMusic() {
            console.log('ğŸµ å°è¯•æ’­æ”¾èƒŒæ™¯éŸ³ä¹...');
            console.log('ğŸµ éŸ³é¢‘å½“å‰æº:', bgMusic.currentSrc);
            
            // å…ˆåŠ è½½éŸ³é¢‘
            bgMusic.load();
            
            // ç­‰å¾…ä¸€ä¼šå†æ’­æ”¾
            setTimeout(() => {
                bgMusic.play().then(() => {
                    isMusicPlaying = true;
                    musicToggleBtn.innerHTML = 'ğŸ”Š';
                    console.log('âœ… èƒŒæ™¯éŸ³ä¹æ’­æ”¾æˆåŠŸï¼');
                }).catch(error => {
                    console.warn('âš ï¸ è‡ªåŠ¨æ’­æ”¾è¢«æµè§ˆå™¨é˜»æ­¢:', error.message);
                    console.warn('ğŸ’¡ è¯·ç‚¹å‡»å³ä¸‹è§’çš„éŸ³ä¹æŒ‰é’®æ‰‹åŠ¨å¼€å¯éŸ³ä¹');
                    isMusicPlaying = false;
                    musicToggleBtn.innerHTML = 'ğŸ”‡';
                    // æ·»åŠ é—ªçƒæ•ˆæœæç¤ºç”¨æˆ·
                    musicToggleBtn.style.animation = 'pulse 1s infinite';
                });
            }, 500);
        }
        
        // éŸ³ä¹æ§åˆ¶æŒ‰é’®
        musicToggleBtn.addEventListener('click', function() {
            // ç§»é™¤é—ªçƒåŠ¨ç”»
            musicToggleBtn.style.animation = 'none';
            
            if (isMusicPlaying) {
                bgMusic.pause();
                musicToggleBtn.innerHTML = 'ğŸ”‡';
                isMusicPlaying = false;
                console.log('ğŸ”‡ èƒŒæ™¯éŸ³ä¹å·²æš‚åœ');
            } else {
                console.log('ğŸµ ç”¨æˆ·ç‚¹å‡»æ’­æ”¾éŸ³ä¹');
                console.log('ğŸµ å½“å‰éŸ³æº:', bgMusic.currentSrc);
                
                bgMusic.play().then(() => {
                    musicToggleBtn.innerHTML = 'ğŸ”Š';
                    isMusicPlaying = true;
                    console.log('âœ… èƒŒæ™¯éŸ³ä¹å¼€å§‹æ’­æ”¾ï¼');
                }).catch(error => {
                    console.error('âŒ æ’­æ”¾å¤±è´¥:', error.message);
                    alert('âŒ éŸ³ä¹æ’­æ”¾å¤±è´¥ï¼š' + error.message + '\n\nğŸ’¡ å¯èƒ½åŸå› ï¼š\n1. éŸ³é¢‘æ–‡ä»¶æ— æ³•åŠ è½½\n2. æµè§ˆå™¨é™åˆ¶\n3. ç½‘ç»œé—®é¢˜\n\nå»ºè®®ä¸Šä¼ æœ¬åœ°éŸ³ä¹æ–‡ä»¶');
                });
            }
        });
        
        // è®¾ç½®éŸ³é‡
        bgMusic.volume = 0.3; // 30%éŸ³é‡ï¼Œé¿å…å¤ªåµ
        
        // ==================== ç”¨æˆ·è®¾ç½®åŠŸèƒ½ ====================
        
        // æ‰“å¼€ç”¨æˆ·è®¾ç½®
        document.getElementById('user-settings-btn').addEventListener('click', async function() {
            if (!currentUserId) {
                alert('è¯·å…ˆç™»å½•ï¼');
                return;
            }
            
            // åŠ è½½å½“å‰ç”¨æˆ·ä¿¡æ¯
            try {
                const { data, error } = await supabaseClient
                    .from('game_users')
                    .select('*')
                    .eq('id', currentUserId)
                    .single();
                
                if (data) {
                    document.getElementById('user-setting-username').value = data.username;
                    document.getElementById('user-setting-country').value = data.country || '';
                    document.getElementById('user-setting-region').value = data.region || '';
                    document.getElementById('user-setting-gender').value = data.gender || '';
                    document.getElementById('user-setting-age').value = data.age || '';
                    document.getElementById('user-setting-phone').value = data.phone || '';
                    
                    // æ¸…ç©ºå¯†ç å­—æ®µ
                    document.getElementById('user-setting-password').value = '';
                    document.getElementById('user-setting-password-confirm').value = '';
                    
                    // æ˜¾ç¤ºè®¾ç½®å¼¹çª—
                    document.getElementById('user-settings-modal').style.display = 'flex';
                }
            } catch (error) {
                console.error('âŒ åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                alert('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼');
            }
        });
        
        // å…³é—­ç”¨æˆ·è®¾ç½®
        document.getElementById('close-user-settings-btn').addEventListener('click', function() {
            document.getElementById('user-settings-modal').style.display = 'none';
        });
        
        // ä¿å­˜ç”¨æˆ·è®¾ç½®
        document.getElementById('save-user-settings-btn').addEventListener('click', async function() {
            const newPassword = document.getElementById('user-setting-password').value;
            const confirmPassword = document.getElementById('user-setting-password-confirm').value;
            const country = document.getElementById('user-setting-country').value;
            const region = document.getElementById('user-setting-region').value;
            const gender = document.getElementById('user-setting-gender').value;
            const age = document.getElementById('user-setting-age').value;
            const phone = document.getElementById('user-setting-phone').value;
            
            // éªŒè¯å¯†ç 
            if (newPassword) {
                if (newPassword.length < 6) {
                    alert('âŒ å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦ï¼');
                    return;
                }
                if (newPassword !== confirmPassword) {
                    alert('âŒ ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼');
                    return;
                }
            }
            
            try {
                // å‡†å¤‡æ›´æ–°æ•°æ®
                const updateData = {
                    country: country || null,
                    region: region || null,
                    gender: gender || null,
                    age: age ? parseInt(age) : null,
                    phone: phone || null
                };
                
                // å¦‚æœè¦ä¿®æ”¹å¯†ç 
                if (newPassword) {
                    updateData.password = newPassword;
                }
                
                // æ›´æ–°åˆ°æ•°æ®åº“
                const { error } = await supabaseClient
                    .from('game_users')
                    .update(updateData)
                    .eq('id', currentUserId);
                
                if (error) {
                    console.error('âŒ ä¿å­˜ç”¨æˆ·è®¾ç½®å¤±è´¥:', error);
                    alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + error.message);
                    return;
                }
                
                alert('âœ… è®¾ç½®å·²ä¿å­˜æˆåŠŸï¼');
                document.getElementById('user-settings-modal').style.display = 'none';
                
                console.log('ğŸ’¾ ç”¨æˆ·è®¾ç½®å·²ä¿å­˜');
            } catch (error) {
                console.error('âŒ ä¿å­˜ç”¨æˆ·è®¾ç½®å¼‚å¸¸:', error);
                alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + error.message);
            }
        });
        
        // å¤„ç†é€€å‡ºç™»å½•æŒ‰é’®
        document.getElementById('logout-btn').addEventListener('click', function() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ\n\né€€å‡ºåéœ€è¦é‡æ–°ç™»å½•ã€‚')) {
                // æ¸…é™¤æ‰€æœ‰ç™»å½•ä¿¡æ¯
                localStorage.removeItem('currentUserId');
                localStorage.removeItem('balloonPlayerName');
                currentUserId = null;
                playerName = '';
                // åˆ·æ–°é¡µé¢
                location.reload();
            }
        });
        
        // ç™»å½•æ¡†å›è½¦é”®å¤„ç†å·²åœ¨handleLoginå‡½æ•°ä¸­å®ç°
        
        // ==================== ç»Ÿä¸€ç®¡ç†å‘˜è®¾ç½®ç›¸å…³äº‹ä»¶ ====================
        
        // ç®¡ç†å‘˜è®¾ç½®æŒ‰é’®ï¼ˆåªæœ‰è¶…çº§ç®¡ç†å‘˜èƒ½çœ‹åˆ°æ­¤æŒ‰é’®ï¼‰
        document.getElementById('admin-settings-btn').addEventListener('click', function() {
            // è¶…çº§ç®¡ç†å‘˜å·²ç»ç™»å½•ï¼Œç›´æ¥æ‰“å¼€è®¾ç½®é¢æ¿
            isAdminLoggedIn = true;
            document.getElementById('admin-settings-modal').classList.add('show');
            
            // åŠ è½½æ‰€æœ‰è®¾ç½®
            loadGameSettings();
            loadPaymentSettings();
            loadAdBalloons();
            refreshAdBalloonsList();
        });
        
        // å…³é—­ç®¡ç†å‘˜è®¾ç½®é¢æ¿
        document.getElementById('close-admin-settings-btn').addEventListener('click', function() {
            document.getElementById('admin-settings-modal').classList.remove('show');
        });
        
        // æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                
                // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹
                document.querySelectorAll('.admin-tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabName + '-content').classList.add('active');
            });
        });
        
        // å›¾ç‰‡é¢„è§ˆ
        document.getElementById('new-ad-image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const preview = document.getElementById('new-ad-image-preview');
                    preview.src = event.target.result;
                    preview.classList.add('show');
                };
                reader.readAsDataURL(file);
            }
        });
        
        // æ·»åŠ å¹¿å‘Šæ°”çƒ
        document.getElementById('add-ad-balloon-btn').addEventListener('click', addAdBalloon);
        
        // ==================== å……å€¼å’Œå¤æ´»ç›¸å…³äº‹ä»¶ ====================
        
        // å……å€¼æŒ‰é’®
        document.getElementById('recharge-btn').addEventListener('click', function() {
            document.getElementById('recharge-modal').classList.add('show');
            // æ›´æ–°æ”¶æ¬¾ç æ˜¾ç¤º
            updateRechargeQRCodes();
        });
        
        // å–æ¶ˆå……å€¼
        document.getElementById('cancel-recharge-btn').addEventListener('click', function() {
            document.getElementById('recharge-modal').classList.remove('show');
        });
        
        // å……å€¼é‡‘é¢å®æ—¶é¢„è§ˆ
        document.getElementById('recharge-amount').addEventListener('input', function(e) {
            const amount = parseFloat(e.target.value) || 0;
            const credits = Math.floor(amount * 1000);
            document.getElementById('recharge-credits-preview').textContent = credits;
        });
        
        // ä½¿ç”¨é’»çŸ³å¤æ´»
        document.getElementById('revive-credits-btn').addEventListener('click', function() {
            if (gameDiamonds >= 100) {
                gameDiamonds -= 100;
                updateDiamonds();
                localStorage.setItem('gameDiamonds', gameDiamonds);
                revivePlayer('diamonds');
                alert('å¤æ´»æˆåŠŸï¼æ¶ˆè€—100é’»çŸ³');
            } else {
                alert('é’»çŸ³ä¸è¶³ï¼éœ€è¦100é’»çŸ³');
            }
        });
        
        // å……å€¼å¤æ´»
        document.getElementById('revive-pay-btn').addEventListener('click', function() {
            // æ‰“å¼€å……å€¼å¼¹çª—ï¼Œè®¾ç½®é‡‘é¢ä¸º0.1å…ƒ
            document.getElementById('death-modal').classList.remove('show');
            document.getElementById('recharge-modal').classList.add('show');
            document.getElementById('recharge-amount').value = '0.1';
            document.getElementById('recharge-credits-preview').textContent = '100';
        });
        
        // ==================== æ”¯ä»˜è®¾ç½®ç›¸å…³äº‹ä»¶ï¼ˆå·²æ•´åˆåˆ°ç»Ÿä¸€é¢æ¿ï¼‰ ====================
        
        // æ”¯ä»˜å®æ”¶æ¬¾ç ä¸Šä¼ 
        document.getElementById('alipay-qrcode-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async function(event) {
                    const preview = document.getElementById('alipay-qrcode-preview');
                    preview.src = event.target.result;
                    preview.classList.add('show');
                    paymentSettings.alipayQRCode = event.target.result;
                    
                    // ç«‹å³ä¿å­˜åˆ° Supabase æ•°æ®åº“
                    const success = await saveGlobalSettings();
                    if (success) {
                        console.log('âœ… æ”¯ä»˜å®æ”¶æ¬¾ç å·²ä¸Šä¼ å¹¶ä¿å­˜åˆ°äº‘ç«¯');
                        alert('âœ… æ”¯ä»˜å®æ”¶æ¬¾ç å·²ä¸Šä¼ æˆåŠŸï¼\n\nğŸŒ æ‰€æœ‰ç©å®¶ç°åœ¨å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ”¶æ¬¾ç ï¼');
                    }
                };
                reader.readAsDataURL(file);
            }
        });
        
        // å¾®ä¿¡æ”¶æ¬¾ç ä¸Šä¼ 
        document.getElementById('wechat-qrcode-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async function(event) {
                    const preview = document.getElementById('wechat-qrcode-preview');
                    preview.src = event.target.result;
                    preview.classList.add('show');
                    paymentSettings.wechatQRCode = event.target.result;
                    
                    // ç«‹å³ä¿å­˜åˆ° Supabase æ•°æ®åº“
                    const success = await saveGlobalSettings();
                    if (success) {
                        console.log('âœ… å¾®ä¿¡æ”¶æ¬¾ç å·²ä¸Šä¼ å¹¶ä¿å­˜åˆ°äº‘ç«¯');
                        alert('âœ… å¾®ä¿¡æ”¶æ¬¾ç å·²ä¸Šä¼ æˆåŠŸï¼\n\nğŸŒ æ‰€æœ‰ç©å®¶ç°åœ¨å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ”¶æ¬¾ç ï¼');
                    }
                };
                reader.readAsDataURL(file);
            }
        });
        
        // ä¿å­˜æ”¯ä»˜è®¾ç½®
        document.getElementById('save-payment-settings-btn').addEventListener('click', async function() {
            paymentSettings.visaAccountName = document.getElementById('visa-account-name').value;
            paymentSettings.visaCardNumber = document.getElementById('visa-card-number').value;
            paymentSettings.mastercardAccountName = document.getElementById('mastercard-account-name').value;
            paymentSettings.mastercardCardNumber = document.getElementById('mastercard-card-number').value;
            
            // ä¿å­˜åˆ° Supabase æ•°æ®åº“
            const success = await saveGlobalSettings();
            
            if (success) {
                alert('âœ… æ”¯ä»˜è®¾ç½®å·²ä¿å­˜åˆ°äº‘ç«¯ï¼\n\nğŸŒ æ‰€æœ‰ç©å®¶å¯ä»¥çœ‹åˆ°æ–°çš„æ”¯ä»˜è®¾ç½®ï¼');
            }
        });
        
        // æ”¯ä»˜æ–¹å¼åˆ‡æ¢
        document.querySelectorAll('.payment-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const method = this.getAttribute('data-method');
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.payment-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // æ˜¾ç¤ºå¯¹åº”çš„æ”¯ä»˜å†…å®¹
                document.querySelectorAll('.payment-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(method + '-payment').classList.add('active');
                
                // åˆ‡æ¢æ”¯ä»˜æ–¹å¼æ—¶æ›´æ–°æ”¶æ¬¾ç æ˜¾ç¤º
                updateRechargeQRCodes();
            });
        });
        
        // æ”¯ä»˜å®ç¡®è®¤æ”¯ä»˜
        document.getElementById('alipay-confirm-btn').addEventListener('click', function() {
            const amount = parseFloat(document.getElementById('recharge-amount').value) || 0;
            if (amount < 0.1) {
                alert('æœ€ä½å……å€¼é‡‘é¢ä¸º0.1å…ƒï¼');
                return;
            }
            
            alert('æ”¶åˆ°æ‚¨çš„æ”¯ä»˜é€šçŸ¥ï¼\n\nè¯·ç­‰å¾…ç®¡ç†å‘˜ç¡®è®¤å……å€¼ã€‚\nç¡®è®¤åæ¸¸æˆåˆ†å°†è‡ªåŠ¨åˆ°è´¦ã€‚\n\næ¼”ç¤ºæ¨¡å¼ï¼šå°†ç›´æ¥å……å€¼æˆåŠŸã€‚');
            
            const credits = Math.floor(amount * 1000);
            gameDiamonds += credits;
            updateDiamonds();
            localStorage.setItem('gameDiamonds', gameDiamonds);
            
            document.getElementById('recharge-modal').classList.remove('show');
            alert('å……å€¼æˆåŠŸï¼è·å¾— ' + credits + ' æ¸¸æˆåˆ†');
            
            // å¦‚æœæ˜¯ä»æ­»äº¡ç•Œé¢æ¥çš„å¤æ´»å……å€¼
            if (isDead && amount === 0.1) {
                revivePlayer('alipay');
            }
        });
        
        // å¾®ä¿¡ç¡®è®¤æ”¯ä»˜
        document.getElementById('wechat-confirm-btn').addEventListener('click', function() {
            const amount = parseFloat(document.getElementById('recharge-amount').value) || 0;
            if (amount < 0.1) {
                alert('æœ€ä½å……å€¼é‡‘é¢ä¸º0.1å…ƒï¼');
                return;
            }
            
            alert('æ”¶åˆ°æ‚¨çš„æ”¯ä»˜é€šçŸ¥ï¼\n\nè¯·ç­‰å¾…ç®¡ç†å‘˜ç¡®è®¤å……å€¼ã€‚\nç¡®è®¤åæ¸¸æˆåˆ†å°†è‡ªåŠ¨åˆ°è´¦ã€‚\n\næ¼”ç¤ºæ¨¡å¼ï¼šå°†ç›´æ¥å……å€¼æˆåŠŸã€‚');
            
            const credits = Math.floor(amount * 1000);
            gameDiamonds += credits;
            updateDiamonds();
            localStorage.setItem('gameDiamonds', gameDiamonds);
            
            document.getElementById('recharge-modal').classList.remove('show');
            alert('å……å€¼æˆåŠŸï¼è·å¾— ' + credits + ' æ¸¸æˆåˆ†');
            
            // å¦‚æœæ˜¯ä»æ­»äº¡ç•Œé¢æ¥çš„å¤æ´»å……å€¼
            if (isDead && amount === 0.1) {
                revivePlayer('wechat');
            }
        });
        
        // Visaæ”¯ä»˜
        document.getElementById('visa-pay-btn').addEventListener('click', function() {
            const cardNumber = document.getElementById('visa-card-input').value;
            const amount = parseFloat(document.getElementById('recharge-amount').value) || 0;
            
            if (!cardNumber || cardNumber.length < 16) {
                alert('è¯·è¾“å…¥å®Œæ•´çš„å¡å·ï¼');
                return;
            }
            
            if (amount < 0.1) {
                alert('æœ€ä½å……å€¼é‡‘é¢ä¸º0.1å…ƒï¼');
                return;
            }
            
            alert('âš ï¸ æ¼”ç¤ºæ¨¡å¼æç¤ºï¼š\n\nçœŸå®Visaæ”¯ä»˜éœ€è¦ï¼š\n1. æ¥å…¥Stripe/PayPalæ”¯ä»˜ç½‘å…³\n2. åç«¯æœåŠ¡å™¨å¤„ç†æ”¯ä»˜\n3. PCI DSSå®‰å…¨è®¤è¯\n\nå½“å‰å°†æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸã€‚');
            
            const credits = Math.floor(amount * 1000);
            gameDiamonds += credits;
            updateDiamonds();
            localStorage.setItem('gameDiamonds', gameDiamonds);
            
            document.getElementById('recharge-modal').classList.remove('show');
            alert('å……å€¼æˆåŠŸï¼è·å¾— ' + credits + ' æ¸¸æˆåˆ†');
            
            if (isDead && amount === 0.1) {
                revivePlayer('visa');
            }
        });
        
        // Mastercardæ”¯ä»˜
        document.getElementById('mastercard-pay-btn').addEventListener('click', function() {
            const cardNumber = document.getElementById('mastercard-card-input').value;
            const amount = parseFloat(document.getElementById('recharge-amount').value) || 0;
            
            if (!cardNumber || cardNumber.length < 16) {
                alert('è¯·è¾“å…¥å®Œæ•´çš„å¡å·ï¼');
                return;
            }
            
            if (amount < 0.1) {
                alert('æœ€ä½å……å€¼é‡‘é¢ä¸º0.1å…ƒï¼');
                return;
            }
            
            alert('âš ï¸ æ¼”ç¤ºæ¨¡å¼æç¤ºï¼š\n\nçœŸå®Mastercardæ”¯ä»˜éœ€è¦ï¼š\n1. æ¥å…¥Stripe/PayPalæ”¯ä»˜ç½‘å…³\n2. åç«¯æœåŠ¡å™¨å¤„ç†æ”¯ä»˜\n3. PCI DSSå®‰å…¨è®¤è¯\n\nå½“å‰å°†æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸã€‚');
            
            const credits = Math.floor(amount * 1000);
            gameDiamonds += credits;
            updateDiamonds();
            localStorage.setItem('gameDiamonds', gameDiamonds);
            
            document.getElementById('recharge-modal').classList.remove('show');
            alert('å……å€¼æˆåŠŸï¼è·å¾— ' + credits + ' æ¸¸æˆåˆ†');
            
            if (isDead && amount === 0.1) {
                revivePlayer('mastercard');
            }
        });
        
        // åŠ è½½æ”¯ä»˜è®¾ç½®
        function loadPaymentSettings() {
            try {
                const saved = localStorage.getItem('paymentSettings');
                if (saved) {
                    paymentSettings = JSON.parse(saved);
                    
                    // æ¢å¤æ”¶æ¬¾ç 
                    if (paymentSettings.alipayQRCode) {
                        const preview = document.getElementById('alipay-qrcode-preview');
                        preview.src = paymentSettings.alipayQRCode;
                        preview.classList.add('show');
                    }
                    
                    if (paymentSettings.wechatQRCode) {
                        const preview = document.getElementById('wechat-qrcode-preview');
                        preview.src = paymentSettings.wechatQRCode;
                        preview.classList.add('show');
                    }
                    
                    // æ¢å¤å¡å·ä¿¡æ¯
                    document.getElementById('visa-account-name').value = paymentSettings.visaAccountName || '';
                    document.getElementById('visa-card-number').value = paymentSettings.visaCardNumber || '';
                    document.getElementById('mastercard-account-name').value = paymentSettings.mastercardAccountName || '';
                    document.getElementById('mastercard-card-number').value = paymentSettings.mastercardCardNumber || '';
                }
            } catch (error) {
                console.error('åŠ è½½æ”¯ä»˜è®¾ç½®å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°å……å€¼å¼¹çª—ä¸­çš„æ”¶æ¬¾ç æ˜¾ç¤º
        function updateRechargeQRCodes() {
            // æ›´æ–°æ”¯ä»˜å®æ”¶æ¬¾ç 
            const alipayDisplay = document.getElementById('alipay-qrcode-display');
            if (paymentSettings.alipayQRCode) {
                alipayDisplay.innerHTML = '<img src="' + paymentSettings.alipayQRCode + '" alt="æ”¯ä»˜å®æ”¶æ¬¾ç " />';
            } else {
                alipayDisplay.innerHTML = '<div class="qrcode-placeholder">è¯·ç®¡ç†å‘˜å…ˆè®¾ç½®æ”¶æ¬¾ç </div>';
            }
            
            // æ›´æ–°å¾®ä¿¡æ”¶æ¬¾ç 
            const wechatDisplay = document.getElementById('wechat-qrcode-display');
            if (paymentSettings.wechatQRCode) {
                wechatDisplay.innerHTML = '<img src="' + paymentSettings.wechatQRCode + '" alt="å¾®ä¿¡æ”¶æ¬¾ç " />';
            } else {
                wechatDisplay.innerHTML = '<div class="qrcode-placeholder">è¯·ç®¡ç†å‘˜å…ˆè®¾ç½®æ”¶æ¬¾ç </div>';
            }
        }
        
        // æ³¨æ„ï¼šæ”¯ä»˜è®¾ç½®ç°åœ¨ä» Supabase å…¨å±€é…ç½®åŠ è½½
        // ä¸å†ä½¿ç”¨ localStorageï¼Œç¡®ä¿æ‰€æœ‰ç©å®¶çœ‹åˆ°ç›¸åŒçš„æ”¯ä»˜æ–¹å¼
        console.log('ğŸ’³ æ”¯ä»˜è®¾ç½®å°†åœ¨ç™»å½•åä» Supabase åŠ è½½');
        
        // ==================== æ¸¸æˆå‚æ•°è®¾ç½®åŠŸèƒ½ ====================
        
        // åŠ è½½æ¸¸æˆè®¾ç½®åˆ°è¡¨å•
        function loadGameSettings() {
            document.getElementById('coin-spawn-rate').value = gameSettings.coinSpawnRate;
            document.getElementById('coin-max-count').value = gameSettings.coinMaxCount;
            document.getElementById('coin-lifetime').value = gameSettings.coinLifeTime;
            document.getElementById('diamond-spawn-interval').value = gameSettings.diamondSpawnInterval;
            document.getElementById('diamond-spawn-count').value = gameSettings.diamondSpawnCount;
            document.getElementById('diamond-max-count').value = gameSettings.diamondMaxCount || 5;
            document.getElementById('obstacle-spawn-rate').value = gameSettings.obstacleSpawnRate;
            document.getElementById('obstacle-max-count').value = gameSettings.obstacleMaxCount;
            document.getElementById('healthpack-interval').value = gameSettings.healthPackInterval;
            document.getElementById('healthpack-count').value = gameSettings.healthPackCount || 2;
            document.getElementById('healthpack-lifetime').value = gameSettings.healthPackLifetime || 8000;
        }
        
        // ä¿å­˜æ¸¸æˆå‚æ•°
        document.getElementById('save-game-params-btn').addEventListener('click', async function() {
            gameSettings.coinSpawnRate = parseFloat(document.getElementById('coin-spawn-rate').value);
            gameSettings.coinMaxCount = parseInt(document.getElementById('coin-max-count').value);
            gameSettings.coinLifeTime = parseInt(document.getElementById('coin-lifetime').value);
            gameSettings.diamondSpawnInterval = parseInt(document.getElementById('diamond-spawn-interval').value);
            gameSettings.diamondSpawnCount = parseInt(document.getElementById('diamond-spawn-count').value);
            gameSettings.diamondMaxCount = parseInt(document.getElementById('diamond-max-count').value);
            gameSettings.obstacleSpawnRate = parseFloat(document.getElementById('obstacle-spawn-rate').value);
            gameSettings.obstacleMaxCount = parseInt(document.getElementById('obstacle-max-count').value);
            gameSettings.healthPackInterval = parseInt(document.getElementById('healthpack-interval').value);
            gameSettings.healthPackCount = parseInt(document.getElementById('healthpack-count').value);
            gameSettings.healthPackLifetime = parseInt(document.getElementById('healthpack-lifetime').value);
            
            // ä¿å­˜åˆ° Supabase æ•°æ®åº“ï¼ˆå…¨å±€é…ç½®ï¼‰
            const success = await saveGlobalSettings();
            
            if (success) {
                alert('âœ… æ¸¸æˆå‚æ•°å·²ä¿å­˜åˆ°äº‘ç«¯æ•°æ®åº“ï¼\n\nğŸŒ æ‰€æœ‰ç©å®¶å°†ä½¿ç”¨è¿™äº›é…ç½®ï¼\nâ±ï¸ å‚æ•°å°†åœ¨ä¸‹æ¬¡ç”Ÿæˆå…ƒç´ æ—¶ç”Ÿæ•ˆã€‚');
            }
        });
        
        // æ¢å¤é»˜è®¤å‚æ•°
        document.getElementById('reset-game-params-btn').addEventListener('click', async function() {
            if (!confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤å‚æ•°å—ï¼Ÿ\n\nâš ï¸ è¿™å°†å½±å“æ‰€æœ‰ç©å®¶ï¼')) return;
            
            gameSettings = {
                coinSpawnRate: 0.02,
                coinMaxCount: 15,           // é‡‘å¸æœ€å¤§15ä¸ª
                coinLifeTime: 12000,
                diamondSpawnInterval: 100000,
                diamondSpawnCount: 5,       // æ¯æ¬¡ç”Ÿæˆ5ä¸ªé’»çŸ³
                diamondMaxCount: 5,         // é’»çŸ³æœ€å¤§5ä¸ª
                obstacleSpawnRate: 0.005,   // éšœç¢ç‰©ç”Ÿæˆæ¦‚ç‡
                obstacleMaxCount: 6,        // éšœç¢ç‰©æœ€å¤§6ä¸ªï¼ˆé—ªç”µäº‘+å°é¸Ÿï¼‰
                healthPackInterval: 100000,
                healthPackCount: 2,         // æ¯æ¬¡ç”Ÿæˆ2ä¸ªåŠ è¡€åŒ…
                healthPackLifetime: 8000    // åŠ è¡€åŒ…åœç•™8ç§’
            };
            
            loadGameSettings();
            
            // ä¿å­˜åˆ° Supabase æ•°æ®åº“
            const success = await saveGlobalSettings();
            
            if (success) {
                alert('âœ… å·²æ¢å¤é»˜è®¤å‚æ•°å¹¶ä¿å­˜åˆ°äº‘ç«¯ï¼\n\næ–°çš„é»˜è®¤å€¼ï¼š\nğŸª™ é‡‘å¸æœ€å¤š15ä¸ª\nğŸ’ é’»çŸ³é“å…·æœ€å¤š5ä¸ª\nâš¡ éšœç¢ç‰©æœ€å¤š6ä¸ª\nğŸ’Š åŠ è¡€åŒ…æ¯æ¬¡2ä¸ªï¼Œåœç•™8ç§’\n\nğŸŒ æ‰€æœ‰ç©å®¶å·²æ›´æ–°é…ç½®ï¼');
            }
        });
        
        // æ—§çš„startGameå‡½æ•°å·²è¢«ç™»å½•ç³»ç»Ÿæ›¿ä»£ï¼Œä¸å†ä½¿ç”¨
        // ä¿ç•™ä»¥é˜²å…¼å®¹æ€§é—®é¢˜
        async function startGame() {
            console.warn('âš ï¸ æ—§çš„startGameå‡½æ•°è¢«è°ƒç”¨ï¼Œè¯·ä½¿ç”¨æ–°çš„ç™»å½•ç³»ç»Ÿ');
            alert('è¯·ä½¿ç”¨ç™»å½•åŠŸèƒ½ï¼');
        }
        
        // ==================== å¹¿å‘Šä½ç®¡ç†å‡½æ•° ====================
        
        // æ·»åŠ å¹¿å‘Šæ°”çƒ
        async function addAdBalloon() {
            const text = document.getElementById('new-ad-text').value.trim();
            const imageInput = document.getElementById('new-ad-image');
            const x = parseInt(document.getElementById('new-ad-x').value);
            const y = parseInt(document.getElementById('new-ad-y').value);
            const opacity = parseFloat(document.getElementById('new-ad-opacity').value);
            
            if (!text && !imageInput.files[0]) {
                alert('è¯·è‡³å°‘è¾“å…¥å¹¿å‘Šè¯æˆ–ä¸Šä¼ å¹¿å‘Šå›¾ç‰‡ï¼');
                return;
            }
            
            if (adBalloons.length >= 10) {
                alert('æœ€å¤šåªèƒ½æ·»åŠ 10ä¸ªå¹¿å‘Šæ°”çƒï¼');
                return;
            }
            
            // è¯»å–å›¾ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
            if (imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = async function(event) {
                    const adData = {
                        id: Date.now(),
                        text: text,
                        image: event.target.result,
                        x: x,
                        y: y,
                        opacity: opacity
                    };
                    adBalloons.push(adData);
                    const success = await saveAdBalloonsToStorage();
                    refreshAdBalloonsList();
                    
                    // åœ¨æ¸¸æˆä¸­åˆ›å»ºå¹¿å‘Šæ°”çƒ
                    if (gameScene) {
                        createAdBalloonInGame(gameScene, adData);
                    }
                    
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('new-ad-text').value = '';
                    document.getElementById('new-ad-image').value = '';
                    document.getElementById('new-ad-image-preview').classList.remove('show');
                    
                    if (success) {
                        alert('âœ… å¹¿å‘Šæ°”çƒæ·»åŠ æˆåŠŸï¼\n\nğŸŒ æ‰€æœ‰ç©å®¶ç°åœ¨å¯ä»¥çœ‹åˆ°è¿™ä¸ªå¹¿å‘Šï¼');
                    }
                };
                reader.readAsDataURL(imageInput.files[0]);
            } else {
                const adData = {
                    id: Date.now(),
                    text: text,
                    image: null,
                    x: x,
                    y: y,
                    opacity: opacity
                };
                adBalloons.push(adData);
                const success = await saveAdBalloonsToStorage();
                refreshAdBalloonsList();
                
                // åœ¨æ¸¸æˆä¸­åˆ›å»ºå¹¿å‘Šæ°”çƒ
                if (gameScene) {
                    createAdBalloonInGame(gameScene, adData);
                }
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('new-ad-text').value = '';
                
                if (success) {
                    alert('âœ… å¹¿å‘Šæ°”çƒæ·»åŠ æˆåŠŸï¼\n\nğŸŒ æ‰€æœ‰ç©å®¶ç°åœ¨å¯ä»¥çœ‹åˆ°è¿™ä¸ªå¹¿å‘Šï¼');
                }
            }
        }
        
        // åˆ·æ–°å¹¿å‘Šæ°”çƒåˆ—è¡¨
        function refreshAdBalloonsList() {
            const container = document.getElementById('ad-balloons-container');
            
            if (adBalloons.length === 0) {
                container.innerHTML = '<p style="color: rgba(255,255,255,0.6); text-align: center;">æš‚æ— å¹¿å‘Šæ°”çƒ</p>';
                return;
            }
            
            container.innerHTML = '';
            adBalloons.forEach((ad, index) => {
                const item = document.createElement('div');
                item.className = 'ad-balloon-item';
                item.innerHTML = `
                    <h4>ğŸˆ å¹¿å‘Šæ°”çƒ #${index + 1}</h4>
                    <p style="color: rgba(255,255,255,0.9); margin: 5px 0;">å¹¿å‘Šè¯ï¼š${ad.text || 'æ— '}</p>
                    <p style="color: rgba(255,255,255,0.9); margin: 5px 0;">å›¾ç‰‡ï¼š${ad.image ? 'å·²ä¸Šä¼ ' : 'æ— '}</p>
                    <p style="color: rgba(255,255,255,0.9); margin: 5px 0;">ä½ç½®ï¼š(${ad.x}, ${ad.y})</p>
                    <p style="color: rgba(255,255,255,0.9); margin: 5px 0;">é€æ˜åº¦ï¼š${ad.opacity !== undefined ? ad.opacity : 0.9}</p>
                    ${ad.image ? `<img src="${ad.image}" class="image-preview show" alt="å¹¿å‘Šå›¾ç‰‡" />` : ''}
                    <button class="btn-danger" style="width: 100%; margin-top: 10px;" onclick="deleteAdBalloon(${ad.id})">åˆ é™¤</button>
                `;
                container.appendChild(item);
            });
        }
        
        // åˆ é™¤å¹¿å‘Šæ°”çƒ
        async function deleteAdBalloon(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¹¿å‘Šæ°”çƒå—ï¼Ÿ\n\nâš ï¸ è¿™å°†å½±å“æ‰€æœ‰ç©å®¶ï¼')) return;
            
            const index = adBalloons.findIndex(ad => ad.id === id);
            if (index !== -1) {
                adBalloons.splice(index, 1);
                const success = await saveAdBalloonsToStorage();
                refreshAdBalloonsList();
                
                // ä»æ¸¸æˆä¸­ç§»é™¤
                if (adBalloonsObjects[index]) {
                    adBalloonsObjects[index].container.destroy();
                    adBalloonsObjects.splice(index, 1);
                }
                
                if (success) {
                    alert('âœ… å¹¿å‘Šæ°”çƒå·²åˆ é™¤ï¼\n\nğŸŒ æ‰€æœ‰ç©å®¶çš„ç•Œé¢å·²æ›´æ–°ï¼');
                }
            }
        }
        
        // ä¿å­˜å¹¿å‘Šæ°”çƒåˆ°æœ¬åœ°å­˜å‚¨
        async function saveAdBalloonsToStorage() {
            try {
                // ä¿å­˜åˆ° Supabase æ•°æ®åº“
                const success = await saveGlobalSettings();
                if (success) {
                    console.log('âœ… å¹¿å‘Šæ°”çƒæ•°æ®å·²ä¿å­˜åˆ°äº‘ç«¯');
                }
                return success;
            } catch (error) {
                console.error('âŒ ä¿å­˜å¹¿å‘Šæ°”çƒæ•°æ®å¤±è´¥:', error);
                return false;
            }
        }
        
        // æ³¨æ„ï¼šå¹¿å‘Šæ°”çƒæ•°æ®ç°åœ¨ä» Supabase å…¨å±€é…ç½®åŠ è½½
        // ä¸å†ä½¿ç”¨ localStorageï¼Œç¡®ä¿æ‰€æœ‰ç©å®¶çœ‹åˆ°ç›¸åŒçš„å¹¿å‘Š
        function loadAdBalloons() {
            console.log('ğŸ“¢ å¹¿å‘Šæ°”çƒå°†åœ¨ç™»å½•åä» Supabase åŠ è½½');
            // ä¸å†ä» localStorage åŠ è½½ï¼Œç»Ÿä¸€ä» Supabase è·å–
        }
        
        // ==================== Supabase é…ç½® ====================
        // ç”Ÿæˆå½“å‰ç©å®¶çš„å”¯ä¸€ID
        const playerId = 'player_' + Math.random().toString(36).substr(2, 9);
        
        // ç©å®¶åå­—å°†åœ¨ç”¨æˆ·è¾“å…¥åè®¾ç½®
        console.log('ğŸˆ ç©å®¶ ID:', playerId);

        // ==================== ä» Supabase åŠ è½½å…¨å±€é…ç½® ====================
        async function loadGlobalSettings() {
            if (!supabaseClient) {
                console.warn('âš ï¸ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œä½¿ç”¨æœ¬åœ°é»˜è®¤é…ç½®');
                return false;
            }

            try {
                console.log('ğŸ”„ æ­£åœ¨ä» Supabase åŠ è½½å…¨å±€é…ç½®...');
                
                const { data, error } = await supabaseClient
                    .from('global_game_settings')
                    .select('*')
                    .eq('id', 'default')
                    .single();

                if (error) {
                    console.error('âŒ åŠ è½½å…¨å±€é…ç½®å¤±è´¥:', error);
                    return false;
                }

                if (data && data.settings) {
                    const s = data.settings; // ä»settingså­—æ®µè¯»å–
                    
                    // è°ƒè¯•ï¼šæ‰“å°ä»æ•°æ®åº“è¯»å–çš„åŸå§‹æ•°æ®
                    console.log('ğŸ“¥ ä»æ•°æ®åº“è¯»å–çš„åŸå§‹é…ç½®:', JSON.stringify(s, null, 2));
                    console.log('ğŸ” æ•°æ®åº“ä¸­çš„é‡‘å¸æœ€å¤§æ•°é‡ (åŸå§‹):', s.coinMaxCount);
                    
                    // æ›´æ–°æ¸¸æˆè®¾ç½®
                    gameSettings = {
                        coinSpawnRate: parseFloat(s.coinSpawnRate) || 0.02,
                        coinMaxCount: parseInt(s.coinMaxCount) || 15,
                        coinLifeTime: parseInt(s.coinLifeTime) || 12000,
                        diamondSpawnInterval: parseInt(s.diamondSpawnInterval) || 100000,
                        diamondSpawnCount: parseInt(s.diamondSpawnCount) || 5,
                        diamondMaxCount: parseInt(s.diamondMaxCount) || 5,
                        obstacleSpawnRate: parseFloat(s.obstacleSpawnRate) || 0.005,
                        obstacleMaxCount: parseInt(s.obstacleMaxCount) || 6,
                        healthPackInterval: parseInt(s.healthPackInterval) || 100000,
                        healthPackSpawnCount: parseInt(s.healthPackSpawnCount) || 2,
                        healthPackLifeTime: parseInt(s.healthPackLifeTime) || 8000
                    };
                    
                    console.log('âœ… è§£æåçš„æ¸¸æˆè®¾ç½®:', JSON.stringify(gameSettings, null, 2));
                    console.log('ğŸ” è§£æåçš„é‡‘å¸æœ€å¤§æ•°é‡:', gameSettings.coinMaxCount);
                    
                    // æ›´æ–°å¹¿å‘Šæ°”çƒ
                    if (s.adBalloons) {
                        adBalloons = s.adBalloons;
                        console.log('ğŸ“¢ åŠ è½½äº†', adBalloons.length, 'ä¸ªå¹¿å‘Šæ°”çƒ');
                    } else {
                        console.log('ğŸ“¢ æ²¡æœ‰å¹¿å‘Šæ°”çƒæ•°æ®ï¼Œä½¿ç”¨ç©ºæ•°ç»„');
                        adBalloons = [];
                    }
                    
                    // æ›´æ–°æ”¯ä»˜è®¾ç½®
                    if (s.paymentSettings) {
                        paymentSettings = {
                            alipayQRCode: s.paymentSettings.alipayQRCode || null,
                            wechatQRCode: s.paymentSettings.wechatQRCode || null,
                            visaAccountName: s.paymentSettings.visaAccountName || '',
                            visaCardNumber: s.paymentSettings.visaCardNumber || '',
                            mastercardAccountName: s.paymentSettings.mastercardAccountName || '',
                            mastercardCardNumber: s.paymentSettings.mastercardCardNumber || ''
                        };
                        console.log('ğŸ’³ åŠ è½½äº†æ”¯ä»˜è®¾ç½®');
                    } else {
                        console.log('ğŸ’³ æ²¡æœ‰æ”¯ä»˜è®¾ç½®æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼');
                    }
                    
                    console.log('âœ… å…¨å±€é…ç½®åŠ è½½æˆåŠŸï¼');
                    return true;
                } else {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°å…¨å±€é…ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼');
                    return false;
                }
            } catch (error) {
                console.error('âŒ åŠ è½½å…¨å±€é…ç½®å¼‚å¸¸:', error);
                return false;
            }
        }

        // ==================== ä¿å­˜å…¨å±€é…ç½®åˆ° Supabase ====================
        async function saveGlobalSettings() {
            if (!supabaseClient) {
                console.error('âŒ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                alert('âŒ æ— æ³•ä¿å­˜é…ç½®ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥');
                return false;
            }

            try {
                console.log('ğŸ”„ æ­£åœ¨ä¿å­˜å…¨å±€é…ç½®åˆ° Supabase...');
                
                // å‡†å¤‡è¦ä¿å­˜çš„æ•°æ®
                const settingsToSave = {
                    coinSpawnRate: gameSettings.coinSpawnRate,
                    coinMaxCount: gameSettings.coinMaxCount,
                    coinLifeTime: gameSettings.coinLifeTime,
                    diamondSpawnInterval: gameSettings.diamondSpawnInterval,
                    diamondSpawnCount: gameSettings.diamondSpawnCount,
                    diamondMaxCount: gameSettings.diamondMaxCount,
                    obstacleSpawnRate: gameSettings.obstacleSpawnRate,
                    obstacleMaxCount: gameSettings.obstacleMaxCount,
                    healthPackInterval: gameSettings.healthPackInterval,
                    healthPackSpawnCount: gameSettings.healthPackSpawnCount,
                    healthPackLifeTime: gameSettings.healthPackLifeTime,
                    paymentSettings: {
                        alipayQRCode: paymentSettings.alipayQRCode,
                        wechatQRCode: paymentSettings.wechatQRCode,
                        visaAccountName: paymentSettings.visaAccountName,
                        visaCardNumber: paymentSettings.visaCardNumber,
                        mastercardAccountName: paymentSettings.mastercardAccountName,
                        mastercardCardNumber: paymentSettings.mastercardCardNumber
                    },
                    adBalloons: adBalloons
                };
                
                // è°ƒè¯•ï¼šæ‰“å°è¦ä¿å­˜çš„æ•°æ®
                console.log('ğŸ“¦ å‡†å¤‡ä¿å­˜çš„é…ç½®:', JSON.stringify(settingsToSave, null, 2));
                
                const { data, error } = await supabaseClient
                    .from('global_game_settings')
                    .update({
                        settings: settingsToSave,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', 'default')
                    .select(); // æ·»åŠ select()ä»¥è·å–æ›´æ–°åçš„æ•°æ®

                if (error) {
                    console.error('âŒ ä¿å­˜å…¨å±€é…ç½®å¤±è´¥:', error);
                    console.error('âŒ é”™è¯¯è¯¦æƒ…:', JSON.stringify(error, null, 2));
                    alert('âŒ ä¿å­˜é…ç½®å¤±è´¥ï¼š' + error.message);
                    return false;
                }

                console.log('âœ… å…¨å±€é…ç½®å·²ä¿å­˜åˆ°æ•°æ®åº“ï¼');
                console.log('âœ… è¿”å›çš„æ•°æ®:', JSON.stringify(data, null, 2));
                
                // éªŒè¯ä¿å­˜
                if (data && data.length > 0 && data[0].settings) {
                    console.log('âœ… éªŒè¯æˆåŠŸï¼æ•°æ®åº“ä¸­çš„é‡‘å¸æœ€å¤§æ•°é‡:', data[0].settings.coinMaxCount);
                }
                
                return true;
            } catch (error) {
                console.error('âŒ ä¿å­˜å…¨å±€é…ç½®å¼‚å¸¸:', error);
                console.error('âŒ å¼‚å¸¸å †æ ˆ:', error.stack);
                alert('âŒ ä¿å­˜é…ç½®å¼‚å¸¸ï¼š' + error.message);
                return false;
            }
        }

        // ==================== Phaser æ¸¸æˆé…ç½® ====================
        const config = {
            type: Phaser.AUTO,              // è‡ªåŠ¨é€‰æ‹©æ¸²æŸ“å™¨ (WebGL æˆ– Canvas)
            width: 800,                     // æ¸¸æˆç”»å¸ƒå®½åº¦
            height: 600,                    // æ¸¸æˆç”»å¸ƒé«˜åº¦
            parent: 'game-container',       // å°†æ¸¸æˆæŒ‚è½½åˆ°è¿™ä¸ªDOMå…ƒç´ 
            backgroundColor: '#87CEEB',     // èƒŒæ™¯é¢œè‰² (å¤©è“è‰²)
            scale: {
                mode: Phaser.Scale.FIT,     // è‡ªé€‚åº”ç¼©æ”¾æ¨¡å¼ï¼šä¿æŒå®½é«˜æ¯”å¹¶å¡«å……å±å¹•
                autoCenter: Phaser.Scale.CENTER_BOTH,  // å±…ä¸­æ˜¾ç¤º
                width: 800,
                height: 600
            },
            scene: {
                create: create,             // åˆ›å»ºåœºæ™¯æ—¶è°ƒç”¨
                update: update              // æ¯å¸§æ›´æ–°æ—¶è°ƒç”¨
            }
        };

        // åˆ›å»º Phaser æ¸¸æˆå®ä¾‹
        const game = new Phaser.Game(config);

        // æ¸¸æˆå¯¹è±¡å˜é‡
        let balloon;                        // æ°”çƒå®¹å™¨å¯¹è±¡
        let balloonBody;                    // æ°”çƒæœ¬ä½“å›¾å½¢
        let basket;                         // æ°”çƒç¯®å­
        let playerNameText;                 // ç©å®¶åå­—æ–‡æœ¬
        let targetX = 400;                  // æ°”çƒç›®æ ‡Xåæ ‡
        let targetY = 300;                  // æ°”çƒç›®æ ‡Yåæ ‡
        let breatheOffset = 0;              // å‘¼å¸åŠ¨ç”»çš„åç§»é‡
        let clouds = [];                    // äº‘æœµæ•°ç»„
        let previousX = 400;                // è®°å½•æ°”çƒä¸Šä¸€å¸§çš„Xä½ç½®ï¼Œç”¨äºè®¡ç®—å€¾æ–œæ–¹å‘
        let otherPlayers = {};              // å­˜å‚¨å…¶ä»–ç©å®¶çš„æ°”çƒå¯¹è±¡
        let lastUpdateTime = 0;             // ä¸Šæ¬¡å‘é€ä½ç½®æ›´æ–°çš„æ—¶é—´
        const UPDATE_INTERVAL = 100;        // ä½ç½®æ›´æ–°é—´éš”ï¼ˆæ¯«ç§’ï¼‰
        
        // æ¸¸æˆå…ƒç´ 
        let coins = [];                     // é‡‘å¸æ•°ç»„
        let obstacles = [];                 // éšœç¢ç‰©æ•°ç»„
        let score = 0;                      // å½“å‰åˆ†æ•°
        let scoreText;                      // åˆ†æ•°æ˜¾ç¤ºæ–‡æœ¬
        let healthPacks = [];               // åŠ è¡€åŒ…æ•°ç»„
        let playerHealth = 100;             // ç©å®¶ç”Ÿå‘½å€¼
        let maxHealth = 100;                // æœ€å¤§ç”Ÿå‘½å€¼
        let healthText;                     // ç”Ÿå‘½å€¼æ˜¾ç¤ºæ–‡æœ¬
        let diamondsText;                   // é’»çŸ³æ˜¾ç¤ºæ–‡æœ¬
        let diamondItems = [];              // é’»çŸ³é“å…·æ•°ç»„
        let lastDiamondSpawn = 0;           // ä¸Šæ¬¡é’»çŸ³ç”Ÿæˆæ—¶é—´
        let isDead = false;                 // ç©å®¶æ˜¯å¦æ­»äº¡
        let lastHealthPackSpawn = 0;        // ä¸Šæ¬¡åŠ è¡€åŒ…ç”Ÿæˆæ—¶é—´

        // ==================== ç»˜åˆ¶åƒç´ é£çƒ­æ°”çƒå‡½æ•° ====================
        function drawStripedBalloon(graphics) {
            // æ¸…ç©ºä¹‹å‰çš„ç»˜åˆ¶
            graphics.clear();
            
            // çƒ­æ°”çƒå‚æ•°
            const balloonWidth = 50;
            const balloonHeight = 65;
            const stripeCount = 8;  // æ¡çº¹æ•°é‡
            
            // ---------- ç»˜åˆ¶çº¢ç™½ç›¸é—´æ¡çº¹çš„çƒ­æ°”çƒçƒä½“ ----------
            for (let i = 0; i < stripeCount; i++) {
                // è®¡ç®—å½“å‰æ¡çº¹çš„è§’åº¦èŒƒå›´
                const startAngle = (i * Math.PI) / stripeCount - Math.PI / 2;
                const endAngle = ((i + 1) * Math.PI) / stripeCount - Math.PI / 2;
                
                // äº¤æ›¿ä½¿ç”¨çº¢è‰²å’Œç™½è‰²
                const color = i % 2 === 0 ? 0xE63946 : 0xF1FAEE;
                graphics.fillStyle(color, 1);
                
                // ç»˜åˆ¶æ‰‡å½¢æ¡çº¹
                graphics.beginPath();
                graphics.moveTo(0, -10);  // ä»é¡¶éƒ¨ä¸­å¿ƒå¼€å§‹
                
                // ç»˜åˆ¶æ¤­åœ†å¼§çº¿ï¼ˆçƒ­æ°”çƒå½¢çŠ¶ï¼‰
                for (let angle = startAngle; angle <= endAngle; angle += 0.1) {
                    const x = Math.cos(angle) * balloonWidth;
                    const y = Math.sin(angle) * balloonHeight - 10;
                    graphics.lineTo(x, y);
                }
                
                graphics.closePath();
                graphics.fillPath();
            }
            
            // ---------- ç»˜åˆ¶çƒ­æ°”çƒåº•éƒ¨ ----------
            graphics.fillStyle(0x457B9D, 1);  // æ·±è“è‰²åº•åº§
            graphics.fillRect(-balloonWidth, balloonHeight - 10, balloonWidth * 2, 8);
            
            // ---------- ç»˜åˆ¶è¿æ¥ç»³ ----------
            graphics.lineStyle(2, 0x8B4513, 1);  // æ£•è‰²ç»³å­
            
            // å·¦ä¾§ç»³å­
            graphics.beginPath();
            graphics.moveTo(-30, balloonHeight);
            graphics.lineTo(-15, balloonHeight + 25);
            graphics.strokePath();
            
            // å³ä¾§ç»³å­
            graphics.beginPath();
            graphics.moveTo(30, balloonHeight);
            graphics.lineTo(15, balloonHeight + 25);
            graphics.strokePath();
        }
        
        // ==================== ç»˜åˆ¶ç¯®å­å‡½æ•° ====================
        function drawBasket(graphics) {
            graphics.clear();
            
            // ---------- ç»˜åˆ¶ç¯®å­ä¸»ä½“ï¼ˆåƒç´ é£æ ¼ï¼‰----------
            graphics.fillStyle(0x8B4513, 1);  // æ£•è‰²
            graphics.fillRect(-15, 0, 30, 20);
            
            // ç»˜åˆ¶ç¯®å­çº¹ç†ï¼ˆæ¨ªå‘æ¡çº¹ï¼‰
            graphics.lineStyle(2, 0x654321, 1);
            for (let i = 5; i < 20; i += 5) {
                graphics.beginPath();
                graphics.moveTo(-15, i);
                graphics.lineTo(15, i);
                graphics.strokePath();
            }
            
            // ç»˜åˆ¶ç¯®å­è¾¹æ¡†
            graphics.lineStyle(2, 0x5A3A1A, 1);
            graphics.strokeRect(-15, 0, 30, 20);
        }
        
        // ==================== åˆ›å»ºå¹¿å‘Šæ°”çƒå‡½æ•° ====================
        function createAdBalloonInGame(scene, adData) {
            // åˆ›å»ºå®¹å™¨
            const container = scene.add.container(adData.x, adData.y);
            
            // åˆ›å»ºæ°”çƒæœ¬ä½“ï¼ˆæ¯”ç©å®¶æ°”çƒç¨å¤§ï¼‰
            const body = scene.add.graphics();
            drawStripedBalloon(body);
            body.setScale(1.3);  // æ¯”ç©å®¶æ°”çƒå¤§30%
            container.add(body);
            
            // åˆ›å»ºç¯®å­
            const adBasket = scene.add.graphics();
            adBasket.y = 120;  // è°ƒæ•´ä½ç½®ä»¥åŒ¹é…æ”¾å¤§çš„æ°”çƒ
            drawBasket(adBasket);
            adBasket.setScale(1.3);
            container.add(adBasket);
            
            // å¦‚æœæœ‰å¹¿å‘Šè¯ï¼Œåˆ›å»ºæ–‡æœ¬
            if (adData.text) {
                const adText = scene.add.text(
                    0, 0,
                    adData.text,
                    {
                        fontSize: '14px',
                        fontFamily: 'Inter, sans-serif',
                        color: '#FFFFFF',
                        backgroundColor: '#00000099',
                        padding: { x: 10, y: 5 },
                        fontStyle: 'bold',
                        align: 'center',
                        wordWrap: { width: 150 }
                    }
                );
                adText.setOrigin(0.5, 0.5);
                container.add(adText);
            }
            
            // å¦‚æœæœ‰å¹¿å‘Šå›¾ç‰‡ï¼Œåˆ›å»ºå›¾ç‰‡ç²¾çµ
            if (adData.image) {
                // åŠ è½½å›¾ç‰‡
                const textureKey = 'ad_image_' + adData.id;
                scene.textures.addBase64(textureKey, adData.image);
                
                // ç­‰å¾…çº¹ç†åŠ è½½å®Œæˆ
                scene.textures.once('addtexture', function() {
                    const texture = scene.textures.get(textureKey);
                    const frame = texture.get();
                    
                    // è·å–å›¾ç‰‡åŸå§‹å°ºå¯¸
                    const originalWidth = frame.width;
                    const originalHeight = frame.height;
                    
                    // è®¾ç½®ç›®æ ‡æœ€å¤§å°ºå¯¸
                    const maxSize = 120;
                    
                    // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œä¿æŒå®½é«˜æ¯”
                    let scale = 1;
                    if (originalWidth > originalHeight) {
                        // å®½åº¦è¾ƒå¤§ï¼Œä»¥å®½åº¦ä¸ºå‡†
                        scale = maxSize / originalWidth;
                    } else {
                        // é«˜åº¦è¾ƒå¤§ï¼Œä»¥é«˜åº¦ä¸ºå‡†
                        scale = maxSize / originalHeight;
                    }
                    
                    // åˆ›å»ºå›¾ç‰‡
                    const adImage = scene.add.image(0, 50, textureKey);
                    adImage.setScale(scale);  // ä½¿ç”¨è®¡ç®—çš„ç¼©æ”¾æ¯”ä¾‹ï¼Œä¿æŒåŸå§‹æ¯”ä¾‹
                    adImage.setOrigin(0.5, 0.5);
                    
                    // è®¾ç½®å›¾ç‰‡é€æ˜åº¦
                    const imageOpacity = adData.opacity !== undefined ? adData.opacity : 0.9;
                    adImage.setAlpha(imageOpacity);
                    
                    container.add(adImage);
                }, null, textureKey);
            }
            
            // è®¾ç½®é€æ˜åº¦ï¼ˆæ°”çƒæœ¬ä½“çš„é€æ˜åº¦ï¼‰
            const balloonOpacity = adData.opacity !== undefined ? adData.opacity * 0.9 : 0.85;
            container.setAlpha(balloonOpacity);
            
            // è®¾ç½®æ·±åº¦ï¼ˆåœ¨ç©å®¶æ°”çƒä¸‹æ–¹ï¼Œä½†åœ¨é‡‘å¸å’Œéšœç¢ç‰©ä¸Šæ–¹ï¼‰
            // å±‚çº§é¡ºåºï¼šèƒŒæ™¯(0) < äº‘æœµ(1) < å¹¿å‘Šæ°”çƒ(3) < é‡‘å¸/éšœç¢ç‰©(10) < ç©å®¶æ°”çƒ(100)
            container.setDepth(3);
            
            // æ·»åŠ ç¼“æ…¢æ™ƒåŠ¨åŠ¨ç”»
            const swayOffset = Math.random() * Math.PI * 2;  // éšæœºèµ·å§‹ç›¸ä½
            container.swayOffset = swayOffset;
            
            // ä¿å­˜å¹¿å‘Šæ°”çƒå¯¹è±¡
            adBalloonsObjects.push({
                container: container,
                data: adData,
                baseX: adData.x,
                baseY: adData.y,
                swayOffset: swayOffset
            });
            
            console.log('ğŸˆ å¹¿å‘Šæ°”çƒå·²åˆ›å»º:', adData.text, 'é€æ˜åº¦:', adData.opacity);
        }
        
        // åŠ è½½æ‰€æœ‰å¹¿å‘Šæ°”çƒåˆ°æ¸¸æˆä¸­
        function loadAdBalloonsInGame(scene) {
            // æ¸…ç©ºç°æœ‰çš„å¹¿å‘Šæ°”çƒå¯¹è±¡
            adBalloonsObjects.forEach(obj => {
                if (obj.container) {
                    obj.container.destroy();
                }
            });
            adBalloonsObjects = [];
            
            // åŠ è½½æ•°æ®
            loadAdBalloons();
            
            // åˆ›å»ºæ‰€æœ‰å¹¿å‘Šæ°”çƒ
            adBalloons.forEach(adData => {
                createAdBalloonInGame(scene, adData);
            });
        }

        // ==================== åˆ›å»ºé‡‘å¸å‡½æ•° ====================
        function createCoin(scene, x, y) {
            const coin = scene.add.graphics();
            coin.x = x;
            coin.y = y;
            
            // ç»˜åˆ¶é‡‘å¸ï¼ˆåœ†å½¢ï¼Œé‡‘é»„è‰²ï¼‰
            coin.fillStyle(0xFFD700, 1);  // é‡‘è‰²
            coin.fillCircle(0, 0, 15);
            
            // æ·»åŠ å†…åœˆ
            coin.fillStyle(0xFFA500, 1);  // æ©™è‰²
            coin.fillCircle(0, 0, 10);
            
            // æ·»åŠ å…‰æ³½
            coin.fillStyle(0xFFFFAA, 1);
            coin.fillCircle(-4, -4, 4);
            
            // è®¾ç½®æ·±åº¦ï¼ˆåœ¨å¹¿å‘Šæ°”çƒä¸Šæ–¹ï¼Œç©å®¶æ°”çƒä¸‹æ–¹ï¼‰
            coin.setDepth(10);
            
            // æ·»åŠ æ—‹è½¬åŠ¨ç”»
            scene.tweens.add({
                targets: coin,
                scaleX: 0.2,
                duration: 1000,
                yoyo: true,
                repeat: -1,
                ease: 'Sine.easeInOut'
            });
            
            // æ·»åŠ ä¸Šä¸‹æµ®åŠ¨
            scene.tweens.add({
                targets: coin,
                y: y + 10,
                duration: 2000,
                yoyo: true,
                repeat: -1,
                ease: 'Sine.easeInOut'
            });
            
            // 12ç§’åè‡ªåŠ¨æ¶ˆå¤±çš„åŠ¨ç”»
            scene.time.delayedCall(10000, () => {
                // 10ç§’åå¼€å§‹é—ªçƒæç¤ºå³å°†æ¶ˆå¤±
                scene.tweens.add({
                    targets: coin,
                    alpha: 0.3,
                    duration: 300,
                    yoyo: true,
                    repeat: 6,  // é—ªçƒ3æ¬¡
                    onComplete: () => {
                        // æ¶ˆå¤±åŠ¨ç”»
                        scene.tweens.add({
                            targets: coin,
                            alpha: 0,
                            scale: 0,
                            duration: 500,
                            ease: 'Power2',
                            onComplete: () => {
                                if (coin && !coin.destroyed) {
                                    coin.destroy();
                                }
                            }
                        });
                    }
                });
            });
            
            return {
                graphic: coin,
                x: x,
                y: y,
                radius: 15,
                collected: false,
                createTime: Date.now()  // è®°å½•åˆ›å»ºæ—¶é—´
            };
        }
        
        // ==================== åˆ›å»ºéšœç¢ç‰©å‡½æ•° ====================
        function createObstacle(scene, x, y, type) {
            const obstacle = scene.add.graphics();
            obstacle.x = x;
            obstacle.y = y;
            
            // è®¾ç½®æ·±åº¦ï¼ˆåœ¨å¹¿å‘Šæ°”çƒä¸Šæ–¹ï¼Œç©å®¶æ°”çƒä¸‹æ–¹ï¼‰
            obstacle.setDepth(10);
            
            if (type === 'bird') {
                // ç»˜åˆ¶å°é¸Ÿéšœç¢ç‰©ï¼ˆå°é›·ï¼‰
                obstacle.fillStyle(0x8B4513, 1);  // æ£•è‰²
                obstacle.fillEllipse(0, 0, 30, 20);
                
                obstacle.fillStyle(0xFFFFFF, 1);  // ç™½è‰²ç¿…è†€
                obstacle.fillEllipse(-15, 0, 15, 8);
                obstacle.fillEllipse(15, 0, 15, 8);
                
                obstacle.fillStyle(0xFF6B6B, 1);  // çº¢è‰²
                obstacle.fillTriangle(-8, 0, -12, 2, -8, 4);
                
                // é£è¡ŒåŠ¨ç”»
                scene.tweens.add({
                    targets: obstacle,
                    y: y + 20,
                    duration: 1500,
                    yoyo: true,
                    repeat: -1,
                    ease: 'Sine.easeInOut'
                });
            } else if (type === 'cloud') {
                // ç»˜åˆ¶é›·äº‘éšœç¢ç‰©ï¼ˆé—ªç”µäº‘ï¼‰
                obstacle.fillStyle(0x666666, 1);  // ç°è‰²äº‘
                obstacle.fillCircle(0, 0, 25);
                obstacle.fillCircle(-15, 5, 20);
                obstacle.fillCircle(15, 5, 20);
                
                // é—ªç”µæ•ˆæœ
                obstacle.lineStyle(3, 0xFFFF00, 1);
                obstacle.beginPath();
                obstacle.moveTo(0, 20);
                obstacle.lineTo(-5, 30);
                obstacle.lineTo(0, 30);
                obstacle.lineTo(-5, 40);
                obstacle.strokePath();
            }
            
            return {
                graphic: obstacle,
                x: x,
                y: y,
                width: 50,
                height: 40,
                type: type,
                damaged: false  // æ˜¯å¦å·²ç»é€ æˆä¼¤å®³
            };
        }
        
        // ==================== åˆ›å»ºåŠ è¡€åŒ…å‡½æ•° ====================
        function createHealthPack(scene, x, y) {
            const healthPack = scene.add.graphics();
            healthPack.x = x;
            healthPack.y = y;
            
            // ç»˜åˆ¶åŠ è¡€åŒ…ï¼ˆçº¢åå­—ï¼‰
            healthPack.fillStyle(0xFF0000, 1);  // çº¢è‰²
            healthPack.fillRect(-15, -5, 30, 10);  // æ¨ªæ¡
            healthPack.fillRect(-5, -15, 10, 30);  // ç«–æ¡
            
            // æ·»åŠ ç™½è‰²è¾¹æ¡†
            healthPack.lineStyle(2, 0xFFFFFF, 1);
            healthPack.strokeRect(-15, -5, 30, 10);
            healthPack.strokeRect(-5, -15, 10, 30);
            
            // è®¾ç½®æ·±åº¦
            healthPack.setDepth(10);
            
            // æ·»åŠ æ—‹è½¬åŠ¨ç”»
            scene.tweens.add({
                targets: healthPack,
                angle: 360,
                duration: 3000,
                repeat: -1,
                ease: 'Linear'
            });
            
            // æ·»åŠ ä¸Šä¸‹æµ®åŠ¨
            scene.tweens.add({
                targets: healthPack,
                y: y + 15,
                duration: 1500,
                yoyo: true,
                repeat: -1,
                ease: 'Sine.easeInOut'
            });
            
            // æ·»åŠ è„‰å†²æ•ˆæœ
            scene.tweens.add({
                targets: healthPack,
                scaleX: 1.2,
                scaleY: 1.2,
                duration: 800,
                yoyo: true,
                repeat: -1,
                ease: 'Sine.easeInOut'
            });
            
            return {
                graphic: healthPack,
                x: x,
                y: y,
                collected: false,
                createTime: Date.now()
            };
        }
        
        // ==================== åˆ›å»ºé’»çŸ³é“å…·å‡½æ•° ====================
        function createDiamondItem(scene, x, y) {
            const diamond = scene.add.graphics();
            diamond.x = x;
            diamond.y = y;
            
            // ç»˜åˆ¶è“è‰²é’»çŸ³
            diamond.fillStyle(0x00FFFF, 1);  // é’è“è‰²
            diamond.beginPath();
            diamond.moveTo(0, -15);      // é¡¶ç‚¹
            diamond.lineTo(-10, -5);     // å·¦ä¸Š
            diamond.lineTo(-8, 10);      // å·¦ä¸‹
            diamond.lineTo(0, 15);       // åº•ç‚¹
            diamond.lineTo(8, 10);       // å³ä¸‹
            diamond.lineTo(10, -5);      // å³ä¸Š
            diamond.closePath();
            diamond.fillPath();
            
            // æ·»åŠ ç™½è‰²é«˜å…‰
            diamond.fillStyle(0xFFFFFF, 0.6);
            diamond.fillTriangle(-3, -8, 0, -12, 3, -8);
            
            // æ·»åŠ å¤–å‘å…‰æ•ˆæœ
            diamond.lineStyle(2, 0x00FFFF, 0.8);
            diamond.beginPath();
            diamond.moveTo(0, -15);
            diamond.lineTo(-10, -5);
            diamond.lineTo(-8, 10);
            diamond.lineTo(0, 15);
            diamond.lineTo(8, 10);
            diamond.lineTo(10, -5);
            diamond.closePath();
            diamond.strokePath();
            
            // è®¾ç½®æ·±åº¦
            diamond.setDepth(10);
            
            // æ·»åŠ æ—‹è½¬åŠ¨ç”»
            scene.tweens.add({
                targets: diamond,
                angle: 360,
                duration: 2000,
                repeat: -1,
                ease: 'Linear'
            });
            
            // æ·»åŠ ä¸Šä¸‹æµ®åŠ¨
            scene.tweens.add({
                targets: diamond,
                y: y + 20,
                duration: 2000,
                yoyo: true,
                repeat: -1,
                ease: 'Sine.easeInOut'
            });
            
            // æ·»åŠ é—ªçƒæ•ˆæœ
            scene.tweens.add({
                targets: diamond,
                alpha: 0.6,
                duration: 1000,
                yoyo: true,
                repeat: -1,
                ease: 'Sine.easeInOut'
            });
            
            return {
                graphic: diamond,
                x: x,
                y: y,
                collected: false,
                value: 10  // æ¯ä¸ªé’»çŸ³é“å…·+10é’»çŸ³
            };
        }
        
        // ==================== ç”Ÿæˆæ¸¸æˆå…ƒç´ å‡½æ•° ====================
        function spawnGameElements(scene) {
            const now = Date.now();
            
            // éšæœºç”Ÿæˆé‡‘å¸ï¼ˆä½¿ç”¨é…ç½®å‚æ•°ï¼‰
            if (Math.random() < gameSettings.coinSpawnRate) {
                // å¦‚æœè¾¾åˆ°ä¸Šé™ï¼Œéšæœºåˆ é™¤ä¸€ä¸ªæ—§çš„é‡‘å¸
                if (coins.length >= gameSettings.coinMaxCount) {
                    const randomIndex = Math.floor(Math.random() * coins.length);
                    const oldCoin = coins[randomIndex];
                    if (oldCoin.graphic && !oldCoin.graphic.destroyed) {
                        oldCoin.graphic.destroy();
                    }
                    coins.splice(randomIndex, 1);
                    console.log('ğŸ—‘ï¸ åˆ é™¤æ—§é‡‘å¸ï¼Œä¸ºæ–°é‡‘å¸è…¾å‡ºç©ºé—´');
                }
                
                const x = Math.random() * config.width;
                const y = Math.random() * config.height;
                const coin = createCoin(scene, x, y);
                coins.push(coin);
                console.log('ğŸ’° é‡‘å¸ç”Ÿæˆï¼Œå½“å‰æ•°é‡:', coins.length);
            }
            
            // éšæœºç”Ÿæˆéšœç¢ç‰©ï¼ˆä½¿ç”¨é…ç½®å‚æ•°ï¼‰
            if (Math.random() < gameSettings.obstacleSpawnRate) {
                // å¦‚æœè¾¾åˆ°ä¸Šé™ï¼Œéšæœºåˆ é™¤ä¸€ä¸ªæ—§çš„éšœç¢ç‰©
                if (obstacles.length >= gameSettings.obstacleMaxCount) {
                    const randomIndex = Math.floor(Math.random() * obstacles.length);
                    const oldObstacle = obstacles[randomIndex];
                    if (oldObstacle.graphic && !oldObstacle.graphic.destroyed) {
                        oldObstacle.graphic.destroy();
                    }
                    obstacles.splice(randomIndex, 1);
                    console.log('ğŸ—‘ï¸ åˆ é™¤æ—§éšœç¢ç‰©ï¼Œä¸ºæ–°éšœç¢ç‰©è…¾å‡ºç©ºé—´');
                }
                
                const x = Math.random() * config.width;
                const y = Math.random() * (config.height * 0.7) + 50;
                const type = Math.random() > 0.5 ? 'bird' : 'cloud';
                const obstacle = createObstacle(scene, x, y, type);
                obstacles.push(obstacle);
            }
            
            // æŒ‰é…ç½®çš„é—´éš”ç”ŸæˆåŠ è¡€åŒ…ï¼ˆä½¿ç”¨é…ç½®å‚æ•°ï¼‰
            if (now - lastHealthPackSpawn > gameSettings.healthPackInterval && healthPacks.length < gameSettings.healthPackCount) {
                // ç”Ÿæˆé…ç½®æ•°é‡çš„åŠ è¡€åŒ…
                for (let i = 0; i < gameSettings.healthPackCount; i++) {
                    const x = Math.random() * (config.width - 100) + 50;
                    const y = Math.random() * (config.height - 100) + 50;
                    const pack = createHealthPack(scene, x, y);
                    healthPacks.push(pack);
                    console.log('ğŸ’Š åŠ è¡€åŒ…ç”Ÿæˆï¼Œä½ç½®:', x, y);
                }
                lastHealthPackSpawn = now;
            }
            
            // æ¯100ç§’ç”Ÿæˆé’»çŸ³é“å…·ï¼ˆä½¿ç”¨é…ç½®å‚æ•°ï¼‰
            if (now - lastDiamondSpawn > gameSettings.diamondSpawnInterval) {
                // ç”ŸæˆæŒ‡å®šæ•°é‡çš„é’»çŸ³
                for (let i = 0; i < gameSettings.diamondSpawnCount; i++) {
                    // å¦‚æœè¾¾åˆ°ä¸Šé™ï¼Œéšæœºåˆ é™¤ä¸€ä¸ªæ—§çš„é’»çŸ³é“å…·
                    if (diamondItems.length >= gameSettings.diamondMaxCount) {
                        const randomIndex = Math.floor(Math.random() * diamondItems.length);
                        const oldDiamond = diamondItems[randomIndex];
                        if (oldDiamond.graphic && !oldDiamond.graphic.destroyed) {
                            oldDiamond.graphic.destroy();
                        }
                        diamondItems.splice(randomIndex, 1);
                        console.log('ğŸ—‘ï¸ åˆ é™¤æ—§é’»çŸ³é“å…·ï¼Œä¸ºæ–°é’»çŸ³è…¾å‡ºç©ºé—´');
                    }
                    
                    const x = Math.random() * (config.width - 100) + 50;
                    const y = Math.random() * (config.height - 100) + 50;
                    const diamondItem = createDiamondItem(scene, x, y);
                    diamondItems.push(diamondItem);
                    console.log('ğŸ’ é’»çŸ³ç”Ÿæˆï¼Œä½ç½®:', x, y);
                }
                lastDiamondSpawn = now;
            }
        }
        
        // ==================== ç¢°æ’æ£€æµ‹å‡½æ•° ====================
        function checkCollisions() {
            if (!balloon || isDead) return;
            
            // æ£€æµ‹é‡‘å¸ç¢°æ’
            coins.forEach((coin, index) => {
                if (coin.collected) return;
                
                const distance = Phaser.Math.Distance.Between(
                    balloon.x, balloon.y,
                    coin.x, coin.graphic.y
                );
                
                if (distance < 40) {  // ç¢°æ’åŠå¾„
                    // æ”¶é›†é‡‘å¸
                    coin.collected = true;
                    score += 10;
                    totalCoinsCollected += 1;  // ç´¯è®¡é‡‘å¸æ•°
                    updateScore();
                    updateDiamonds();  // æ›´æ–°é’»çŸ³ï¼ˆä¼šè‡ªåŠ¨æ£€æŸ¥å…‘æ¢ï¼‰
                    
                    // é‡‘å¸æ¶ˆå¤±åŠ¨ç”»
                    gameScene.tweens.add({
                        targets: coin.graphic,
                        alpha: 0,
                        scale: 2,
                        duration: 300,
                        onComplete: () => {
                            coin.graphic.destroy();
                            coins.splice(index, 1);
                        }
                    });
                    
                    // æ’­æ”¾éŸ³æ•ˆï¼ˆæ–‡å­—æç¤ºï¼‰
                    showFloatingText(gameScene, balloon.x, balloon.y - 50, '+10åˆ†', 0x00FF00);
                }
            });
            
            // æ£€æµ‹é’»çŸ³é“å…·ç¢°æ’
            diamondItems.forEach((diamondItem, index) => {
                if (diamondItem.collected) return;
                
                const distance = Phaser.Math.Distance.Between(
                    balloon.x, balloon.y,
                    diamondItem.x, diamondItem.graphic.y
                );
                
                if (distance < 40) {  // ç¢°æ’åŠå¾„
                    // æ”¶é›†é’»çŸ³
                    diamondItem.collected = true;
                    gameDiamonds += diamondItem.value;
                    updateDiamonds();
                    
                    // é’»çŸ³æ¶ˆå¤±åŠ¨ç”»
                    gameScene.tweens.add({
                        targets: diamondItem.graphic,
                        alpha: 0,
                        scale: 2,
                        duration: 300,
                        onComplete: () => {
                            diamondItem.graphic.destroy();
                            diamondItems.splice(index, 1);
                        }
                    });
                    
                    showFloatingText(gameScene, balloon.x, balloon.y - 50, '+' + diamondItem.value + ' ğŸ’', 0x00FFFF);
                    
                    // ä¿å­˜é’»çŸ³åˆ°æœ¬åœ°
                    localStorage.setItem('gameDiamonds', gameDiamonds);
                }
            });
            
            // æ£€æµ‹éšœç¢ç‰©ç¢°æ’
            obstacles.forEach(obstacle => {
                if (obstacle.damaged) return;  // å·²ç»é€ æˆè¿‡ä¼¤å®³ï¼Œè·³è¿‡
                
                const distance = Phaser.Math.Distance.Between(
                    balloon.x, balloon.y,
                    obstacle.x, obstacle.graphic.y
                );
                
                if (distance < 60) {  // ç¢°æ’åŠå¾„
                    obstacle.damaged = true;  // æ ‡è®°ä¸ºå·²é€ æˆä¼¤å®³
                    
                    // æ ¹æ®éšœç¢ç‰©ç±»å‹å‡å°‘ç”Ÿå‘½å€¼
                    let damage = 0;
                    if (obstacle.type === 'cloud') {
                        // é›·äº‘é€ æˆ10ç‚¹ä¼¤å®³
                        damage = 10;
                        playerHealth = Math.max(0, playerHealth - 10);
                        showFloatingText(gameScene, balloon.x, balloon.y - 50, '-10 HP', 0xFF0000);
                    } else if (obstacle.type === 'bird') {
                        // å°é¸Ÿé€ æˆ5ç‚¹ä¼¤å®³
                        damage = 5;
                        playerHealth = Math.max(0, playerHealth - 5);
                        showFloatingText(gameScene, balloon.x, balloon.y - 50, '-5 HP', 0xFF6B6B);
                    }
                    
                    updateHealth();
                    
                    // éœ‡åŠ¨æ•ˆæœ
                    gameScene.cameras.main.shake(200, 0.01);
                    
                    // æ£€æŸ¥æ˜¯å¦æ­»äº¡
                    if (playerHealth <= 0) {
                        handlePlayerDeath();
                    }
                    
                    // éšœç¢ç‰©æ¶ˆå¤±
                    setTimeout(() => {
                        if (obstacle.graphic && !obstacle.graphic.destroyed) {
                            obstacle.graphic.destroy();
                        }
                        const idx = obstacles.indexOf(obstacle);
                        if (idx !== -1) {
                            obstacles.splice(idx, 1);
                        }
                    }, 100);
                }
            });
            
            // æ£€æµ‹åŠ è¡€åŒ…ç¢°æ’
            healthPacks.forEach((pack, index) => {
                if (pack.collected) return;
                
                // ä¿®å¤ï¼šä½¿ç”¨graphicçš„xå’Œyï¼ˆå› ä¸ºæœ‰åŠ¨ç”»ï¼Œä½ç½®ä¼šå˜åŒ–ï¼‰
                const distance = Phaser.Math.Distance.Between(
                    balloon.x, balloon.y,
                    pack.graphic.x, pack.graphic.y
                );
                
                if (distance < 50) {  // å¢å¤§ç¢°æ’åŠå¾„ï¼Œæ›´å®¹æ˜“æ”¶é›†
                    // æ”¶é›†åŠ è¡€åŒ…
                    pack.collected = true;
                    playerHealth = Math.min(maxHealth, playerHealth + 20);
                    updateHealth();
                    
                    // åŠ è¡€åŒ…æ¶ˆå¤±åŠ¨ç”»
                    gameScene.tweens.add({
                        targets: pack.graphic,
                        alpha: 0,
                        scale: 2,
                        duration: 300,
                        onComplete: () => {
                            pack.graphic.destroy();
                            healthPacks.splice(index, 1);
                        }
                    });
                    
                    showFloatingText(gameScene, balloon.x, balloon.y - 50, '+20 HP', 0x00FF00);
                    console.log('ğŸ’Š æ”¶é›†åŠ è¡€åŒ…ï¼å½“å‰ç”Ÿå‘½å€¼:', playerHealth);
                }
            });
        }
        
        // ==================== æ˜¾ç¤ºæµ®åŠ¨æ–‡å­—å‡½æ•° ====================
        function showFloatingText(scene, x, y, text, color) {
            const floatText = scene.add.text(x, y, text, {
                fontSize: '24px',
                fontFamily: 'Inter, sans-serif',
                color: '#' + color.toString(16).padStart(6, '0'),
                fontStyle: 'bold'
            });
            floatText.setOrigin(0.5, 0.5);
            
            scene.tweens.add({
                targets: floatText,
                y: y - 50,
                alpha: 0,
                duration: 1000,
                onComplete: () => floatText.destroy()
            });
        }
        
        // ==================== æ›´æ–°åˆ†æ•°æ˜¾ç¤º ====================
        function updateScore() {
            if (scoreText) {
                scoreText.setText('ğŸª™ ' + score);
            }
        }
        
        // ==================== æ›´æ–°ç”Ÿå‘½å€¼æ˜¾ç¤º ====================
        function updateHealth() {
            if (healthText) {
                const healthPercent = (playerHealth / maxHealth) * 100;
                let color = '#00FF00';  // ç»¿è‰²
                if (healthPercent < 30) {
                    color = '#FF0000';  // çº¢è‰²
                } else if (healthPercent < 60) {
                    color = '#FFA500';  // æ©™è‰²
                }
                
                healthText.setText('â¤ï¸ ' + playerHealth + '/' + maxHealth);
                healthText.setStyle({ color: color });
            }
        }
        
        // ==================== æ›´æ–°é’»çŸ³æ˜¾ç¤º ====================
        function updateDiamonds() {
            if (diamondsText) {
                diamondsText.setText('ğŸ’ ' + gameDiamonds);
            }
            
            // ä¿å­˜åˆ°æ•°æ®åº“
            saveUserGameData();
            
            // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç”¨é‡‘å¸å…‘æ¢é’»çŸ³
            checkCoinToDiamondExchange();
        }
        
        // ==================== ä¿å­˜ç”¨æˆ·æ¸¸æˆæ•°æ®åˆ°æ•°æ®åº“ ====================
        async function saveUserGameData() {
            if (!currentUserId) {
                console.warn('âš ï¸ ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•ä¿å­˜åˆ°æ•°æ®åº“');
                // ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ä»½
                localStorage.setItem('gameDiamonds', gameDiamonds);
                localStorage.setItem('totalCoinsCollected', totalCoinsCollected);
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('game_users')
                    .update({
                        diamonds: gameDiamonds,
                        coins_collected: totalCoinsCollected
                    })
                    .eq('id', currentUserId);
                
                if (error) {
                    console.error('âŒ ä¿å­˜ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                } else {
                    console.log('ğŸ’¾ ç”¨æˆ·æ•°æ®å·²ä¿å­˜ - é’»çŸ³:', gameDiamonds, 'é‡‘å¸:', totalCoinsCollected);
                    // åŒæ—¶ä¿å­˜åˆ°localStorage
                    localStorage.setItem('gameDiamonds', gameDiamonds);
                    localStorage.setItem('totalCoinsCollected', totalCoinsCollected);
                }
            } catch (error) {
                console.error('âŒ ä¿å­˜ç”¨æˆ·æ•°æ®å¼‚å¸¸:', error);
            }
        }
        
        // ==================== é‡‘å¸å…‘æ¢é’»çŸ³æ£€æŸ¥ ====================
        function checkCoinToDiamondExchange() {
            if (totalCoinsCollected >= 100) {
                const exchangeCount = Math.floor(totalCoinsCollected / 100);
                totalCoinsCollected = totalCoinsCollected % 100;
                gameDiamonds += exchangeCount;
                updateDiamonds();
                
                // æ˜¾ç¤ºå…‘æ¢æç¤º
                if (gameScene && balloon) {
                    showFloatingText(gameScene, config.width / 2, 100, 'ğŸ’ å…‘æ¢ +' + exchangeCount + ' é’»çŸ³!', 0x00FFFF);
                }
                
                // ä¿å­˜åˆ°æœ¬åœ°
                localStorage.setItem('gameDiamonds', gameDiamonds);
                localStorage.setItem('totalCoinsCollected', totalCoinsCollected);
            }
        }
        
        // ==================== ç©å®¶æ­»äº¡å¤„ç† ====================
        function handlePlayerDeath() {
            if (isDead) return;
            
            isDead = true;
            console.log('ğŸ’€ ç©å®¶æ­»äº¡');
            
            // æ˜¾ç¤ºæ­»äº¡å¼¹çª—
            document.getElementById('death-modal').classList.add('show');
            
            // æ›´æ–°å¤æ´»é€‰é¡¹æ˜¾ç¤º
            document.getElementById('revive-credits-option').textContent = 
                gameDiamonds >= 100 ? 'æ¶ˆè€—100é’»çŸ³å¤æ´» âœ“' : 'æ¶ˆè€—100é’»çŸ³å¤æ´»ï¼ˆä¸è¶³ï¼‰';
            
            if (gameDiamonds >= 100) {
                document.getElementById('revive-credits-btn').disabled = false;
            } else {
                document.getElementById('revive-credits-btn').disabled = true;
            }
        }
        
        // ==================== å¤æ´»ç©å®¶ ====================
        function revivePlayer(method) {
            isDead = false;
            playerHealth = 100;
            updateHealth();
            
            document.getElementById('death-modal').classList.remove('show');
            
            console.log('âœ¨ ç©å®¶å¤æ´»ï¼Œæ–¹å¼:', method);
        }

        // ==================== åˆ›å»ºç™½äº‘å‡½æ•° ====================
        function createCloud(scene, x, y, scale) {
            const cloud = scene.add.graphics();
            cloud.x = x;
            cloud.y = y;
            cloud.setScale(scale);
            
            // ç»˜åˆ¶äº‘æœµï¼ˆå¤šä¸ªåœ†å½¢ç»„åˆï¼‰
            cloud.fillStyle(0xFFFFFF, 0.8);  // ç™½è‰²ï¼Œ80%ä¸é€æ˜åº¦
            cloud.fillCircle(0, 0, 20);
            cloud.fillCircle(-15, 5, 15);
            cloud.fillCircle(15, 5, 15);
            cloud.fillCircle(-8, -8, 12);
            cloud.fillCircle(8, -8, 12);
            
            return cloud;
        }

        // ==================== åˆ›å»ºå…¶ä»–ç©å®¶æ°”çƒå‡½æ•° ====================
        function createOtherPlayerBalloon(scene, data) {
            // åˆ›å»ºå®¹å™¨
            const container = scene.add.container(data.x, data.y);
            
            // åˆ›å»ºæ°”çƒæœ¬ä½“
            const body = scene.add.graphics();
            drawStripedBalloon(body);
            container.add(body);
            
            // åˆ›å»ºç¯®å­
            const playerBasket = scene.add.graphics();
            playerBasket.y = 90;
            drawBasket(playerBasket);
            container.add(playerBasket);
            
            // åˆ›å»ºç©å®¶åå­—æ ‡ç­¾
            const nameText = scene.add.text(
                0, -90,
                data.name,
                {
                    fontSize: '14px',
                    fontFamily: 'Inter, sans-serif',
                    color: '#FFFFFF',
                    backgroundColor: '#00000099',
                    padding: { x: 8, y: 4 },
                    fontStyle: '600'
                }
            );
            nameText.setOrigin(0.5, 0.5);
            container.add(nameText);
            
            // è®¾ç½®é€æ˜åº¦ï¼ˆå…¶ä»–ç©å®¶ç¨å¾®é€æ˜ä¸€ç‚¹ï¼‰
            container.setAlpha(0.8);
            
            // è®¾ç½®æ·±åº¦ï¼ˆå’Œä¸»ç©å®¶æ°”çƒä¸€æ ·ï¼Œåœ¨æœ€é«˜å±‚ï¼‰
            container.setDepth(100);
            
            return {
                container: container,
                targetX: data.x,
                targetY: data.y,
                nameText: nameText
            };
        }

        // ==================== åˆ›å»ºåœºæ™¯å‡½æ•° ====================
        function create() {
            console.log('ğŸ® Phaser åœºæ™¯åˆ›å»ºå®Œæˆ');
            console.log('ğŸ“ gameStarted çŠ¶æ€:', gameStarted);
            console.log('ğŸ‘¤ playerName:', playerName);
            
            // âš ï¸ é‡è¦ï¼šæ— è®ºæ¸¸æˆæ˜¯å¦å¼€å§‹ï¼Œéƒ½è¦ä¿å­˜åœºæ™¯å¼•ç”¨ï¼
            gameScene = this;
            
            // å¦‚æœæ¸¸æˆè¿˜æœªå¼€å§‹ï¼ˆç”¨æˆ·æœªè¾“å…¥åå­—ï¼‰ï¼Œç­‰å¾…
            if (!gameStarted) {
                console.log('â³ ç­‰å¾…ç©å®¶ç™»å½•ååˆå§‹åŒ–æ¸¸æˆ...');
                // åœºæ™¯å·²ä¿å­˜ï¼Œç­‰å¾…startGameAfterLoginè°ƒç”¨initializeGame
                return;
            }
            
            // å¦‚æœå·²ç»æœ‰åå­—ï¼Œç›´æ¥åˆå§‹åŒ–
            console.log('ğŸš€ ç«‹å³å¼€å§‹åˆå§‹åŒ–æ¸¸æˆ...');
            initializeGame.call(this);
        }
        
        // ==================== åˆå§‹åŒ–æ¸¸æˆå‡½æ•° ====================
        function initializeGame() {
            // è·å–å½“å‰åœºæ™¯å¯¹è±¡
            const scene = this;

            // ---------- åˆ›å»ºæ¸å˜èƒŒæ™¯å±‚ ----------
            const bgGraphics = scene.add.graphics();
            // å¤©ç©ºæ¸å˜ï¼ˆä»æ·±è“åˆ°æµ…è“ï¼‰
            bgGraphics.fillGradientStyle(0x5B9BD5, 0x5B9BD5, 0x87CEEB, 0x87CEEB, 1);
            bgGraphics.fillRect(0, 0, config.width, config.height);

            // ---------- åˆ›å»ºéšæœºæ¼‚æµ®çš„ç™½äº‘ ----------
            const cloudCount = 6;  // äº‘æœµæ•°é‡
            for (let i = 0; i < cloudCount; i++) {
                const x = Math.random() * config.width;
                const y = Math.random() * (config.height * 0.4) + 50;  // äº‘æœµåœ¨ä¸ŠåŠéƒ¨åˆ†
                const scale = Math.random() * 0.5 + 0.5;  // éšæœºç¼©æ”¾ 0.5-1.0
                const speed = Math.random() * 0.3 + 0.1;  // éšæœºé€Ÿåº¦
                
                const cloud = createCloud(scene, x, y, scale);
                clouds.push({ graphic: cloud, speed: speed });
            }

            // ---------- åˆ›å»ºåƒç´ é£çƒ­æ°”çƒ ----------
            // åˆ›å»ºå®¹å™¨æ¥åŒ…å«æ°”çƒæ‰€æœ‰éƒ¨åˆ†
            balloon = scene.add.container(config.width / 2, config.height / 2);
            
            // åˆ›å»ºæ°”çƒæœ¬ä½“
            balloonBody = scene.add.graphics();
            drawStripedBalloon(balloonBody);
            balloon.add(balloonBody);
            
            // åˆ›å»ºç¯®å­ï¼ˆä½ç½®åœ¨æ°”çƒä¸‹æ–¹ï¼‰
            basket = scene.add.graphics();
            basket.y = 90;  // ç¯®å­åœ¨æ°”çƒä¸‹æ–¹90åƒç´ 
            drawBasket(basket);
            balloon.add(basket);
            
            // åˆ›å»ºç©å®¶åå­—æ ‡ç­¾ï¼ˆåœ¨æ°”çƒä¸Šæ–¹ï¼‰
            playerNameText = scene.add.text(
                0, -90,
                playerName,
                {
                    fontSize: '16px',
                    fontFamily: 'Inter, sans-serif',
                    color: '#FFD700',  // é‡‘è‰²
                    backgroundColor: '#000000CC',
                    padding: { x: 10, y: 5 },
                    fontStyle: 'bold'
                }
            );
            playerNameText.setOrigin(0.5, 0.5);
            balloon.add(playerNameText);
            
            // è®¾ç½®ç©å®¶æ°”çƒçš„æ·±åº¦ï¼ˆæœ€é«˜å±‚ï¼Œç¡®ä¿ä¸è¢«é®æŒ¡ï¼‰
            balloon.setDepth(100);
            
            // ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼Œç”¨äºæ›´æ”¹åå­—æ—¶æ›´æ–°
            playerNameTextObject = playerNameText;

            // ---------- åˆ›å»ºåˆ†æ•°æ˜¾ç¤º ----------
            scoreText = scene.add.text(
                20, 20,
                'ğŸª™ 0',
                {
                    fontSize: '20px',
                    fontFamily: 'Inter, sans-serif',
                    color: '#FFD700',
                    backgroundColor: '#00000099',
                    padding: { x: 12, y: 6 },
                    fontStyle: 'bold'
                }
            );
            scoreText.setScrollFactor(0);
            scoreText.setDepth(1000);
            
            // ---------- åˆ›å»ºç”Ÿå‘½å€¼æ˜¾ç¤º ----------
            healthText = scene.add.text(
                20, 55,
                'â¤ï¸ 100/100',
                {
                    fontSize: '20px',
                    fontFamily: 'Inter, sans-serif',
                    color: '#00FF00',
                    backgroundColor: '#00000099',
                    padding: { x: 12, y: 6 },
                    fontStyle: 'bold'
                }
            );
            healthText.setScrollFactor(0);
            healthText.setDepth(1000);
            
            // ---------- åˆ›å»ºé’»çŸ³æ˜¾ç¤º ----------
            diamondsText = scene.add.text(
                20, 90,
                'ğŸ’ 0',
                {
                    fontSize: '20px',
                    fontFamily: 'Inter, sans-serif',
                    color: '#00FFFF',
                    backgroundColor: '#00000099',
                    padding: { x: 12, y: 6 },
                    fontStyle: 'bold'
                }
            );
            diamondsText.setScrollFactor(0);
            diamondsText.setDepth(1000);
            
            // æ›´æ–°é’»çŸ³æ˜¾ç¤ºï¼ˆä½¿ç”¨å·²ç™»å½•ç”¨æˆ·çš„æ•°æ®ï¼‰
            updateDiamonds();

            // è®¾ç½®åˆå§‹ç›®æ ‡ä½ç½®ä¸ºå½“å‰ä½ç½®
            targetX = balloon.x;
            targetY = balloon.y;
            previousX = balloon.x;
            
            // åˆå§‹åŒ–åŠ è¡€åŒ…å’Œé’»çŸ³ç”Ÿæˆæ—¶é—´
            lastHealthPackSpawn = Date.now();
            lastDiamondSpawn = Date.now();

            // ---------- æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬ ----------
            scene.input.on('pointerdown', function(pointer) {
                // å½“ç©å®¶ç‚¹å‡»å±å¹•æ—¶ï¼Œæ›´æ–°ç›®æ ‡ä½ç½®
                targetX = pointer.x;
                targetY = pointer.y;
                
                // å‘é€ä½ç½®æ›´æ–°åˆ° Supabase
                sendPositionUpdate(pointer.x, pointer.y);
                
                // ç‚¹å‡»ä½ç½®åé¦ˆæ•ˆæœï¼ˆä¼˜åŒ–ç‰ˆï¼‰
                const marker = scene.add.circle(pointer.x, pointer.y, 8, 0xFFFFFF, 0.6);
                const outerRing = scene.add.circle(pointer.x, pointer.y, 8, 0xFFFFFF, 0);
                outerRing.setStrokeStyle(2, 0xFFFFFF, 0.8);
                
                scene.tweens.add({
                    targets: marker,
                    alpha: 0,
                    scale: 1.5,
                    duration: 400,
                    ease: 'Power2',
                    onComplete: () => marker.destroy()
                });
                
                scene.tweens.add({
                    targets: outerRing,
                    alpha: 0,
                    scale: 3,
                    duration: 600,
                    ease: 'Power2',
                    onComplete: () => outerRing.destroy()
                });
            });

            // ---------- åˆ›å»ºé‡‘é—ªé—ªå¹¿å‘Šä½å¡ç‰‡ ----------
            // å¤–å±‚å…‰æ™•å®¹å™¨
            const adGlowOuter = scene.add.graphics();
            const adGlowMiddle = scene.add.graphics();
            
            // ç»˜åˆ¶å¤šå±‚é‡‘è‰²å…‰æ™•
            adGlowOuter.lineStyle(4, 0xFFD700, 0.3);
            adGlowOuter.strokeRoundedRect(config.width - 245, 10, 230, 70, 15);
            
            adGlowMiddle.lineStyle(3, 0xFFA500, 0.5);
            adGlowMiddle.strokeRoundedRect(config.width - 243, 12, 226, 66, 14);
            
            // åŠé€æ˜èƒŒæ™¯
            const adBg = scene.add.graphics();
            adBg.fillStyle(0xFFFFFF, 0.15);  // ç™½è‰²åŠé€æ˜
            adBg.fillRoundedRect(config.width - 240, 15, 220, 60, 12);
            
            // é‡‘è‰²è¾¹æ¡†
            adBg.lineStyle(2, 0xFFD700, 0.8);
            adBg.strokeRoundedRect(config.width - 240, 15, 220, 60, 12);
            
            // å†…éƒ¨é‡‘é»„è‰²èƒŒæ™¯
            const adInner = scene.add.graphics();
            adInner.fillStyle(0xFFC107, 0.9);  // é‡‘é»„è‰²ï¼Œ90%ä¸é€æ˜åº¦
            adInner.fillRoundedRect(config.width - 235, 20, 210, 50, 10);

            // å¹¿å‘Šä½æ–‡å­—ï¼ˆç°ä»£å­—ä½“ï¼‰
            const adText = scene.add.text(
                config.width - 130,
                42,
                'ğŸ’ å¹¿å‘Šä½æ‹›ç§Ÿ',
                {
                    fontSize: '18px',
                    fontFamily: 'Inter, sans-serif',
                    color: '#1A1A1A',
                    fontStyle: 'bold'
                }
            );
            adText.setOrigin(0.5, 0.5);
            
            // ä»·æ ¼æ–‡å­—
            const priceText = scene.add.text(
                config.width - 130,
                60,
                '$5,000',
                {
                    fontSize: '16px',
                    fontFamily: 'Inter, sans-serif',
                    color: '#D4AF37',  // é‡‘è‰²
                    fontStyle: 'bold'
                }
            );
            priceText.setOrigin(0.5, 0.5);

            // æ·»åŠ é—ªçƒåŠ¨ç”»åˆ°å¹¿å‘Šä½ï¼ˆé‡‘è‰²å…‰æ™•æ•ˆæœï¼‰
            scene.tweens.add({
                targets: [adGlowOuter],
                alpha: 0.1,
                duration: 1500,
                yoyo: true,
                repeat: -1,
                ease: 'Sine.easeInOut'
            });
            
            scene.tweens.add({
                targets: [adGlowMiddle],
                alpha: 0.2,
                duration: 1000,
                yoyo: true,
                repeat: -1,
                ease: 'Sine.easeInOut'
            });
            
            scene.tweens.add({
                targets: [adInner],
                alpha: 0.75,
                duration: 2000,
                yoyo: true,
                repeat: -1,
                ease: 'Sine.easeInOut'
            });

            // ---------- æ·»åŠ æ“ä½œæç¤ºæ–‡å­—ï¼ˆä¼˜åŒ–ç‰ˆï¼Œå®Œå…¨å±…ä¸­ï¼Œå“åº”å¼ï¼‰----------
            const hintBg = scene.add.graphics();
            hintBg.fillStyle(0x000000, 0.5);
            // ä½¿ç”¨æ¸¸æˆç”»å¸ƒçš„ä¸­å¿ƒç‚¹ï¼Œç¡®ä¿åœ¨æ‰€æœ‰è®¾å¤‡ä¸Šéƒ½å±…ä¸­
            const hintWidth = 360;
            const hintHeight = 38;
            const hintX = config.width / 2 - hintWidth / 2;
            const hintY = config.height - 50;
            hintBg.fillRoundedRect(hintX, hintY, hintWidth, hintHeight, 10);
            hintBg.setScrollFactor(0);  // å›ºå®šä½ç½®ï¼Œä¸éšç›¸æœºç§»åŠ¨
            hintBg.setDepth(1000);      // ç¡®ä¿åœ¨æœ€ä¸Šå±‚
            
            const hintText = scene.add.text(
                config.width / 2,  // Xåæ ‡ï¼šç”»å¸ƒå®½åº¦çš„ä¸€åŠ
                config.height - 31, // Yåæ ‡ï¼šè·ç¦»åº•éƒ¨31åƒç´ 
                'ğŸˆ ç‚¹å‡»å±å¹•é£è¡Œ | å¤šäººå®æ—¶åŒæ­¥',
                {
                    fontSize: '16px',
                    fontFamily: 'Inter, sans-serif',
                    color: '#FFFFFF',
                    fontStyle: '600',
                    align: 'center'
                }
            );
            hintText.setOrigin(0.5, 0.5);   // è®¾ç½®æ–‡å­—é”šç‚¹ä¸ºä¸­å¿ƒï¼ˆå…³é”®ï¼ï¼‰
            hintText.setScrollFactor(0);     // å›ºå®šä½ç½®ï¼Œä¸éšç›¸æœºç§»åŠ¨
            hintText.setDepth(1001);         // ç¡®ä¿æ–‡å­—åœ¨èƒŒæ™¯ä¸Šæ–¹
            
            // ---------- åˆå§‹åŒ– Supabase å®æ—¶è¿æ¥ ----------
            initSupabaseRealtime(scene);
            
            // å‘é€åˆå§‹ä½ç½®
            sendPositionUpdate(balloon.x, balloon.y);
            
            // ---------- åŠ è½½å¹¿å‘Šæ°”çƒ ----------
            loadAdBalloonsInGame(scene);
        }  // initializeGame å‡½æ•°ç»“æŸ
        
        // ==================== Supabase å®æ—¶åŒæ­¥å‡½æ•° ====================
        
        // å‘é€ä½ç½®æ›´æ–°åˆ° Supabase
        async function sendPositionUpdate(x, y) {
            // å¦‚æœ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œè·³è¿‡
            if (!supabaseClient) {
                console.warn('âš ï¸ Supabase æœªåˆå§‹åŒ–ï¼Œè·³è¿‡ä½ç½®æ›´æ–°');
                return;
            }
            
            if (!playerName) {
                console.warn('âš ï¸ ç©å®¶åå­—æœªè®¾ç½®ï¼Œè·³è¿‡ä½ç½®æ›´æ–°');
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('balloon_positions')
                    .upsert({
                        player_id: playerId,
                        player_name: playerName,
                        x: Math.round(x),
                        y: Math.round(y),
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'player_id'
                    });
                
                if (error) {
                    console.error('âŒ å‘é€ä½ç½®å¤±è´¥:', error.message);
                } else {
                    console.log('âœ… ä½ç½®å·²å‘é€:', playerName, x, y);
                }
            } catch (err) {
                console.error('âŒ å‘é€ä½ç½®å¼‚å¸¸:', err);
            }
        }
        
        // åˆå§‹åŒ– Supabase å®æ—¶ç›‘å¬
        function initSupabaseRealtime(scene) {
            // å¦‚æœ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œè·³è¿‡
            if (!supabaseClient) {
                console.warn('âš ï¸ Supabase æœªåˆå§‹åŒ–ï¼Œæ¸¸æˆå°†ä»¥å•æœºæ¨¡å¼è¿è¡Œ');
                return;
            }
            
            console.log('ğŸ”Œ åˆå§‹åŒ– Supabase Realtime è¿æ¥...');
            
            try {
                // è®¢é˜… balloon_positions è¡¨çš„å˜åŒ–
                const channel = supabaseClient
                    .channel('balloon_positions_channel')
                    .on(
                        'postgres_changes',
                        {
                            event: '*',  // ç›‘å¬æ‰€æœ‰äº‹ä»¶ï¼ˆINSERT, UPDATE, DELETEï¼‰
                            schema: 'public',
                            table: 'balloon_positions'
                        },
                        (payload) => {
                            handleRealtimeUpdate(scene, payload);
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            console.log('âœ… Realtime è¿æ¥æˆåŠŸï¼');
                            // åŠ è½½ç°æœ‰ç©å®¶
                            loadExistingPlayers(scene);
                        } else if (status === 'CHANNEL_ERROR') {
                            console.error('âŒ Realtime è¿æ¥å¤±è´¥ï¼è¯·æ£€æŸ¥ Supabase é…ç½®');
                        }
                    });
                
                // å®šæœŸæ¸…ç†ç¦»çº¿ç©å®¶ï¼ˆè¶…è¿‡10ç§’æœªæ›´æ–°ï¼‰
                setInterval(() => {
                    cleanupInactivePlayers(scene);
                }, 5000);
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ– Realtime å¤±è´¥:', error);
            }
        }
        
        // å¤„ç†å®æ—¶æ›´æ–°
        function handleRealtimeUpdate(scene, payload) {
            const { eventType, new: newRecord, old: oldRecord } = payload;
            
            // ç¡®ä¿ä½¿ç”¨å…¨å±€çš„gameSceneï¼Œè€Œä¸æ˜¯ä¼ å…¥çš„sceneå‚æ•°
            const actualScene = gameScene || scene;
            
            if (!actualScene) {
                console.warn('âš ï¸ åœºæ™¯æœªåˆå§‹åŒ–ï¼Œå¿½ç•¥å®æ—¶æ›´æ–°');
                return;
            }
            
            if (eventType === 'INSERT' || eventType === 'UPDATE') {
                const data = newRecord;
                
                // å¿½ç•¥è‡ªå·±çš„æ›´æ–°
                if (data.player_id === playerId) {
                    console.log('ğŸ”„ æ”¶åˆ°è‡ªå·±çš„ä½ç½®æ›´æ–°ï¼Œå¿½ç•¥');
                    return;
                }
                
                console.log('ğŸ“¡ æ”¶åˆ°å…¶ä»–ç©å®¶ä½ç½®:', data.player_name, data.x, data.y, 'PlayerId:', data.player_id);
                
                // å¦‚æœæ˜¯æ–°ç©å®¶ï¼Œåˆ›å»ºæ°”çƒ
                if (!otherPlayers[data.player_id]) {
                    console.log('ğŸˆ åˆ›å»ºæ–°ç©å®¶æ°”çƒ:', data.player_name);
                    otherPlayers[data.player_id] = createOtherPlayerBalloon(actualScene, {
                        x: data.x,
                        y: data.y,
                        name: data.player_name
                    });
                    console.log('âœ… æ–°ç©å®¶åŠ å…¥æˆåŠŸ:', data.player_name, 'å½“å‰å…¶ä»–ç©å®¶æ•°:', Object.keys(otherPlayers).length);
                } else {
                    // æ›´æ–°ç°æœ‰ç©å®¶çš„ç›®æ ‡ä½ç½®
                    otherPlayers[data.player_id].targetX = data.x;
                    otherPlayers[data.player_id].targetY = data.y;
                    console.log('ğŸ”„ æ›´æ–°ç©å®¶ä½ç½®:', data.player_name, data.x, data.y);
                }
                
                // æ›´æ–°æœ€åæ´»è·ƒæ—¶é—´
                otherPlayers[data.player_id].lastUpdate = Date.now();
            } else if (eventType === 'DELETE') {
                const data = oldRecord;
                if (otherPlayers[data.player_id]) {
                    otherPlayers[data.player_id].container.destroy();
                    delete otherPlayers[data.player_id];
                    console.log('ğŸ‘‹ ç©å®¶ç¦»å¼€:', data.player_name);
                }
            }
        }
        
        // åŠ è½½ç°æœ‰ç©å®¶
        async function loadExistingPlayers(scene) {
            if (!supabaseClient) return;
            
            try {
                // åªåŠ è½½æœ€è¿‘2åˆ†é’Ÿå†…æ´»è·ƒçš„ç©å®¶
                const twoMinutesAgo = new Date(Date.now() - 2 * 60 * 1000).toISOString();
                
                const { data, error } = await supabaseClient
                    .from('balloon_positions')
                    .select('*')
                    .neq('player_id', playerId)
                    .gte('updated_at', twoMinutesAgo)  // åªåŠ è½½2åˆ†é’Ÿå†…æ›´æ–°çš„ç©å®¶
                    .order('updated_at', { ascending: false })
                    .limit(10);  // æœ€å¤šæ˜¾ç¤º10ä¸ªå…¶ä»–ç©å®¶
                
                if (error) {
                    console.error('âŒ åŠ è½½ç°æœ‰ç©å®¶å¤±è´¥:', error.message);
                    return;
                }
                
                if (data && data.length > 0) {
                    console.log('ğŸ‘¥ åŠ è½½æ´»è·ƒç©å®¶:', data.length, 'äºº');
                    data.forEach(player => {
                        if (!otherPlayers[player.player_id]) {
                            otherPlayers[player.player_id] = createOtherPlayerBalloon(scene, {
                                x: player.x,
                                y: player.y,
                                name: player.player_name
                            });
                            otherPlayers[player.player_id].lastUpdate = Date.now();
                        }
                    });
                } else {
                    console.log('ğŸ‘¥ å½“å‰æ²¡æœ‰å…¶ä»–æ´»è·ƒç©å®¶');
                }
                
                // æ¸…ç†æ•°æ®åº“ä¸­è¶…è¿‡5åˆ†é’Ÿçš„æ—§æ•°æ®
                cleanupOldDataInDatabase();
            } catch (err) {
                console.error('âŒ åŠ è½½ç°æœ‰ç©å®¶å¼‚å¸¸:', err);
            }
        }
        
        // æ¸…ç†ä¸æ´»è·ƒçš„ç©å®¶
        async function cleanupInactivePlayers(scene) {
            const now = Date.now();
            const TIMEOUT = 10000;  // 10ç§’è¶…æ—¶
            
            for (const playerId in otherPlayers) {
                if (now - otherPlayers[playerId].lastUpdate > TIMEOUT) {
                    console.log('ğŸ—‘ï¸ æ¸…ç†ä¸æ´»è·ƒç©å®¶:', playerId);
                    otherPlayers[playerId].container.destroy();
                    delete otherPlayers[playerId];
                }
            }
        }
        
        // æ¸…ç†æ•°æ®åº“ä¸­çš„æ—§æ•°æ®
        async function cleanupOldDataInDatabase() {
            if (!supabaseClient) return;
            
            try {
                // åˆ é™¤5åˆ†é’Ÿå‰çš„æ—§æ•°æ®
                const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
                
                const { error } = await supabaseClient
                    .from('balloon_positions')
                    .delete()
                    .lt('updated_at', fiveMinutesAgo);
                
                if (error) {
                    console.error('âŒ æ¸…ç†æ—§æ•°æ®å¤±è´¥:', error.message);
                } else {
                    console.log('ğŸ§¹ å·²æ¸…ç†5åˆ†é’Ÿå‰çš„æ—§æ•°æ®');
                }
            } catch (err) {
                console.error('âŒ æ¸…ç†æ—§æ•°æ®å¼‚å¸¸:', err);
            }
        }

        // ==================== æ›´æ–°åœºæ™¯å‡½æ•°ï¼ˆæ¯å¸§è°ƒç”¨ï¼‰====================
        function update(time, delta) {
            // ========== å…³é”®ä¿®å¤ï¼šæ£€æŸ¥æ¸¸æˆæ˜¯å¦å·²åˆå§‹åŒ– ==========
            // å¦‚æœæ°”çƒå¯¹è±¡è¿˜æœªåˆ›å»ºï¼Œè¯´æ˜æ¸¸æˆæœªåˆå§‹åŒ–å®Œæˆï¼Œç›´æ¥è¿”å›
            if (!balloon) {
                return;
            }
            
            // ---------- æ›´æ–°ç™½äº‘ä½ç½®ï¼ˆç¼“æ…¢æ¨ªå‘ç§»åŠ¨ï¼‰----------
            clouds.forEach(cloud => {
                cloud.graphic.x += cloud.speed;
                
                // å¦‚æœäº‘æœµç§»å‡ºå±å¹•å³ä¾§ï¼Œåˆ™ä»å·¦ä¾§é‡æ–°è¿›å…¥
                if (cloud.graphic.x > config.width + 100) {
                    cloud.graphic.x = -100;
                    cloud.graphic.y = Math.random() * (config.height * 0.4) + 50;
                }
            });

            // ---------- å‘¼å¸æµ®åŠ¨æ•ˆæœ ----------
            // ä½¿ç”¨æ­£å¼¦å‡½æ•°åˆ›å»ºå¹³æ»‘çš„ä¸Šä¸‹æµ®åŠ¨æ•ˆæœ
            breatheOffset += 0.015;  // æ§åˆ¶å‘¼å¸é€Ÿåº¦ï¼ˆç¨å¾®æ…¢ä¸€ç‚¹æ›´ä¼˜é›…ï¼‰
            const breatheY = Math.sin(breatheOffset) * 8;  // æŒ¯å¹…ä¸º8åƒç´ 
            const breatheScale = 1 + Math.sin(breatheOffset) * 0.03;  // ç¼©æ”¾å˜åŒ– (0.97-1.03)

            // ---------- å¹³æ»‘ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½® ----------
            // è®¡ç®—æ°”çƒå½“å‰ä½ç½®ä¸ç›®æ ‡ä½ç½®çš„è·ç¦»
            const dx = targetX - balloon.x;
            const dy = targetY - balloon.y;
            const distance = Math.sqrt(dx * dx + dy * dy);

            // å¦‚æœè·ç¦»å¤§äº1åƒç´ ï¼Œåˆ™ç»§ç»­ç§»åŠ¨
            if (distance > 1) {
                // ä½¿ç”¨ç¼“åŠ¨æ•ˆæœï¼šæ¯å¸§ç§»åŠ¨è·ç¦»çš„4%ï¼ˆç¨æ…¢ä¸€ç‚¹æ›´ä¼˜é›…ï¼‰
                const easing = 0.04;
                balloon.x += dx * easing;
                balloon.y += dy * easing;
                
                // å®šæœŸå‘é€ä½ç½®æ›´æ–°ï¼ˆèŠ‚æµï¼‰
                if (time - lastUpdateTime > UPDATE_INTERVAL) {
                    sendPositionUpdate(balloon.x, balloon.y);
                    lastUpdateTime = time;
                }
            }

            // ---------- è®¡ç®—å€¾æ–œè§’åº¦ï¼ˆçµåŠ¨æ•ˆæœï¼‰----------
            // æ ¹æ®ç§»åŠ¨æ–¹å‘è®¡ç®—å€¾æ–œè§’åº¦
            const velocityX = balloon.x - previousX;
            previousX = balloon.x;
            
            // ç›®æ ‡å€¾æ–œè§’åº¦ï¼šå‘å·¦é£æ—¶è´Ÿè§’åº¦ï¼Œå‘å³é£æ—¶æ­£è§’åº¦
            const targetRotation = velocityX * 0.1;  // å€¾æ–œå¹…åº¦ç³»æ•°
            
            // å¹³æ»‘è¿‡æ¸¡åˆ°ç›®æ ‡è§’åº¦
            const currentRotation = balloon.angle * (Math.PI / 180);  // è½¬æ¢ä¸ºå¼§åº¦
            const targetRad = Phaser.Math.Clamp(targetRotation, -0.15, 0.15);  // é™åˆ¶æœ€å¤§å€¾æ–œè§’åº¦
            
            // ä½¿ç”¨çº¿æ€§æ’å€¼å¹³æ»‘è¿‡æ¸¡
            balloon.angle = Phaser.Math.Linear(balloon.angle, targetRad * (180 / Math.PI), 0.1);

            // ---------- åº”ç”¨å‘¼å¸æ•ˆæœ ----------
            // æ·»åŠ è½»å¾®çš„å‚ç›´æµ®åŠ¨
            const baseY = balloon.y;
            balloon.y = baseY + breatheY * 0.5;

            // åº”ç”¨ç¼©æ”¾æ•ˆæœï¼ˆæ¨¡æ‹Ÿçƒ­æ°”çƒçš„"å‘¼å¸"ï¼‰
            balloon.setScale(breatheScale);
            
            // ---------- ç”Ÿæˆæ¸¸æˆå…ƒç´  ----------
            spawnGameElements(this);
            
            // ---------- æ£€æµ‹ç¢°æ’ ----------
            checkCollisions();
            
            // ---------- æ£€æŸ¥ç”Ÿå‘½å€¼ï¼ˆæ¯å¸§æ£€æŸ¥ï¼Œé˜²æ­¢é—æ¼ï¼‰----------
            if (!isDead && playerHealth <= 0) {
                handlePlayerDeath();
            }
            
            // ---------- æ¸…ç†è¶…å‡ºå±å¹•çš„å…ƒç´ å’Œè¿‡æœŸé‡‘å¸ ----------
            const now = Date.now();
            coins = coins.filter(coin => {
                if (coin.collected) return false;
                
                // æ£€æŸ¥æ˜¯å¦è¶…å‡ºå±å¹•
                const outOfBounds = coin.x < -50 || coin.x > config.width + 50 || 
                                   coin.y < -50 || coin.y > config.height + 50;
                
                // æ£€æŸ¥æ˜¯å¦è¶…è¿‡12ç§’ï¼ˆé‡‘å¸ä¼šåœ¨10ç§’åå¼€å§‹é—ªçƒï¼Œ12ç§’åæ¶ˆå¤±ï¼‰
                const isExpired = (now - coin.createTime) > 12000;
                
                // æ£€æŸ¥é‡‘å¸å›¾å½¢æ˜¯å¦å·²è¢«é”€æ¯
                const isDestroyed = !coin.graphic || coin.graphic.destroyed;
                
                if ((outOfBounds || isExpired || isDestroyed) && coin.graphic && !coin.graphic.destroyed) {
                    coin.graphic.destroy();
                }
                
                return !outOfBounds && !isExpired && !isDestroyed;
            });
            
            obstacles = obstacles.filter(obstacle => {
                const outOfBounds = obstacle.x < -100 || obstacle.x > config.width + 100;
                if (outOfBounds && obstacle.graphic && !obstacle.graphic.destroyed) {
                    obstacle.graphic.destroy();
                }
                return !outOfBounds;
            });
            
            // æ¸…ç†å·²æ”¶é›†çš„åŠ è¡€åŒ…å’Œè¿‡æœŸåŠ è¡€åŒ…
            healthPacks = healthPacks.filter(pack => {
                if (pack.collected) return false;
                
                // æ£€æŸ¥æ˜¯å¦è¶…è¿‡åœç•™æ—¶é—´
                const isExpired = (now - pack.createTime) > gameSettings.healthPackLifetime;
                
                // è¶…è¿‡åœç•™æ—¶é—´çš„å‰1ç§’å¼€å§‹é—ªçƒè­¦å‘Š
                const timeRemaining = gameSettings.healthPackLifetime - (now - pack.createTime);
                if (timeRemaining > 0 && timeRemaining < 1000 && !pack.flashing) {
                    pack.flashing = true;
                    // æ·»åŠ é—ªçƒåŠ¨ç”»
                    gameScene.tweens.add({
                        targets: pack.graphic,
                        alpha: 0.3,
                        duration: 250,
                        yoyo: true,
                        repeat: -1
                    });
                }
                
                const isDestroyed = !pack.graphic || pack.graphic.destroyed;
                
                if ((isExpired || isDestroyed) && pack.graphic && !pack.graphic.destroyed) {
                    pack.graphic.destroy();
                    if (isExpired) {
                        console.log('ğŸ’Š åŠ è¡€åŒ…è¶…æ—¶æ¶ˆå¤±');
                    }
                }
                return !isExpired && !isDestroyed;
            });
            
            // ---------- æ›´æ–°å…¶ä»–ç©å®¶çš„æ°”çƒ ----------
            for (const playerId in otherPlayers) {
                const player = otherPlayers[playerId];
                const container = player.container;
                
                // å¹³æ»‘ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®
                const pdx = player.targetX - container.x;
                const pdy = player.targetY - container.y;
                const pdistance = Math.sqrt(pdx * pdx + pdy * pdy);
                
                if (pdistance > 1) {
                    const easing = 0.04;
                    container.x += pdx * easing;
                    container.y += pdy * easing;
                    
                    // è®¡ç®—å€¾æ–œè§’åº¦
                    const pVelocityX = pdx * easing;
                    const pTargetRotation = pVelocityX * 0.1;
                    const pTargetRad = Phaser.Math.Clamp(pTargetRotation, -0.15, 0.15);
                    container.angle = Phaser.Math.Linear(container.angle, pTargetRad * (180 / Math.PI), 0.1);
                }
                
                // æ·»åŠ å‘¼å¸æ•ˆæœ
                container.y += breatheY * 0.3;
                container.setScale(breatheScale * 0.95);  // å…¶ä»–ç©å®¶ç¨å¾®å°ä¸€ç‚¹
            }
            
            // ---------- æ£€æµ‹ç©å®¶ä¹‹é—´çš„ç¢°æ’ ----------
            if (balloon && !isDead) {
                for (const playerId in otherPlayers) {
                    const player = otherPlayers[playerId];
                    const container = player.container;
                    
                    // è®¡ç®—ä¸¤ä¸ªæ°”çƒä¹‹é—´çš„è·ç¦»
                    const dx = balloon.x - container.x;
                    const dy = balloon.y - container.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    // å¦‚æœè·ç¦»å°äºç¢°æ’åŠå¾„ï¼ˆä¸¤ä¸ªæ°”çƒçš„åŠå¾„ä¹‹å’Œï¼‰
                    const collisionRadius = 80; // ä¸¤ä¸ªæ°”çƒçš„ç¢°æ’åŠå¾„
                    
                    if (distance < collisionRadius) {
                        // è®¡ç®—ç¢°æ’æ³•å‘é‡
                        const normalX = dx / distance;
                        const normalY = dy / distance;
                        
                        // è®¡ç®—é‡å è·ç¦»
                        const overlap = collisionRadius - distance;
                        
                        // å°†å½“å‰ç©å®¶çš„æ°”çƒæ¨å¼€ï¼ˆç‰©ç†ç¢°æ’æ•ˆæœï¼‰
                        const pushForce = overlap * 0.5;
                        targetX = balloon.x + normalX * pushForce;
                        targetY = balloon.y + normalY * pushForce;
                        
                        // é™åˆ¶åœ¨å±å¹•èŒƒå›´å†…
                        targetX = Phaser.Math.Clamp(targetX, 30, config.width - 30);
                        targetY = Phaser.Math.Clamp(targetY, 30, config.height - 30);
                        
                        // æ·»åŠ è§†è§‰åé¦ˆï¼ˆè½»å¾®éœ‡åŠ¨ï¼‰
                        if (!player.collisionCooldown) {
                            gameScene.tweens.add({
                                targets: balloon,
                                x: balloon.x + (Math.random() - 0.5) * 5,
                                y: balloon.y + (Math.random() - 0.5) * 5,
                                duration: 50,
                                yoyo: true,
                                repeat: 1
                            });
                            
                            // æ·»åŠ ç¢°æ’å†·å´æ—¶é—´ï¼Œé¿å…é¢‘ç¹è§¦å‘
                            player.collisionCooldown = true;
                            setTimeout(() => {
                                player.collisionCooldown = false;
                            }, 500);
                            
                            console.log('ğŸ’¥ ä¸ç©å®¶', player.name, 'å‘ç”Ÿç¢°æ’ï¼');
                        }
                    }
                }
            }
            
            // ---------- æ›´æ–°å¹¿å‘Šæ°”çƒçš„æ™ƒåŠ¨æ•ˆæœ ----------
            adBalloonsObjects.forEach(adObj => {
                if (!adObj.container) return;
                
                // ç¼“æ…¢çš„å·¦å³æ™ƒåŠ¨
                adObj.swayOffset += 0.008;  // æ™ƒåŠ¨é€Ÿåº¦
                const swayX = Math.sin(adObj.swayOffset) * 15;  // æ™ƒåŠ¨å¹…åº¦ 15 åƒç´ 
                const swayY = Math.cos(adObj.swayOffset * 0.5) * 10;  // è½»å¾®ä¸Šä¸‹æµ®åŠ¨
                
                adObj.container.x = adObj.baseX + swayX;
                adObj.container.y = adObj.baseY + swayY;
                
                // è½»å¾®çš„å€¾æ–œ
                const swayAngle = Math.sin(adObj.swayOffset) * 3;  // å€¾æ–œè§’åº¦ Â±3åº¦
                adObj.container.angle = swayAngle;
            });
        }
        
        // ==================== é¡µé¢å…³é—­æ—¶æ¸…ç† ====================
        window.addEventListener('beforeunload', async () => {
            // åˆ é™¤è‡ªå·±çš„ä½ç½®è®°å½•
            if (!supabaseClient) return;
            
            try {
                await supabaseClient
                    .from('balloon_positions')
                    .delete()
                    .eq('player_id', playerId);
            } catch (err) {
                console.error('æ¸…ç†ä½ç½®è®°å½•å¤±è´¥:', err);
            }
        });
    </script>
</body>
</html>
