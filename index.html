<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¢¦å¹»çƒ­æ°”çƒé£è¡Œ</title>
    <!-- å¼•å…¥ç°ä»£å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(180deg, #1e3c72 0%, #2a5298 40%, #7fa3d1 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow: hidden;  /* é˜²æ­¢æ»šåŠ¨ */
        }
        #game-container {
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            overflow: hidden;
            max-width: 100%;   /* å“åº”å¼ï¼šä¸è¶…è¿‡å±å¹•å®½åº¦ */
            max-height: 100vh; /* å“åº”å¼ï¼šä¸è¶…è¿‡å±å¹•é«˜åº¦ */
        }
        #game-container canvas {
            display: block;
            max-width: 100%;
            max-height: 100vh;
        }
        
        /* åå­—è¾“å…¥å¼¹çª—æ ·å¼ */
        #name-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        #name-modal.hidden {
            display: none;
        }
        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 400px;
            width: 90%;
            animation: modalFadeIn 0.3s ease-out;
        }
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .modal-content h2 {
            color: #fff;
            margin: 0 0 10px 0;
            font-size: 28px;
            font-weight: 700;
        }
        .modal-content p {
            color: rgba(255, 255, 255, 0.9);
            margin: 0 0 25px 0;
            font-size: 16px;
        }
        #player-name-input {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            text-align: center;
            box-sizing: border-box;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            font-weight: 600;
            outline: none;
            transition: all 0.3s;
        }
        #player-name-input:focus {
            background: #fff;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
        }
        #player-name-input::placeholder {
            color: #999;
            font-weight: 400;
        }
        #start-game-btn {
            margin-top: 20px;
            padding: 15px 40px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }
        #start-game-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(245, 87, 108, 0.4);
        }
        #start-game-btn:active {
            transform: translateY(0);
        }
        .emoji-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        /* æ›´æ”¹åå­—æŒ‰é’®æ ·å¼ */
        #change-name-btn {
            position: fixed;
            top: 15px;
            left: 15px;
            padding: 10px 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            z-index: 999;
            opacity: 1;
            pointer-events: auto;
        }
        #change-name-btn.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #change-name-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        #change-name-btn:active {
            transform: translateY(0);
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            #change-name-btn {
                font-size: 12px;
                padding: 8px 15px;
                top: 10px;
                left: 10px;
            }
            #admin-btn {
                font-size: 12px;
                padding: 8px 15px;
                top: 50px;
                left: 10px;
            }
        }
        
        /* å¹¿å‘Šä½è®¾ç½®æŒ‰é’®æ ·å¼ */
        #admin-btn {
            position: fixed;
            top: 55px;
            left: 15px;
            padding: 10px 18px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);
            transition: all 0.3s;
            z-index: 999;
        }
        #admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(240, 147, 251, 0.6);
        }
        #admin-btn:active {
            transform: translateY(0);
        }
        
        /* ç®¡ç†å‘˜ç™»å½•å¼¹çª— */
        #admin-login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        #admin-login-modal.show {
            display: flex;
        }
        
        /* å¹¿å‘Šä½ç®¡ç†é¢æ¿ */
        #ad-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
            overflow-y: auto;
        }
        #ad-panel.show {
            display: flex;
        }
        .panel-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .panel-content h2 {
            color: #fff;
            margin: 0 0 20px 0;
            font-size: 24px;
            text-align: center;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            color: #fff;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .btn-primary,
        .btn-secondary,
        .btn-danger {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }
        .btn-primary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-primary:hover,
        .btn-secondary:hover,
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .ad-balloon-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .ad-balloon-item h4 {
            color: #fff;
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 8px;
            display: none;
        }
        .image-preview.show {
            display: block;
        }
        
        /* æ­»äº¡å¼¹çª—æ ·å¼ */
        #death-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            backdrop-filter: blur(10px);
        }
        #death-modal.show {
            display: flex;
        }
        .death-content {
            background: linear-gradient(135deg, #434343 0%, #000000 100%);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(255, 0, 0, 0.5);
            text-align: center;
            max-width: 450px;
            width: 90%;
            border: 3px solid #FF0000;
        }
        .death-content h2 {
            color: #FF0000;
            margin: 0 0 10px 0;
            font-size: 32px;
            font-weight: 700;
            text-shadow: 0 0 10px #FF0000;
        }
        .death-content p {
            color: #fff;
            margin: 10px 0 30px 0;
            font-size: 18px;
        }
        .revive-option {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .revive-option h4 {
            color: #FFD700;
            margin: 0 0 10px 0;
            font-size: 18px;
        }
        .revive-btn {
            width: 100%;
            padding: 15px;
            margin-top: 10px;
            background: linear-gradient(135deg, #00FF00 0%, #00AA00 100%);
            color: #000;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        .revive-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 255, 0, 0.4);
        }
        .revive-btn:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        /* å……å€¼æŒ‰é’®æ ·å¼ */
        #recharge-btn {
            position: fixed;
            top: 130px;
            right: 15px;
            padding: 10px 18px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            transition: all 0.3s;
            z-index: 999;
        }
        #recharge-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
        }
        
        /* å……å€¼å¼¹çª— */
        #recharge-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2500;
            backdrop-filter: blur(5px);
        }
        #recharge-modal.show {
            display: flex;
        }
        
        @media (max-width: 768px) {
            #recharge-btn {
                font-size: 12px;
                padding: 8px 15px;
                top: 110px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- æ›´æ”¹åå­—æŒ‰é’® -->
    <button id="change-name-btn">ğŸ‘¤ æ›´æ”¹åå­—</button>
    
    <!-- å¹¿å‘Šä½è®¾ç½®æŒ‰é’® -->
    <button id="admin-btn">ğŸ¯ å¹¿å‘Šä½è®¾ç½®</button>
    
    <!-- å……å€¼æŒ‰é’® -->
    <button id="recharge-btn">ğŸ’° å……å€¼</button>
    
    <!-- ç®¡ç†å‘˜ç™»å½•å¼¹çª— -->
    <div id="admin-login-modal">
        <div class="modal-content">
            <div class="emoji-icon">ğŸ”</div>
            <h2>ç®¡ç†å‘˜ç™»å½•</h2>
            <p>è¯·è¾“å…¥ç®¡ç†å‘˜è´¦å·å’Œå¯†ç </p>
            <div class="form-group">
                <input 
                    type="text" 
                    id="admin-username" 
                    placeholder="ç®¡ç†å‘˜è´¦å·" 
                    autocomplete="off"
                />
            </div>
            <div class="form-group" style="margin-top: 15px;">
                <input 
                    type="password" 
                    id="admin-password" 
                    placeholder="ç®¡ç†å‘˜å¯†ç " 
                    autocomplete="off"
                />
            </div>
            <div class="btn-group">
                <button class="btn-secondary" id="cancel-login-btn">å–æ¶ˆ</button>
                <button class="btn-primary" id="confirm-login-btn">ç™»å½•</button>
            </div>
        </div>
    </div>
    
    <!-- å¹¿å‘Šä½ç®¡ç†é¢æ¿ -->
    <div id="ad-panel">
        <div class="panel-content">
            <h2>ğŸˆ å¹¿å‘Šä½ç®¡ç†é¢æ¿</h2>
            
            <!-- æ·»åŠ æ–°å¹¿å‘Šæ°”çƒ -->
            <div class="ad-balloon-item">
                <h4>â• æ·»åŠ æ–°å¹¿å‘Šæ°”çƒ</h4>
                <div class="form-group">
                    <label>å¹¿å‘Šè¯ï¼š</label>
                    <textarea id="new-ad-text" placeholder="è¯·è¾“å…¥å¹¿å‘Šè¯..."></textarea>
                </div>
                <div class="form-group">
                    <label>å¹¿å‘Šå›¾ç‰‡ï¼š</label>
                    <input type="file" id="new-ad-image" accept="image/*" />
                    <img id="new-ad-image-preview" class="image-preview" alt="é¢„è§ˆ" />
                </div>
                <div class="form-group">
                    <label>ä½ç½® Xï¼ˆ0-800ï¼‰ï¼š</label>
                    <input type="number" id="new-ad-x" value="200" min="50" max="750" />
                </div>
                <div class="form-group">
                    <label>ä½ç½® Yï¼ˆ0-600ï¼‰ï¼š</label>
                    <input type="number" id="new-ad-y" value="200" min="50" max="550" />
                </div>
                <div class="form-group">
                    <label>å›¾ç‰‡é€æ˜åº¦ï¼ˆ0-1ï¼Œ1ä¸ºå®Œå…¨ä¸é€æ˜ï¼‰ï¼š</label>
                    <input type="number" id="new-ad-opacity" value="0.9" min="0" max="1" step="0.1" />
                </div>
                <button class="btn-primary" id="add-ad-balloon-btn" style="width: 100%;">æ·»åŠ å¹¿å‘Šæ°”çƒ</button>
            </div>
            
            <!-- ç°æœ‰å¹¿å‘Šæ°”çƒåˆ—è¡¨ -->
            <div id="ad-balloons-list">
                <h4 style="color: #fff; margin-bottom: 15px;">ğŸ“‹ ç°æœ‰å¹¿å‘Šæ°”çƒ</h4>
                <div id="ad-balloons-container"></div>
            </div>
            
            <div class="btn-group">
                <button class="btn-secondary" id="close-panel-btn">å…³é—­é¢æ¿</button>
            </div>
        </div>
    </div>

    <!-- æ­»äº¡å¼¹çª— -->
    <div id="death-modal">
        <div class="death-content">
            <div class="emoji-icon">ğŸ’€</div>
            <h2>æ¸¸æˆç»“æŸ</h2>
            <p>ä½ çš„ç”Ÿå‘½å€¼å·²è€—å°½ï¼</p>
            <p style="font-size: 16px; color: #FFD700;">é€‰æ‹©å¤æ´»æ–¹å¼ï¼š</p>
            
            <div class="revive-option">
                <h4 id="revive-credits-option">æ¶ˆè€—100æ¸¸æˆåˆ†å¤æ´»</h4>
                <button class="revive-btn" id="revive-credits-btn">ä½¿ç”¨æ¸¸æˆåˆ†å¤æ´»</button>
            </div>
            
            <div class="revive-option">
                <h4>å……å€¼0.1å…ƒå¤æ´»</h4>
                <p style="color: #aaa; font-size: 14px; margin: 5px 0;">å……å€¼1å…ƒ = 1000æ¸¸æˆåˆ†</p>
                <button class="revive-btn" id="revive-pay-btn">æ”¯ä»˜å®å……å€¼å¤æ´»</button>
            </div>
        </div>
    </div>
    
    <!-- å……å€¼å¼¹çª— -->
    <div id="recharge-modal">
        <div class="modal-content">
            <div class="emoji-icon">ğŸ’</div>
            <h2>å……å€¼ä¸­å¿ƒ</h2>
            <p>1å…ƒ = 1000æ¸¸æˆåˆ†</p>
            
            <div class="form-group">
                <label>å……å€¼é‡‘é¢ï¼ˆå…ƒï¼‰ï¼š</label>
                <input type="number" id="recharge-amount" value="1" min="0.1" step="0.1" />
            </div>
            
            <div class="form-group">
                <p style="color: #FFD700; font-size: 18px; margin: 10px 0;">
                    å°†è·å¾—ï¼š<span id="recharge-credits-preview">1000</span> æ¸¸æˆåˆ†
                </p>
            </div>
            
            <div class="btn-group">
                <button class="btn-secondary" id="cancel-recharge-btn">å–æ¶ˆ</button>
                <button class="btn-primary" id="confirm-recharge-btn">æ”¯ä»˜å®æ”¯ä»˜</button>
            </div>
            
            <p style="color: #aaa; font-size: 12px; margin-top: 15px;">
                æ³¨æ„ï¼šæ”¯ä»˜å®æ”¯ä»˜åŠŸèƒ½éœ€è¦åç«¯æ”¯æŒï¼Œå½“å‰ä¸ºæ¼”ç¤ºç‰ˆæœ¬
            </p>
        </div>
    </div>
    
    <!-- åå­—è¾“å…¥å¼¹çª— -->
    <div id="name-modal">
        <div class="modal-content">
            <div class="emoji-icon">ğŸˆ</div>
            <h2>æ¬¢è¿æ¥åˆ°çƒ­æ°”çƒä¸–ç•Œ</h2>
            <p>è¯·è¾“å…¥ä½ çš„åå­—å¼€å§‹æ¸¸æˆ</p>
            <input 
                type="text" 
                id="player-name-input" 
                placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰ã€æå››..." 
                maxlength="10"
                autocomplete="off"
            />
            <button id="start-game-btn">ğŸš€ å¼€å§‹é£è¡Œ</button>
        </div>
    </div>

    <!-- æ¸¸æˆå®¹å™¨ -->
    <div id="game-container"></div>

    <!-- å¼•å…¥ Phaser.js åº“ (ä»CDNåŠ è½½) -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    
    <!-- å¼•å…¥ Supabase å®¢æˆ·ç«¯åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ==================== ç©å®¶åå­—ç®¡ç† ====================
        let playerName = '';
        let gameStarted = false;
        let playerNameTextObject = null;  // ä¿å­˜ç©å®¶åå­—æ–‡æœ¬å¯¹è±¡çš„å¼•ç”¨
        let gameScene = null;  // ä¿å­˜æ¸¸æˆåœºæ™¯å¯¹è±¡
        
        // ==================== å¹¿å‘Šä½ç®¡ç† ====================
        let adBalloons = [];  // å­˜å‚¨å¹¿å‘Šæ°”çƒæ•°æ®
        let adBalloonsObjects = [];  // å­˜å‚¨å¹¿å‘Šæ°”çƒçš„Phaserå¯¹è±¡
        const ADMIN_USERNAME = 'DDKJ';
        const ADMIN_PASSWORD = 'DDKJ88888888';
        let isAdminLoggedIn = false;
        
        // ä» localStorage è¯»å–ä¿å­˜çš„åå­—
        const savedName = localStorage.getItem('balloonPlayerName');
        if (savedName) {
            playerName = savedName;
            document.getElementById('name-modal').classList.add('hidden');
            document.getElementById('change-name-btn').classList.remove('hidden');
            gameStarted = true;
        } else {
            document.getElementById('change-name-btn').classList.add('hidden');
        }
        
        // ä» localStorage è¯»å–ä¿å­˜çš„æ¸¸æˆåˆ†
        const savedCredits = localStorage.getItem('gameCredits');
        if (savedCredits) {
            gameCredits = parseInt(savedCredits) || 0;
            console.log('ğŸ“Š å·²åŠ è½½æ¸¸æˆåˆ†:', gameCredits);
        }
        
        // å¤„ç†å¼€å§‹æ¸¸æˆæŒ‰é’®
        document.getElementById('start-game-btn').addEventListener('click', startGame);
        
        // å¤„ç†æ›´æ”¹åå­—æŒ‰é’®
        document.getElementById('change-name-btn').addEventListener('click', function() {
            document.getElementById('name-modal').classList.remove('hidden');
            document.getElementById('player-name-input').value = playerName;
            document.getElementById('player-name-input').focus();
            document.getElementById('player-name-input').select();
        });
        
        // å¤„ç†å›è½¦é”®
        document.getElementById('player-name-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                startGame();
            }
        });
        
        // ==================== å¹¿å‘Šä½è®¾ç½®ç›¸å…³äº‹ä»¶ ====================
        
        // å¹¿å‘Šä½è®¾ç½®æŒ‰é’®
        document.getElementById('admin-btn').addEventListener('click', function() {
            document.getElementById('admin-login-modal').classList.add('show');
            document.getElementById('admin-username').value = '';
            document.getElementById('admin-password').value = '';
        });
        
        // å–æ¶ˆç™»å½•
        document.getElementById('cancel-login-btn').addEventListener('click', function() {
            document.getElementById('admin-login-modal').classList.remove('show');
        });
        
        // ç¡®è®¤ç™»å½•
        document.getElementById('confirm-login-btn').addEventListener('click', function() {
            const username = document.getElementById('admin-username').value.trim();
            const password = document.getElementById('admin-password').value;
            
            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                isAdminLoggedIn = true;
                document.getElementById('admin-login-modal').classList.remove('show');
                document.getElementById('ad-panel').classList.add('show');
                loadAdBalloons();
                refreshAdBalloonsList();
            } else {
                alert('è´¦å·æˆ–å¯†ç é”™è¯¯ï¼');
            }
        });
        
        // ç™»å½•å¯†ç å›è½¦é”®
        document.getElementById('admin-password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('confirm-login-btn').click();
            }
        });
        
        // å…³é—­å¹¿å‘Šä½ç®¡ç†é¢æ¿
        document.getElementById('close-panel-btn').addEventListener('click', function() {
            document.getElementById('ad-panel').classList.remove('show');
        });
        
        // å›¾ç‰‡é¢„è§ˆ
        document.getElementById('new-ad-image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const preview = document.getElementById('new-ad-image-preview');
                    preview.src = event.target.result;
                    preview.classList.add('show');
                };
                reader.readAsDataURL(file);
            }
        });
        
        // æ·»åŠ å¹¿å‘Šæ°”çƒ
        document.getElementById('add-ad-balloon-btn').addEventListener('click', addAdBalloon);
        
        // ==================== å……å€¼å’Œå¤æ´»ç›¸å…³äº‹ä»¶ ====================
        
        // å……å€¼æŒ‰é’®
        document.getElementById('recharge-btn').addEventListener('click', function() {
            document.getElementById('recharge-modal').classList.add('show');
        });
        
        // å–æ¶ˆå……å€¼
        document.getElementById('cancel-recharge-btn').addEventListener('click', function() {
            document.getElementById('recharge-modal').classList.remove('show');
        });
        
        // å……å€¼é‡‘é¢å®æ—¶é¢„è§ˆ
        document.getElementById('recharge-amount').addEventListener('input', function(e) {
            const amount = parseFloat(e.target.value) || 0;
            const credits = Math.floor(amount * 1000);
            document.getElementById('recharge-credits-preview').textContent = credits;
        });
        
        // ç¡®è®¤å……å€¼ï¼ˆæ”¯ä»˜å®æ”¯ä»˜ï¼‰
        document.getElementById('confirm-recharge-btn').addEventListener('click', function() {
            const amount = parseFloat(document.getElementById('recharge-amount').value) || 0;
            if (amount < 0.1) {
                alert('æœ€ä½å……å€¼é‡‘é¢ä¸º0.1å…ƒï¼');
                return;
            }
            
            // è¿™é‡Œåº”è¯¥è°ƒç”¨æ”¯ä»˜å®æ”¯ä»˜æ¥å£
            // å½“å‰ä¸ºæ¼”ç¤ºç‰ˆæœ¬ï¼Œç›´æ¥æ¨¡æ‹Ÿå……å€¼æˆåŠŸ
            alert('æ”¯ä»˜å®æ”¯ä»˜åŠŸèƒ½éœ€è¦åç«¯æ”¯æŒã€‚\n\næ¼”ç¤ºæ¨¡å¼ï¼šå°†ç›´æ¥æ·»åŠ æ¸¸æˆåˆ†ã€‚\nå®é™…åº”ç”¨ä¸­éœ€è¦æ¥å…¥æ”¯ä»˜å®SDKã€‚');
            
            const credits = Math.floor(amount * 1000);
            gameCredits += credits;
            updateCredits();
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('gameCredits', gameCredits);
            
            document.getElementById('recharge-modal').classList.remove('show');
            alert('å……å€¼æˆåŠŸï¼è·å¾— ' + credits + ' æ¸¸æˆåˆ†');
        });
        
        // ä½¿ç”¨æ¸¸æˆåˆ†å¤æ´»
        document.getElementById('revive-credits-btn').addEventListener('click', function() {
            if (gameCredits >= 100) {
                gameCredits -= 100;
                updateCredits();
                localStorage.setItem('gameCredits', gameCredits);
                revivePlayer('credits');
                alert('å¤æ´»æˆåŠŸï¼æ¶ˆè€—100æ¸¸æˆåˆ†');
            } else {
                alert('æ¸¸æˆåˆ†ä¸è¶³ï¼éœ€è¦100æ¸¸æˆåˆ†');
            }
        });
        
        // å……å€¼å¤æ´»
        document.getElementById('revive-pay-btn').addEventListener('click', function() {
            // æ¨¡æ‹Ÿ0.1å…ƒå……å€¼
            alert('æ”¯ä»˜å®æ”¯ä»˜åŠŸèƒ½éœ€è¦åç«¯æ”¯æŒã€‚\n\næ¼”ç¤ºæ¨¡å¼ï¼šå°†ç›´æ¥å¤æ´»å¹¶æ·»åŠ 100æ¸¸æˆåˆ†ã€‚');
            gameCredits += 100;
            updateCredits();
            localStorage.setItem('gameCredits', gameCredits);
            revivePlayer('payment');
            alert('å……å€¼å¤æ´»æˆåŠŸï¼');
        });
        
        function startGame() {
            const input = document.getElementById('player-name-input').value.trim();
            
            console.log('ğŸ¯ startGame è¢«è°ƒç”¨ï¼Œè¾“å…¥å€¼:', input);
            
            if (!input) {
                alert('è¯·è¾“å…¥ä½ çš„åå­—ï¼');
                return;
            }
            
            if (input.length < 2) {
                alert('åå­—è‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦ï¼');
                return;
            }
            
            const isNameChanged = (playerName && playerName !== input);
            playerName = input;
            localStorage.setItem('balloonPlayerName', playerName);
            document.getElementById('name-modal').classList.add('hidden');
            document.getElementById('change-name-btn').classList.remove('hidden');
            
            console.log('âœ… åå­—å·²è®¾ç½®:', playerName);
            console.log('ğŸ“ gameScene çŠ¶æ€:', gameScene ? 'å·²å­˜åœ¨' : 'æœªåˆ›å»º');
            
            // å¦‚æœæ˜¯æ›´æ”¹åå­—ï¼Œæ›´æ–°æ˜¾ç¤º
            if (isNameChanged && playerNameTextObject) {
                playerNameTextObject.setText(playerName);
                console.log('âœï¸ åå­—å·²æ›´æ”¹ä¸º:', playerName);
                // å‘é€æ›´æ–°åˆ° Supabase
                sendPositionUpdate(balloon.x, balloon.y);
                return;  // æ›´æ”¹åå­—çš„æƒ…å†µï¼Œç›´æ¥è¿”å›
            }
            
            // å¦‚æœæ˜¯é¦–æ¬¡å¯åŠ¨æ¸¸æˆ
            if (!gameStarted) {
                gameStarted = true;
                console.log('ğŸˆ æ¸¸æˆé¦–æ¬¡å¯åŠ¨ï¼Œç©å®¶:', playerName);
                
                // å¦‚æœæ¸¸æˆåœºæ™¯å·²ç»åˆ›å»ºï¼Œç«‹å³åˆå§‹åŒ–
                if (gameScene) {
                    console.log('ğŸš€ åœºæ™¯å·²å­˜åœ¨ï¼Œç«‹å³åˆå§‹åŒ–æ¸¸æˆ...');
                    try {
                        initializeGame.call(gameScene);
                        console.log('âœ… æ¸¸æˆåˆå§‹åŒ–å®Œæˆï¼');
                    } catch (error) {
                        console.error('âŒ æ¸¸æˆåˆå§‹åŒ–å¤±è´¥:', error);
                    }
                } else {
                    console.log('â³ åœºæ™¯æœªåˆ›å»ºï¼Œç­‰å¾… Phaser åœºæ™¯åˆå§‹åŒ–...');
                }
            }
        }
        
        // ==================== å¹¿å‘Šä½ç®¡ç†å‡½æ•° ====================
        
        // æ·»åŠ å¹¿å‘Šæ°”çƒ
        function addAdBalloon() {
            const text = document.getElementById('new-ad-text').value.trim();
            const imageInput = document.getElementById('new-ad-image');
            const x = parseInt(document.getElementById('new-ad-x').value);
            const y = parseInt(document.getElementById('new-ad-y').value);
            const opacity = parseFloat(document.getElementById('new-ad-opacity').value);
            
            if (!text && !imageInput.files[0]) {
                alert('è¯·è‡³å°‘è¾“å…¥å¹¿å‘Šè¯æˆ–ä¸Šä¼ å¹¿å‘Šå›¾ç‰‡ï¼');
                return;
            }
            
            if (adBalloons.length >= 10) {
                alert('æœ€å¤šåªèƒ½æ·»åŠ 10ä¸ªå¹¿å‘Šæ°”çƒï¼');
                return;
            }
            
            // è¯»å–å›¾ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
            if (imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const adData = {
                        id: Date.now(),
                        text: text,
                        image: event.target.result,
                        x: x,
                        y: y,
                        opacity: opacity
                    };
                    adBalloons.push(adData);
                    saveAdBalloonsToStorage();
                    refreshAdBalloonsList();
                    
                    // åœ¨æ¸¸æˆä¸­åˆ›å»ºå¹¿å‘Šæ°”çƒ
                    if (gameScene) {
                        createAdBalloonInGame(gameScene, adData);
                    }
                    
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('new-ad-text').value = '';
                    document.getElementById('new-ad-image').value = '';
                    document.getElementById('new-ad-image-preview').classList.remove('show');
                    
                    alert('å¹¿å‘Šæ°”çƒæ·»åŠ æˆåŠŸï¼');
                };
                reader.readAsDataURL(imageInput.files[0]);
            } else {
                const adData = {
                    id: Date.now(),
                    text: text,
                    image: null,
                    x: x,
                    y: y,
                    opacity: opacity
                };
                adBalloons.push(adData);
                saveAdBalloonsToStorage();
                refreshAdBalloonsList();
                
                // åœ¨æ¸¸æˆä¸­åˆ›å»ºå¹¿å‘Šæ°”çƒ
                if (gameScene) {
                    createAdBalloonInGame(gameScene, adData);
                }
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('new-ad-text').value = '';
                alert('å¹¿å‘Šæ°”çƒæ·»åŠ æˆåŠŸï¼');
            }
        }
        
        // åˆ·æ–°å¹¿å‘Šæ°”çƒåˆ—è¡¨
        function refreshAdBalloonsList() {
            const container = document.getElementById('ad-balloons-container');
            
            if (adBalloons.length === 0) {
                container.innerHTML = '<p style="color: rgba(255,255,255,0.6); text-align: center;">æš‚æ— å¹¿å‘Šæ°”çƒ</p>';
                return;
            }
            
            container.innerHTML = '';
            adBalloons.forEach((ad, index) => {
                const item = document.createElement('div');
                item.className = 'ad-balloon-item';
                item.innerHTML = `
                    <h4>ğŸˆ å¹¿å‘Šæ°”çƒ #${index + 1}</h4>
                    <p style="color: rgba(255,255,255,0.9); margin: 5px 0;">å¹¿å‘Šè¯ï¼š${ad.text || 'æ— '}</p>
                    <p style="color: rgba(255,255,255,0.9); margin: 5px 0;">å›¾ç‰‡ï¼š${ad.image ? 'å·²ä¸Šä¼ ' : 'æ— '}</p>
                    <p style="color: rgba(255,255,255,0.9); margin: 5px 0;">ä½ç½®ï¼š(${ad.x}, ${ad.y})</p>
                    <p style="color: rgba(255,255,255,0.9); margin: 5px 0;">é€æ˜åº¦ï¼š${ad.opacity !== undefined ? ad.opacity : 0.9}</p>
                    ${ad.image ? `<img src="${ad.image}" class="image-preview show" alt="å¹¿å‘Šå›¾ç‰‡" />` : ''}
                    <button class="btn-danger" style="width: 100%; margin-top: 10px;" onclick="deleteAdBalloon(${ad.id})">åˆ é™¤</button>
                `;
                container.appendChild(item);
            });
        }
        
        // åˆ é™¤å¹¿å‘Šæ°”çƒ
        function deleteAdBalloon(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¹¿å‘Šæ°”çƒå—ï¼Ÿ')) return;
            
            const index = adBalloons.findIndex(ad => ad.id === id);
            if (index !== -1) {
                adBalloons.splice(index, 1);
                saveAdBalloonsToStorage();
                refreshAdBalloonsList();
                
                // ä»æ¸¸æˆä¸­ç§»é™¤
                if (adBalloonsObjects[index]) {
                    adBalloonsObjects[index].container.destroy();
                    adBalloonsObjects.splice(index, 1);
                }
                
                alert('å¹¿å‘Šæ°”çƒå·²åˆ é™¤ï¼');
            }
        }
        
        // ä¿å­˜å¹¿å‘Šæ°”çƒåˆ°æœ¬åœ°å­˜å‚¨
        function saveAdBalloonsToStorage() {
            try {
                localStorage.setItem('adBalloons', JSON.stringify(adBalloons));
                console.log('âœ… å¹¿å‘Šæ°”çƒæ•°æ®å·²ä¿å­˜');
            } catch (error) {
                console.error('âŒ ä¿å­˜å¹¿å‘Šæ°”çƒæ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½å¹¿å‘Šæ°”çƒæ•°æ®
        function loadAdBalloons() {
            try {
                const saved = localStorage.getItem('adBalloons');
                if (saved) {
                    adBalloons = JSON.parse(saved);
                    console.log('âœ… å·²åŠ è½½å¹¿å‘Šæ°”çƒæ•°æ®:', adBalloons.length, 'ä¸ª');
                }
            } catch (error) {
                console.error('âŒ åŠ è½½å¹¿å‘Šæ°”çƒæ•°æ®å¤±è´¥:', error);
                adBalloons = [];
            }
        }
        
        // ==================== Supabase é…ç½® ====================
        const SUPABASE_URL = 'https://ksctfambipodjbrtjaby.supabase.co';
        // âš ï¸ æ³¨æ„ï¼šè¯·å°†ä¸‹é¢çš„ anon key æ›¿æ¢ä¸ºä½ çš„çœŸå® Supabase anon key
        // çœŸå®çš„ anon key åº”è¯¥æ˜¯ä»¥ "eyJ" å¼€å¤´çš„é•¿å­—ç¬¦ä¸²ï¼ˆJWT tokenï¼‰
        // ä½ å¯ä»¥åœ¨ Supabase Dashboard > Settings > API ä¸­æ‰¾åˆ°
                const SUPABASE_ANON_KEY = 'sb_publishable_8MsjbT3RenOKGNyMafKv-Q_b8MNN7Qn';

        // ç”Ÿæˆå½“å‰ç©å®¶çš„å”¯ä¸€ID
        const playerId = 'player_' + Math.random().toString(36).substr(2, 9);
        
        // ç©å®¶åå­—å°†åœ¨ç”¨æˆ·è¾“å…¥åè®¾ç½®
        console.log('ğŸˆ ç©å®¶ ID:', playerId);
        
        // åˆ›å»º Supabase å®¢æˆ·ç«¯ï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ï¼Œé¿å…é‡å¤å£°æ˜ï¼‰
        let supabaseClient = null;
        try {
            if (typeof window.supabase !== 'undefined') {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
            } else {
                console.error('âŒ Supabase åº“æœªåŠ è½½ï¼');
            }
        } catch (error) {
            console.error('âŒ Supabase åˆå§‹åŒ–å¤±è´¥:', error);
        }

        // ==================== Phaser æ¸¸æˆé…ç½® ====================
        const config = {
            type: Phaser.AUTO,              // è‡ªåŠ¨é€‰æ‹©æ¸²æŸ“å™¨ (WebGL æˆ– Canvas)
            width: 800,                     // æ¸¸æˆç”»å¸ƒå®½åº¦
            height: 600,                    // æ¸¸æˆç”»å¸ƒé«˜åº¦
            parent: 'game-container',       // å°†æ¸¸æˆæŒ‚è½½åˆ°è¿™ä¸ªDOMå…ƒç´ 
            backgroundColor: '#87CEEB',     // èƒŒæ™¯é¢œè‰² (å¤©è“è‰²)
            scale: {
                mode: Phaser.Scale.FIT,     // è‡ªé€‚åº”ç¼©æ”¾æ¨¡å¼ï¼šä¿æŒå®½é«˜æ¯”å¹¶å¡«å……å±å¹•
                autoCenter: Phaser.Scale.CENTER_BOTH,  // å±…ä¸­æ˜¾ç¤º
                width: 800,
                height: 600
            },
            scene: {
                create: create,             // åˆ›å»ºåœºæ™¯æ—¶è°ƒç”¨
                update: update              // æ¯å¸§æ›´æ–°æ—¶è°ƒç”¨
            }
        };

        // åˆ›å»º Phaser æ¸¸æˆå®ä¾‹
        const game = new Phaser.Game(config);

        // æ¸¸æˆå¯¹è±¡å˜é‡
        let balloon;                        // æ°”çƒå®¹å™¨å¯¹è±¡
        let balloonBody;                    // æ°”çƒæœ¬ä½“å›¾å½¢
        let basket;                         // æ°”çƒç¯®å­
        let playerNameText;                 // ç©å®¶åå­—æ–‡æœ¬
        let targetX = 400;                  // æ°”çƒç›®æ ‡Xåæ ‡
        let targetY = 300;                  // æ°”çƒç›®æ ‡Yåæ ‡
        let breatheOffset = 0;              // å‘¼å¸åŠ¨ç”»çš„åç§»é‡
        let clouds = [];                    // äº‘æœµæ•°ç»„
        let previousX = 400;                // è®°å½•æ°”çƒä¸Šä¸€å¸§çš„Xä½ç½®ï¼Œç”¨äºè®¡ç®—å€¾æ–œæ–¹å‘
        let otherPlayers = {};              // å­˜å‚¨å…¶ä»–ç©å®¶çš„æ°”çƒå¯¹è±¡
        let lastUpdateTime = 0;             // ä¸Šæ¬¡å‘é€ä½ç½®æ›´æ–°çš„æ—¶é—´
        const UPDATE_INTERVAL = 100;        // ä½ç½®æ›´æ–°é—´éš”ï¼ˆæ¯«ç§’ï¼‰
        
        // æ¸¸æˆå…ƒç´ 
        let coins = [];                     // é‡‘å¸æ•°ç»„
        let obstacles = [];                 // éšœç¢ç‰©æ•°ç»„
        let score = 0;                      // å½“å‰åˆ†æ•°
        let scoreText;                      // åˆ†æ•°æ˜¾ç¤ºæ–‡æœ¬
        let healthPacks = [];               // åŠ è¡€åŒ…æ•°ç»„
        let playerHealth = 100;             // ç©å®¶ç”Ÿå‘½å€¼
        let maxHealth = 100;                // æœ€å¤§ç”Ÿå‘½å€¼
        let healthText;                     // ç”Ÿå‘½å€¼æ˜¾ç¤ºæ–‡æœ¬
        let gameCredits = 0;                // æ¸¸æˆåˆ†
        let creditsText;                    // æ¸¸æˆåˆ†æ˜¾ç¤ºæ–‡æœ¬
        let isDead = false;                 // ç©å®¶æ˜¯å¦æ­»äº¡
        let lastHealthPackSpawn = 0;        // ä¸Šæ¬¡åŠ è¡€åŒ…ç”Ÿæˆæ—¶é—´

        // ==================== ç»˜åˆ¶åƒç´ é£çƒ­æ°”çƒå‡½æ•° ====================
        function drawStripedBalloon(graphics) {
            // æ¸…ç©ºä¹‹å‰çš„ç»˜åˆ¶
            graphics.clear();
            
            // çƒ­æ°”çƒå‚æ•°
            const balloonWidth = 50;
            const balloonHeight = 65;
            const stripeCount = 8;  // æ¡çº¹æ•°é‡
            
            // ---------- ç»˜åˆ¶çº¢ç™½ç›¸é—´æ¡çº¹çš„çƒ­æ°”çƒçƒä½“ ----------
            for (let i = 0; i < stripeCount; i++) {
                // è®¡ç®—å½“å‰æ¡çº¹çš„è§’åº¦èŒƒå›´
                const startAngle = (i * Math.PI) / stripeCount - Math.PI / 2;
                const endAngle = ((i + 1) * Math.PI) / stripeCount - Math.PI / 2;
                
                // äº¤æ›¿ä½¿ç”¨çº¢è‰²å’Œç™½è‰²
                const color = i % 2 === 0 ? 0xE63946 : 0xF1FAEE;
                graphics.fillStyle(color, 1);
                
                // ç»˜åˆ¶æ‰‡å½¢æ¡çº¹
                graphics.beginPath();
                graphics.moveTo(0, -10);  // ä»é¡¶éƒ¨ä¸­å¿ƒå¼€å§‹
                
                // ç»˜åˆ¶æ¤­åœ†å¼§çº¿ï¼ˆçƒ­æ°”çƒå½¢çŠ¶ï¼‰
                for (let angle = startAngle; angle <= endAngle; angle += 0.1) {
                    const x = Math.cos(angle) * balloonWidth;
                    const y = Math.sin(angle) * balloonHeight - 10;
                    graphics.lineTo(x, y);
                }
                
                graphics.closePath();
                graphics.fillPath();
            }
            
            // ---------- ç»˜åˆ¶çƒ­æ°”çƒåº•éƒ¨ ----------
            graphics.fillStyle(0x457B9D, 1);  // æ·±è“è‰²åº•åº§
            graphics.fillRect(-balloonWidth, balloonHeight - 10, balloonWidth * 2, 8);
            
            // ---------- ç»˜åˆ¶è¿æ¥ç»³ ----------
            graphics.lineStyle(2, 0x8B4513, 1);  // æ£•è‰²ç»³å­
            
            // å·¦ä¾§ç»³å­
            graphics.beginPath();
            graphics.moveTo(-30, balloonHeight);
            graphics.lineTo(-15, balloonHeight + 25);
            graphics.strokePath();
            
            // å³ä¾§ç»³å­
            graphics.beginPath();
            graphics.moveTo(30, balloonHeight);
            graphics.lineTo(15, balloonHeight + 25);
            graphics.strokePath();
        }
        
        // ==================== ç»˜åˆ¶ç¯®å­å‡½æ•° ====================
        function drawBasket(graphics) {
            graphics.clear();
            
            // ---------- ç»˜åˆ¶ç¯®å­ä¸»ä½“ï¼ˆåƒç´ é£æ ¼ï¼‰----------
            graphics.fillStyle(0x8B4513, 1);  // æ£•è‰²
            graphics.fillRect(-15, 0, 30, 20);
            
            // ç»˜åˆ¶ç¯®å­çº¹ç†ï¼ˆæ¨ªå‘æ¡çº¹ï¼‰
            graphics.lineStyle(2, 0x654321, 1);
            for (let i = 5; i < 20; i += 5) {
                graphics.beginPath();
                graphics.moveTo(-15, i);
                graphics.lineTo(15, i);
                graphics.strokePath();
            }
            
            // ç»˜åˆ¶ç¯®å­è¾¹æ¡†
            graphics.lineStyle(2, 0x5A3A1A, 1);
            graphics.strokeRect(-15, 0, 30, 20);
        }
        
        // ==================== åˆ›å»ºå¹¿å‘Šæ°”çƒå‡½æ•° ====================
        function createAdBalloonInGame(scene, adData) {
            // åˆ›å»ºå®¹å™¨
            const container = scene.add.container(adData.x, adData.y);
            
            // åˆ›å»ºæ°”çƒæœ¬ä½“ï¼ˆæ¯”ç©å®¶æ°”çƒç¨å¤§ï¼‰
            const body = scene.add.graphics();
            drawStripedBalloon(body);
            body.setScale(1.3);  // æ¯”ç©å®¶æ°”çƒå¤§30%
            container.add(body);
            
            // åˆ›å»ºç¯®å­
            const adBasket = scene.add.graphics();
            adBasket.y = 120;  // è°ƒæ•´ä½ç½®ä»¥åŒ¹é…æ”¾å¤§çš„æ°”çƒ
            drawBasket(adBasket);
            adBasket.setScale(1.3);
            container.add(adBasket);
            
            // å¦‚æœæœ‰å¹¿å‘Šè¯ï¼Œåˆ›å»ºæ–‡æœ¬
            if (adData.text) {
                const adText = scene.add.text(
                    0, 0,
                    adData.text,
                    {
                        fontSize: '14px',
                        fontFamily: 'Inter, sans-serif',
                        color: '#FFFFFF',
                        backgroundColor: '#00000099',
                        padding: { x: 10, y: 5 },
                        fontStyle: 'bold',
                        align: 'center',
                        wordWrap: { width: 150 }
                    }
                );
                adText.setOrigin(0.5, 0.5);
                container.add(adText);
            }
            
            // å¦‚æœæœ‰å¹¿å‘Šå›¾ç‰‡ï¼Œåˆ›å»ºå›¾ç‰‡ç²¾çµ
            if (adData.image) {
                // åŠ è½½å›¾ç‰‡
                const textureKey = 'ad_image_' + adData.id;
                scene.textures.addBase64(textureKey, adData.image);
                
                // ç­‰å¾…çº¹ç†åŠ è½½å®Œæˆ
                scene.textures.once('addtexture', function() {
                    const texture = scene.textures.get(textureKey);
                    const frame = texture.get();
                    
                    // è·å–å›¾ç‰‡åŸå§‹å°ºå¯¸
                    const originalWidth = frame.width;
                    const originalHeight = frame.height;
                    
                    // è®¾ç½®ç›®æ ‡æœ€å¤§å°ºå¯¸
                    const maxSize = 120;
                    
                    // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œä¿æŒå®½é«˜æ¯”
                    let scale = 1;
                    if (originalWidth > originalHeight) {
                        // å®½åº¦è¾ƒå¤§ï¼Œä»¥å®½åº¦ä¸ºå‡†
                        scale = maxSize / originalWidth;
                    } else {
                        // é«˜åº¦è¾ƒå¤§ï¼Œä»¥é«˜åº¦ä¸ºå‡†
                        scale = maxSize / originalHeight;
                    }
                    
                    // åˆ›å»ºå›¾ç‰‡
                    const adImage = scene.add.image(0, 50, textureKey);
                    adImage.setScale(scale);  // ä½¿ç”¨è®¡ç®—çš„ç¼©æ”¾æ¯”ä¾‹ï¼Œä¿æŒåŸå§‹æ¯”ä¾‹
                    adImage.setOrigin(0.5, 0.5);
                    
                    // è®¾ç½®å›¾ç‰‡é€æ˜åº¦
                    const imageOpacity = adData.opacity !== undefined ? adData.opacity : 0.9;
                    adImage.setAlpha(imageOpacity);
                    
                    container.add(adImage);
                }, null, textureKey);
            }
            
            // è®¾ç½®é€æ˜åº¦ï¼ˆæ°”çƒæœ¬ä½“çš„é€æ˜åº¦ï¼‰
            const balloonOpacity = adData.opacity !== undefined ? adData.opacity * 0.9 : 0.85;
            container.setAlpha(balloonOpacity);
            
            // è®¾ç½®æ·±åº¦ï¼ˆåœ¨ç©å®¶æ°”çƒä¸‹æ–¹ï¼Œä½†åœ¨é‡‘å¸å’Œéšœç¢ç‰©ä¸Šæ–¹ï¼‰
            // å±‚çº§é¡ºåºï¼šèƒŒæ™¯(0) < äº‘æœµ(1) < å¹¿å‘Šæ°”çƒ(3) < é‡‘å¸/éšœç¢ç‰©(10) < ç©å®¶æ°”çƒ(100)
            container.setDepth(3);
            
            // æ·»åŠ ç¼“æ…¢æ™ƒåŠ¨åŠ¨ç”»
            const swayOffset = Math.random() * Math.PI * 2;  // éšæœºèµ·å§‹ç›¸ä½
            container.swayOffset = swayOffset;
            
            // ä¿å­˜å¹¿å‘Šæ°”çƒå¯¹è±¡
            adBalloonsObjects.push({
                container: container,
                data: adData,
                baseX: adData.x,
                baseY: adData.y,
                swayOffset: swayOffset
            });
            
            console.log('ğŸˆ å¹¿å‘Šæ°”çƒå·²åˆ›å»º:', adData.text, 'é€æ˜åº¦:', adData.opacity);
        }
        
        // åŠ è½½æ‰€æœ‰å¹¿å‘Šæ°”çƒåˆ°æ¸¸æˆä¸­
        function loadAdBalloonsInGame(scene) {
            // æ¸…ç©ºç°æœ‰çš„å¹¿å‘Šæ°”çƒå¯¹è±¡
            adBalloonsObjects.forEach(obj => {
                if (obj.container) {
                    obj.container.destroy();
                }
            });
            adBalloonsObjects = [];
            
            // åŠ è½½æ•°æ®
            loadAdBalloons();
            
            // åˆ›å»ºæ‰€æœ‰å¹¿å‘Šæ°”çƒ
            adBalloons.forEach(adData => {
                createAdBalloonInGame(scene, adData);
            });
        }

        // ==================== åˆ›å»ºé‡‘å¸å‡½æ•° ====================
        function createCoin(scene, x, y) {
            const coin = scene.add.graphics();
            coin.x = x;
            coin.y = y;
            
            // ç»˜åˆ¶é‡‘å¸ï¼ˆåœ†å½¢ï¼Œé‡‘é»„è‰²ï¼‰
            coin.fillStyle(0xFFD700, 1);  // é‡‘è‰²
            coin.fillCircle(0, 0, 15);
            
            // æ·»åŠ å†…åœˆ
            coin.fillStyle(0xFFA500, 1);  // æ©™è‰²
            coin.fillCircle(0, 0, 10);
            
            // æ·»åŠ å…‰æ³½
            coin.fillStyle(0xFFFFAA, 1);
            coin.fillCircle(-4, -4, 4);
            
            // è®¾ç½®æ·±åº¦ï¼ˆåœ¨å¹¿å‘Šæ°”çƒä¸Šæ–¹ï¼Œç©å®¶æ°”çƒä¸‹æ–¹ï¼‰
            coin.setDepth(10);
            
            // æ·»åŠ æ—‹è½¬åŠ¨ç”»
            scene.tweens.add({
                targets: coin,
                scaleX: 0.2,
                duration: 1000,
                yoyo: true,
                repeat: -1,
                ease: 'Sine.easeInOut'
            });
            
            // æ·»åŠ ä¸Šä¸‹æµ®åŠ¨
            scene.tweens.add({
                targets: coin,
                y: y + 10,
                duration: 2000,
                yoyo: true,
                repeat: -1,
                ease: 'Sine.easeInOut'
            });
            
            // 12ç§’åè‡ªåŠ¨æ¶ˆå¤±çš„åŠ¨ç”»
            scene.time.delayedCall(10000, () => {
                // 10ç§’åå¼€å§‹é—ªçƒæç¤ºå³å°†æ¶ˆå¤±
                scene.tweens.add({
                    targets: coin,
                    alpha: 0.3,
                    duration: 300,
                    yoyo: true,
                    repeat: 6,  // é—ªçƒ3æ¬¡
                    onComplete: () => {
                        // æ¶ˆå¤±åŠ¨ç”»
                        scene.tweens.add({
                            targets: coin,
                            alpha: 0,
                            scale: 0,
                            duration: 500,
                            ease: 'Power2',
                            onComplete: () => {
                                if (coin && !coin.destroyed) {
                                    coin.destroy();
                                }
                            }
                        });
                    }
                });
            });
            
            return {
                graphic: coin,
                x: x,
                y: y,
                radius: 15,
                collected: false,
                createTime: Date.now()  // è®°å½•åˆ›å»ºæ—¶é—´
            };
        }
        
        // ==================== åˆ›å»ºéšœç¢ç‰©å‡½æ•° ====================
        function createObstacle(scene, x, y, type) {
            const obstacle = scene.add.graphics();
            obstacle.x = x;
            obstacle.y = y;
            
            // è®¾ç½®æ·±åº¦ï¼ˆåœ¨å¹¿å‘Šæ°”çƒä¸Šæ–¹ï¼Œç©å®¶æ°”çƒä¸‹æ–¹ï¼‰
            obstacle.setDepth(10);
            
            if (type === 'bird') {
                // ç»˜åˆ¶å°é¸Ÿéšœç¢ç‰©ï¼ˆå°é›·ï¼‰
                obstacle.fillStyle(0x8B4513, 1);  // æ£•è‰²
                obstacle.fillEllipse(0, 0, 30, 20);
                
                obstacle.fillStyle(0xFFFFFF, 1);  // ç™½è‰²ç¿…è†€
                obstacle.fillEllipse(-15, 0, 15, 8);
                obstacle.fillEllipse(15, 0, 15, 8);
                
                obstacle.fillStyle(0xFF6B6B, 1);  // çº¢è‰²
                obstacle.fillTriangle(-8, 0, -12, 2, -8, 4);
                
                // é£è¡ŒåŠ¨ç”»
                scene.tweens.add({
                    targets: obstacle,
                    y: y + 20,
                    duration: 1500,
                    yoyo: true,
                    repeat: -1,
                    ease: 'Sine.easeInOut'
                });
            } else if (type === 'cloud') {
                // ç»˜åˆ¶é›·äº‘éšœç¢ç‰©ï¼ˆé—ªç”µäº‘ï¼‰
                obstacle.fillStyle(0x666666, 1);  // ç°è‰²äº‘
                obstacle.fillCircle(0, 0, 25);
                obstacle.fillCircle(-15, 5, 20);
                obstacle.fillCircle(15, 5, 20);
                
                // é—ªç”µæ•ˆæœ
                obstacle.lineStyle(3, 0xFFFF00, 1);
                obstacle.beginPath();
                obstacle.moveTo(0, 20);
                obstacle.lineTo(-5, 30);
                obstacle.lineTo(0, 30);
                obstacle.lineTo(-5, 40);
                obstacle.strokePath();
            }
            
            return {
                graphic: obstacle,
                x: x,
                y: y,
                width: 50,
                height: 40,
                type: type,
                damaged: false  // æ˜¯å¦å·²ç»é€ æˆä¼¤å®³
            };
        }
        
        // ==================== åˆ›å»ºåŠ è¡€åŒ…å‡½æ•° ====================
        function createHealthPack(scene, x, y) {
            const healthPack = scene.add.graphics();
            healthPack.x = x;
            healthPack.y = y;
            
            // ç»˜åˆ¶åŠ è¡€åŒ…ï¼ˆçº¢åå­—ï¼‰
            healthPack.fillStyle(0xFF0000, 1);  // çº¢è‰²
            healthPack.fillRect(-15, -5, 30, 10);  // æ¨ªæ¡
            healthPack.fillRect(-5, -15, 10, 30);  // ç«–æ¡
            
            // æ·»åŠ ç™½è‰²è¾¹æ¡†
            healthPack.lineStyle(2, 0xFFFFFF, 1);
            healthPack.strokeRect(-15, -5, 30, 10);
            healthPack.strokeRect(-5, -15, 10, 30);
            
            // è®¾ç½®æ·±åº¦
            healthPack.setDepth(10);
            
            // æ·»åŠ æ—‹è½¬åŠ¨ç”»
            scene.tweens.add({
                targets: healthPack,
                angle: 360,
                duration: 3000,
                repeat: -1,
                ease: 'Linear'
            });
            
            // æ·»åŠ ä¸Šä¸‹æµ®åŠ¨
            scene.tweens.add({
                targets: healthPack,
                y: y + 15,
                duration: 1500,
                yoyo: true,
                repeat: -1,
                ease: 'Sine.easeInOut'
            });
            
            // æ·»åŠ è„‰å†²æ•ˆæœ
            scene.tweens.add({
                targets: healthPack,
                scaleX: 1.2,
                scaleY: 1.2,
                duration: 800,
                yoyo: true,
                repeat: -1,
                ease: 'Sine.easeInOut'
            });
            
            return {
                graphic: healthPack,
                x: x,
                y: y,
                collected: false,
                createTime: Date.now()
            };
        }
        
        // ==================== ç”Ÿæˆæ¸¸æˆå…ƒç´ å‡½æ•° ====================
        function spawnGameElements(scene) {
            const now = Date.now();
            
            // éšæœºç”Ÿæˆé‡‘å¸ï¼ˆæœ€å¤š20ä¸ªï¼‰
            if (coins.length < 20 && Math.random() < 0.02) {  // 2% æ¦‚ç‡æ¯å¸§ï¼Œæœ€å¤š20ä¸ª
                const x = Math.random() * config.width;
                const y = Math.random() * config.height;
                const coin = createCoin(scene, x, y);
                coins.push(coin);
                console.log('ğŸ’° é‡‘å¸ç”Ÿæˆï¼Œå½“å‰æ•°é‡:', coins.length);
            }
            
            // éšæœºç”Ÿæˆéšœç¢ç‰©
            if (Math.random() < 0.01 && obstacles.length < 5) {  // 1% æ¦‚ç‡ï¼Œæœ€å¤š5ä¸ª
                const x = Math.random() * config.width;
                const y = Math.random() * (config.height * 0.7) + 50;
                const type = Math.random() > 0.5 ? 'bird' : 'cloud';
                const obstacle = createObstacle(scene, x, y, type);
                obstacles.push(obstacle);
            }
            
            // æ¯100ç§’ç”Ÿæˆ2ä¸ªåŠ è¡€åŒ…
            if (now - lastHealthPackSpawn > 100000 && healthPacks.length < 2) {
                // ç”Ÿæˆ2ä¸ªåŠ è¡€åŒ…
                for (let i = 0; i < 2; i++) {
                    const x = Math.random() * (config.width - 100) + 50;
                    const y = Math.random() * (config.height - 100) + 50;
                    const pack = createHealthPack(scene, x, y);
                    healthPacks.push(pack);
                    console.log('ğŸ’Š åŠ è¡€åŒ…ç”Ÿæˆï¼Œä½ç½®:', x, y);
                }
                lastHealthPackSpawn = now;
            }
        }
        
        // ==================== ç¢°æ’æ£€æµ‹å‡½æ•° ====================
        function checkCollisions() {
            if (!balloon || isDead) return;
            
            // æ£€æµ‹é‡‘å¸ç¢°æ’
            coins.forEach((coin, index) => {
                if (coin.collected) return;
                
                const distance = Phaser.Math.Distance.Between(
                    balloon.x, balloon.y,
                    coin.x, coin.graphic.y
                );
                
                if (distance < 40) {  // ç¢°æ’åŠå¾„
                    // æ”¶é›†é‡‘å¸
                    coin.collected = true;
                    score += 10;
                    gameCredits += 1;  // æ¯ä¸ªé‡‘å¸ç»™1æ¸¸æˆåˆ†
                    updateScore();
                    updateCredits();
                    
                    // é‡‘å¸æ¶ˆå¤±åŠ¨ç”»
                    gameScene.tweens.add({
                        targets: coin.graphic,
                        alpha: 0,
                        scale: 2,
                        duration: 300,
                        onComplete: () => {
                            coin.graphic.destroy();
                            coins.splice(index, 1);
                        }
                    });
                    
                    // æ’­æ”¾éŸ³æ•ˆï¼ˆæ–‡å­—æç¤ºï¼‰
                    showFloatingText(gameScene, balloon.x, balloon.y - 50, '+10 +1åˆ†', 0x00FF00);
                }
            });
            
            // æ£€æµ‹éšœç¢ç‰©ç¢°æ’
            obstacles.forEach(obstacle => {
                if (obstacle.damaged) return;  // å·²ç»é€ æˆè¿‡ä¼¤å®³ï¼Œè·³è¿‡
                
                const distance = Phaser.Math.Distance.Between(
                    balloon.x, balloon.y,
                    obstacle.x, obstacle.graphic.y
                );
                
                if (distance < 60) {  // ç¢°æ’åŠå¾„
                    obstacle.damaged = true;  // æ ‡è®°ä¸ºå·²é€ æˆä¼¤å®³
                    
                    // æ ¹æ®éšœç¢ç‰©ç±»å‹å‡å°‘ç”Ÿå‘½å€¼
                    let damage = 0;
                    if (obstacle.type === 'cloud') {
                        // é›·äº‘é€ æˆ10ç‚¹ä¼¤å®³
                        damage = 10;
                        playerHealth = Math.max(0, playerHealth - 10);
                        showFloatingText(gameScene, balloon.x, balloon.y - 50, '-10 HP', 0xFF0000);
                    } else if (obstacle.type === 'bird') {
                        // å°é¸Ÿé€ æˆ5ç‚¹ä¼¤å®³
                        damage = 5;
                        playerHealth = Math.max(0, playerHealth - 5);
                        showFloatingText(gameScene, balloon.x, balloon.y - 50, '-5 HP', 0xFF6B6B);
                    }
                    
                    updateHealth();
                    
                    // éœ‡åŠ¨æ•ˆæœ
                    gameScene.cameras.main.shake(200, 0.01);
                    
                    // æ£€æŸ¥æ˜¯å¦æ­»äº¡
                    if (playerHealth <= 0) {
                        handlePlayerDeath();
                    }
                    
                    // éšœç¢ç‰©æ¶ˆå¤±
                    setTimeout(() => {
                        if (obstacle.graphic && !obstacle.graphic.destroyed) {
                            obstacle.graphic.destroy();
                        }
                        const idx = obstacles.indexOf(obstacle);
                        if (idx !== -1) {
                            obstacles.splice(idx, 1);
                        }
                    }, 100);
                }
            });
            
            // æ£€æµ‹åŠ è¡€åŒ…ç¢°æ’
            healthPacks.forEach((pack, index) => {
                if (pack.collected) return;
                
                const distance = Phaser.Math.Distance.Between(
                    balloon.x, balloon.y,
                    pack.x, pack.graphic.y
                );
                
                if (distance < 40) {  // ç¢°æ’åŠå¾„
                    // æ”¶é›†åŠ è¡€åŒ…
                    pack.collected = true;
                    playerHealth = Math.min(maxHealth, playerHealth + 20);
                    updateHealth();
                    
                    // åŠ è¡€åŒ…æ¶ˆå¤±åŠ¨ç”»
                    gameScene.tweens.add({
                        targets: pack.graphic,
                        alpha: 0,
                        scale: 2,
                        duration: 300,
                        onComplete: () => {
                            pack.graphic.destroy();
                            healthPacks.splice(index, 1);
                        }
                    });
                    
                    showFloatingText(gameScene, balloon.x, balloon.y - 50, '+20 HP', 0x00FF00);
                }
            });
        }
        
        // ==================== æ˜¾ç¤ºæµ®åŠ¨æ–‡å­—å‡½æ•° ====================
        function showFloatingText(scene, x, y, text, color) {
            const floatText = scene.add.text(x, y, text, {
                fontSize: '24px',
                fontFamily: 'Inter, sans-serif',
                color: '#' + color.toString(16).padStart(6, '0'),
                fontStyle: 'bold'
            });
            floatText.setOrigin(0.5, 0.5);
            
            scene.tweens.add({
                targets: floatText,
                y: y - 50,
                alpha: 0,
                duration: 1000,
                onComplete: () => floatText.destroy()
            });
        }
        
        // ==================== æ›´æ–°åˆ†æ•°æ˜¾ç¤º ====================
        function updateScore() {
            if (scoreText) {
                scoreText.setText('ğŸª™ ' + score);
            }
        }
        
        // ==================== æ›´æ–°ç”Ÿå‘½å€¼æ˜¾ç¤º ====================
        function updateHealth() {
            if (healthText) {
                const healthPercent = (playerHealth / maxHealth) * 100;
                let color = '#00FF00';  // ç»¿è‰²
                if (healthPercent < 30) {
                    color = '#FF0000';  // çº¢è‰²
                } else if (healthPercent < 60) {
                    color = '#FFA500';  // æ©™è‰²
                }
                
                healthText.setText('â¤ï¸ ' + playerHealth + '/' + maxHealth);
                healthText.setStyle({ color: color });
            }
        }
        
        // ==================== æ›´æ–°æ¸¸æˆåˆ†æ˜¾ç¤º ====================
        function updateCredits() {
            if (creditsText) {
                creditsText.setText('ğŸ’ ' + gameCredits + 'åˆ†');
            }
        }
        
        // ==================== ç©å®¶æ­»äº¡å¤„ç† ====================
        function handlePlayerDeath() {
            if (isDead) return;
            
            isDead = true;
            console.log('ğŸ’€ ç©å®¶æ­»äº¡');
            
            // æ˜¾ç¤ºæ­»äº¡å¼¹çª—
            document.getElementById('death-modal').classList.add('show');
            
            // æ›´æ–°å¤æ´»é€‰é¡¹æ˜¾ç¤º
            document.getElementById('revive-credits-option').textContent = 
                gameCredits >= 100 ? 'æ¶ˆè€—100æ¸¸æˆåˆ†å¤æ´» âœ“' : 'æ¶ˆè€—100æ¸¸æˆåˆ†å¤æ´»ï¼ˆä¸è¶³ï¼‰';
            
            if (gameCredits >= 100) {
                document.getElementById('revive-credits-btn').disabled = false;
            } else {
                document.getElementById('revive-credits-btn').disabled = true;
            }
        }
        
        // ==================== å¤æ´»ç©å®¶ ====================
        function revivePlayer(method) {
            isDead = false;
            playerHealth = 100;
            updateHealth();
            
            document.getElementById('death-modal').classList.remove('show');
            
            console.log('âœ¨ ç©å®¶å¤æ´»ï¼Œæ–¹å¼:', method);
        }

        // ==================== åˆ›å»ºç™½äº‘å‡½æ•° ====================
        function createCloud(scene, x, y, scale) {
            const cloud = scene.add.graphics();
            cloud.x = x;
            cloud.y = y;
            cloud.setScale(scale);
            
            // ç»˜åˆ¶äº‘æœµï¼ˆå¤šä¸ªåœ†å½¢ç»„åˆï¼‰
            cloud.fillStyle(0xFFFFFF, 0.8);  // ç™½è‰²ï¼Œ80%ä¸é€æ˜åº¦
            cloud.fillCircle(0, 0, 20);
            cloud.fillCircle(-15, 5, 15);
            cloud.fillCircle(15, 5, 15);
            cloud.fillCircle(-8, -8, 12);
            cloud.fillCircle(8, -8, 12);
            
            return cloud;
        }

        // ==================== åˆ›å»ºå…¶ä»–ç©å®¶æ°”çƒå‡½æ•° ====================
        function createOtherPlayerBalloon(scene, data) {
            // åˆ›å»ºå®¹å™¨
            const container = scene.add.container(data.x, data.y);
            
            // åˆ›å»ºæ°”çƒæœ¬ä½“
            const body = scene.add.graphics();
            drawStripedBalloon(body);
            container.add(body);
            
            // åˆ›å»ºç¯®å­
            const playerBasket = scene.add.graphics();
            playerBasket.y = 90;
            drawBasket(playerBasket);
            container.add(playerBasket);
            
            // åˆ›å»ºç©å®¶åå­—æ ‡ç­¾
            const nameText = scene.add.text(
                0, -90,
                data.name,
                {
                    fontSize: '14px',
                    fontFamily: 'Inter, sans-serif',
                    color: '#FFFFFF',
                    backgroundColor: '#00000099',
                    padding: { x: 8, y: 4 },
                    fontStyle: '600'
                }
            );
            nameText.setOrigin(0.5, 0.5);
            container.add(nameText);
            
            // è®¾ç½®é€æ˜åº¦ï¼ˆå…¶ä»–ç©å®¶ç¨å¾®é€æ˜ä¸€ç‚¹ï¼‰
            container.setAlpha(0.8);
            
            // è®¾ç½®æ·±åº¦ï¼ˆå’Œä¸»ç©å®¶æ°”çƒä¸€æ ·ï¼Œåœ¨æœ€é«˜å±‚ï¼‰
            container.setDepth(100);
            
            return {
                container: container,
                targetX: data.x,
                targetY: data.y,
                nameText: nameText
            };
        }

        // ==================== åˆ›å»ºåœºæ™¯å‡½æ•° ====================
        function create() {
            // ä¿å­˜åœºæ™¯å¯¹è±¡å¼•ç”¨
            gameScene = this;
            
            console.log('ğŸ® Phaser åœºæ™¯åˆ›å»ºå®Œæˆ');
            console.log('ğŸ“ gameStarted çŠ¶æ€:', gameStarted);
            console.log('ğŸ‘¤ playerName:', playerName);
            
            // å¦‚æœæ¸¸æˆè¿˜æœªå¼€å§‹ï¼ˆç”¨æˆ·æœªè¾“å…¥åå­—ï¼‰ï¼Œç­‰å¾…
            if (!gameStarted) {
                console.log('â³ ç­‰å¾…ç©å®¶è¾“å…¥åå­—...');
                // ä½¿ç”¨äº‹ä»¶ç›‘å¬ç­‰å¾…æ¸¸æˆå¼€å§‹
                return;
            }
            
            // å¦‚æœå·²ç»æœ‰åå­—ï¼Œç›´æ¥åˆå§‹åŒ–
            console.log('ğŸš€ ç«‹å³å¼€å§‹åˆå§‹åŒ–æ¸¸æˆ...');
            initializeGame.call(this);
        }
        
        // ==================== åˆå§‹åŒ–æ¸¸æˆå‡½æ•° ====================
        function initializeGame() {
            // è·å–å½“å‰åœºæ™¯å¯¹è±¡
            const scene = this;

            // ---------- åˆ›å»ºæ¸å˜èƒŒæ™¯å±‚ ----------
            const bgGraphics = scene.add.graphics();
            // å¤©ç©ºæ¸å˜ï¼ˆä»æ·±è“åˆ°æµ…è“ï¼‰
            bgGraphics.fillGradientStyle(0x5B9BD5, 0x5B9BD5, 0x87CEEB, 0x87CEEB, 1);
            bgGraphics.fillRect(0, 0, config.width, config.height);

            // ---------- åˆ›å»ºéšæœºæ¼‚æµ®çš„ç™½äº‘ ----------
            const cloudCount = 6;  // äº‘æœµæ•°é‡
            for (let i = 0; i < cloudCount; i++) {
                const x = Math.random() * config.width;
                const y = Math.random() * (config.height * 0.4) + 50;  // äº‘æœµåœ¨ä¸ŠåŠéƒ¨åˆ†
                const scale = Math.random() * 0.5 + 0.5;  // éšæœºç¼©æ”¾ 0.5-1.0
                const speed = Math.random() * 0.3 + 0.1;  // éšæœºé€Ÿåº¦
                
                const cloud = createCloud(scene, x, y, scale);
                clouds.push({ graphic: cloud, speed: speed });
            }

            // ---------- åˆ›å»ºåƒç´ é£çƒ­æ°”çƒ ----------
            // åˆ›å»ºå®¹å™¨æ¥åŒ…å«æ°”çƒæ‰€æœ‰éƒ¨åˆ†
            balloon = scene.add.container(config.width / 2, config.height / 2);
            
            // åˆ›å»ºæ°”çƒæœ¬ä½“
            balloonBody = scene.add.graphics();
            drawStripedBalloon(balloonBody);
            balloon.add(balloonBody);
            
            // åˆ›å»ºç¯®å­ï¼ˆä½ç½®åœ¨æ°”çƒä¸‹æ–¹ï¼‰
            basket = scene.add.graphics();
            basket.y = 90;  // ç¯®å­åœ¨æ°”çƒä¸‹æ–¹90åƒç´ 
            drawBasket(basket);
            balloon.add(basket);
            
            // åˆ›å»ºç©å®¶åå­—æ ‡ç­¾ï¼ˆåœ¨æ°”çƒä¸Šæ–¹ï¼‰
            playerNameText = scene.add.text(
                0, -90,
                playerName,
                {
                    fontSize: '16px',
                    fontFamily: 'Inter, sans-serif',
                    color: '#FFD700',  // é‡‘è‰²
                    backgroundColor: '#000000CC',
                    padding: { x: 10, y: 5 },
                    fontStyle: 'bold'
                }
            );
            playerNameText.setOrigin(0.5, 0.5);
            balloon.add(playerNameText);
            
            // è®¾ç½®ç©å®¶æ°”çƒçš„æ·±åº¦ï¼ˆæœ€é«˜å±‚ï¼Œç¡®ä¿ä¸è¢«é®æŒ¡ï¼‰
            balloon.setDepth(100);
            
            // ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼Œç”¨äºæ›´æ”¹åå­—æ—¶æ›´æ–°
            playerNameTextObject = playerNameText;

            // ---------- åˆ›å»ºåˆ†æ•°æ˜¾ç¤º ----------
            scoreText = scene.add.text(
                20, 20,
                'ğŸª™ 0',
                {
                    fontSize: '20px',
                    fontFamily: 'Inter, sans-serif',
                    color: '#FFD700',
                    backgroundColor: '#00000099',
                    padding: { x: 12, y: 6 },
                    fontStyle: 'bold'
                }
            );
            scoreText.setScrollFactor(0);
            scoreText.setDepth(1000);
            
            // ---------- åˆ›å»ºç”Ÿå‘½å€¼æ˜¾ç¤º ----------
            healthText = scene.add.text(
                20, 55,
                'â¤ï¸ 100/100',
                {
                    fontSize: '20px',
                    fontFamily: 'Inter, sans-serif',
                    color: '#00FF00',
                    backgroundColor: '#00000099',
                    padding: { x: 12, y: 6 },
                    fontStyle: 'bold'
                }
            );
            healthText.setScrollFactor(0);
            healthText.setDepth(1000);
            
            // ---------- åˆ›å»ºæ¸¸æˆåˆ†æ˜¾ç¤º ----------
            creditsText = scene.add.text(
                20, 90,
                'ğŸ’ 0åˆ†',
                {
                    fontSize: '20px',
                    fontFamily: 'Inter, sans-serif',
                    color: '#00FFFF',
                    backgroundColor: '#00000099',
                    padding: { x: 12, y: 6 },
                    fontStyle: 'bold'
                }
            );
            creditsText.setScrollFactor(0);
            creditsText.setDepth(1000);

            // è®¾ç½®åˆå§‹ç›®æ ‡ä½ç½®ä¸ºå½“å‰ä½ç½®
            targetX = balloon.x;
            targetY = balloon.y;
            previousX = balloon.x;
            
            // åˆå§‹åŒ–åŠ è¡€åŒ…ç”Ÿæˆæ—¶é—´
            lastHealthPackSpawn = Date.now();

            // ---------- æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬ ----------
            scene.input.on('pointerdown', function(pointer) {
                // å½“ç©å®¶ç‚¹å‡»å±å¹•æ—¶ï¼Œæ›´æ–°ç›®æ ‡ä½ç½®
                targetX = pointer.x;
                targetY = pointer.y;
                
                // å‘é€ä½ç½®æ›´æ–°åˆ° Supabase
                sendPositionUpdate(pointer.x, pointer.y);
                
                // ç‚¹å‡»ä½ç½®åé¦ˆæ•ˆæœï¼ˆä¼˜åŒ–ç‰ˆï¼‰
                const marker = scene.add.circle(pointer.x, pointer.y, 8, 0xFFFFFF, 0.6);
                const outerRing = scene.add.circle(pointer.x, pointer.y, 8, 0xFFFFFF, 0);
                outerRing.setStrokeStyle(2, 0xFFFFFF, 0.8);
                
                scene.tweens.add({
                    targets: marker,
                    alpha: 0,
                    scale: 1.5,
                    duration: 400,
                    ease: 'Power2',
                    onComplete: () => marker.destroy()
                });
                
                scene.tweens.add({
                    targets: outerRing,
                    alpha: 0,
                    scale: 3,
                    duration: 600,
                    ease: 'Power2',
                    onComplete: () => outerRing.destroy()
                });
            });

            // ---------- åˆ›å»ºé‡‘é—ªé—ªå¹¿å‘Šä½å¡ç‰‡ ----------
            // å¤–å±‚å…‰æ™•å®¹å™¨
            const adGlowOuter = scene.add.graphics();
            const adGlowMiddle = scene.add.graphics();
            
            // ç»˜åˆ¶å¤šå±‚é‡‘è‰²å…‰æ™•
            adGlowOuter.lineStyle(4, 0xFFD700, 0.3);
            adGlowOuter.strokeRoundedRect(config.width - 245, 10, 230, 70, 15);
            
            adGlowMiddle.lineStyle(3, 0xFFA500, 0.5);
            adGlowMiddle.strokeRoundedRect(config.width - 243, 12, 226, 66, 14);
            
            // åŠé€æ˜èƒŒæ™¯
            const adBg = scene.add.graphics();
            adBg.fillStyle(0xFFFFFF, 0.15);  // ç™½è‰²åŠé€æ˜
            adBg.fillRoundedRect(config.width - 240, 15, 220, 60, 12);
            
            // é‡‘è‰²è¾¹æ¡†
            adBg.lineStyle(2, 0xFFD700, 0.8);
            adBg.strokeRoundedRect(config.width - 240, 15, 220, 60, 12);
            
            // å†…éƒ¨é‡‘é»„è‰²èƒŒæ™¯
            const adInner = scene.add.graphics();
            adInner.fillStyle(0xFFC107, 0.9);  // é‡‘é»„è‰²ï¼Œ90%ä¸é€æ˜åº¦
            adInner.fillRoundedRect(config.width - 235, 20, 210, 50, 10);

            // å¹¿å‘Šä½æ–‡å­—ï¼ˆç°ä»£å­—ä½“ï¼‰
            const adText = scene.add.text(
                config.width - 130,
                42,
                'ğŸ’ å¹¿å‘Šä½æ‹›ç§Ÿ',
                {
                    fontSize: '18px',
                    fontFamily: 'Inter, sans-serif',
                    color: '#1A1A1A',
                    fontStyle: 'bold'
                }
            );
            adText.setOrigin(0.5, 0.5);
            
            // ä»·æ ¼æ–‡å­—
            const priceText = scene.add.text(
                config.width - 130,
                60,
                '$5,000',
                {
                    fontSize: '16px',
                    fontFamily: 'Inter, sans-serif',
                    color: '#D4AF37',  // é‡‘è‰²
                    fontStyle: 'bold'
                }
            );
            priceText.setOrigin(0.5, 0.5);

            // æ·»åŠ é—ªçƒåŠ¨ç”»åˆ°å¹¿å‘Šä½ï¼ˆé‡‘è‰²å…‰æ™•æ•ˆæœï¼‰
            scene.tweens.add({
                targets: [adGlowOuter],
                alpha: 0.1,
                duration: 1500,
                yoyo: true,
                repeat: -1,
                ease: 'Sine.easeInOut'
            });
            
            scene.tweens.add({
                targets: [adGlowMiddle],
                alpha: 0.2,
                duration: 1000,
                yoyo: true,
                repeat: -1,
                ease: 'Sine.easeInOut'
            });
            
            scene.tweens.add({
                targets: [adInner],
                alpha: 0.75,
                duration: 2000,
                yoyo: true,
                repeat: -1,
                ease: 'Sine.easeInOut'
            });

            // ---------- æ·»åŠ æ“ä½œæç¤ºæ–‡å­—ï¼ˆä¼˜åŒ–ç‰ˆï¼Œå®Œå…¨å±…ä¸­ï¼Œå“åº”å¼ï¼‰----------
            const hintBg = scene.add.graphics();
            hintBg.fillStyle(0x000000, 0.5);
            // ä½¿ç”¨æ¸¸æˆç”»å¸ƒçš„ä¸­å¿ƒç‚¹ï¼Œç¡®ä¿åœ¨æ‰€æœ‰è®¾å¤‡ä¸Šéƒ½å±…ä¸­
            const hintWidth = 360;
            const hintHeight = 38;
            const hintX = config.width / 2 - hintWidth / 2;
            const hintY = config.height - 50;
            hintBg.fillRoundedRect(hintX, hintY, hintWidth, hintHeight, 10);
            hintBg.setScrollFactor(0);  // å›ºå®šä½ç½®ï¼Œä¸éšç›¸æœºç§»åŠ¨
            hintBg.setDepth(1000);      // ç¡®ä¿åœ¨æœ€ä¸Šå±‚
            
            const hintText = scene.add.text(
                config.width / 2,  // Xåæ ‡ï¼šç”»å¸ƒå®½åº¦çš„ä¸€åŠ
                config.height - 31, // Yåæ ‡ï¼šè·ç¦»åº•éƒ¨31åƒç´ 
                'ğŸˆ ç‚¹å‡»å±å¹•é£è¡Œ | å¤šäººå®æ—¶åŒæ­¥',
                {
                    fontSize: '16px',
                    fontFamily: 'Inter, sans-serif',
                    color: '#FFFFFF',
                    fontStyle: '600',
                    align: 'center'
                }
            );
            hintText.setOrigin(0.5, 0.5);   // è®¾ç½®æ–‡å­—é”šç‚¹ä¸ºä¸­å¿ƒï¼ˆå…³é”®ï¼ï¼‰
            hintText.setScrollFactor(0);     // å›ºå®šä½ç½®ï¼Œä¸éšç›¸æœºç§»åŠ¨
            hintText.setDepth(1001);         // ç¡®ä¿æ–‡å­—åœ¨èƒŒæ™¯ä¸Šæ–¹
            
            // ---------- åˆå§‹åŒ– Supabase å®æ—¶è¿æ¥ ----------
            initSupabaseRealtime(scene);
            
            // å‘é€åˆå§‹ä½ç½®
            sendPositionUpdate(balloon.x, balloon.y);
            
            // ---------- åŠ è½½å¹¿å‘Šæ°”çƒ ----------
            loadAdBalloonsInGame(scene);
        }  // initializeGame å‡½æ•°ç»“æŸ
        
        // ==================== Supabase å®æ—¶åŒæ­¥å‡½æ•° ====================
        
        // å‘é€ä½ç½®æ›´æ–°åˆ° Supabase
        async function sendPositionUpdate(x, y) {
            // å¦‚æœ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œè·³è¿‡
            if (!supabaseClient) {
                console.warn('âš ï¸ Supabase æœªåˆå§‹åŒ–ï¼Œè·³è¿‡ä½ç½®æ›´æ–°');
                return;
            }
            
            if (!playerName) {
                console.warn('âš ï¸ ç©å®¶åå­—æœªè®¾ç½®ï¼Œè·³è¿‡ä½ç½®æ›´æ–°');
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('balloon_positions')
                    .upsert({
                        player_id: playerId,
                        player_name: playerName,
                        x: Math.round(x),
                        y: Math.round(y),
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'player_id'
                    });
                
                if (error) {
                    console.error('âŒ å‘é€ä½ç½®å¤±è´¥:', error.message);
                } else {
                    console.log('âœ… ä½ç½®å·²å‘é€:', playerName, x, y);
                }
            } catch (err) {
                console.error('âŒ å‘é€ä½ç½®å¼‚å¸¸:', err);
            }
        }
        
        // åˆå§‹åŒ– Supabase å®æ—¶ç›‘å¬
        function initSupabaseRealtime(scene) {
            // å¦‚æœ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œè·³è¿‡
            if (!supabaseClient) {
                console.warn('âš ï¸ Supabase æœªåˆå§‹åŒ–ï¼Œæ¸¸æˆå°†ä»¥å•æœºæ¨¡å¼è¿è¡Œ');
                return;
            }
            
            console.log('ğŸ”Œ åˆå§‹åŒ– Supabase Realtime è¿æ¥...');
            
            try {
                // è®¢é˜… balloon_positions è¡¨çš„å˜åŒ–
                const channel = supabaseClient
                    .channel('balloon_positions_channel')
                    .on(
                        'postgres_changes',
                        {
                            event: '*',  // ç›‘å¬æ‰€æœ‰äº‹ä»¶ï¼ˆINSERT, UPDATE, DELETEï¼‰
                            schema: 'public',
                            table: 'balloon_positions'
                        },
                        (payload) => {
                            handleRealtimeUpdate(scene, payload);
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            console.log('âœ… Realtime è¿æ¥æˆåŠŸï¼');
                            // åŠ è½½ç°æœ‰ç©å®¶
                            loadExistingPlayers(scene);
                        } else if (status === 'CHANNEL_ERROR') {
                            console.error('âŒ Realtime è¿æ¥å¤±è´¥ï¼è¯·æ£€æŸ¥ Supabase é…ç½®');
                        }
                    });
                
                // å®šæœŸæ¸…ç†ç¦»çº¿ç©å®¶ï¼ˆè¶…è¿‡10ç§’æœªæ›´æ–°ï¼‰
                setInterval(() => {
                    cleanupInactivePlayers(scene);
                }, 5000);
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ– Realtime å¤±è´¥:', error);
            }
        }
        
        // å¤„ç†å®æ—¶æ›´æ–°
        function handleRealtimeUpdate(scene, payload) {
            const { eventType, new: newRecord, old: oldRecord } = payload;
            
            // ç¡®ä¿ä½¿ç”¨å…¨å±€çš„gameSceneï¼Œè€Œä¸æ˜¯ä¼ å…¥çš„sceneå‚æ•°
            const actualScene = gameScene || scene;
            
            if (!actualScene) {
                console.warn('âš ï¸ åœºæ™¯æœªåˆå§‹åŒ–ï¼Œå¿½ç•¥å®æ—¶æ›´æ–°');
                return;
            }
            
            if (eventType === 'INSERT' || eventType === 'UPDATE') {
                const data = newRecord;
                
                // å¿½ç•¥è‡ªå·±çš„æ›´æ–°
                if (data.player_id === playerId) {
                    console.log('ğŸ”„ æ”¶åˆ°è‡ªå·±çš„ä½ç½®æ›´æ–°ï¼Œå¿½ç•¥');
                    return;
                }
                
                console.log('ğŸ“¡ æ”¶åˆ°å…¶ä»–ç©å®¶ä½ç½®:', data.player_name, data.x, data.y, 'PlayerId:', data.player_id);
                
                // å¦‚æœæ˜¯æ–°ç©å®¶ï¼Œåˆ›å»ºæ°”çƒ
                if (!otherPlayers[data.player_id]) {
                    console.log('ğŸˆ åˆ›å»ºæ–°ç©å®¶æ°”çƒ:', data.player_name);
                    otherPlayers[data.player_id] = createOtherPlayerBalloon(actualScene, {
                        x: data.x,
                        y: data.y,
                        name: data.player_name
                    });
                    console.log('âœ… æ–°ç©å®¶åŠ å…¥æˆåŠŸ:', data.player_name, 'å½“å‰å…¶ä»–ç©å®¶æ•°:', Object.keys(otherPlayers).length);
                } else {
                    // æ›´æ–°ç°æœ‰ç©å®¶çš„ç›®æ ‡ä½ç½®
                    otherPlayers[data.player_id].targetX = data.x;
                    otherPlayers[data.player_id].targetY = data.y;
                    console.log('ğŸ”„ æ›´æ–°ç©å®¶ä½ç½®:', data.player_name, data.x, data.y);
                }
                
                // æ›´æ–°æœ€åæ´»è·ƒæ—¶é—´
                otherPlayers[data.player_id].lastUpdate = Date.now();
            } else if (eventType === 'DELETE') {
                const data = oldRecord;
                if (otherPlayers[data.player_id]) {
                    otherPlayers[data.player_id].container.destroy();
                    delete otherPlayers[data.player_id];
                    console.log('ğŸ‘‹ ç©å®¶ç¦»å¼€:', data.player_name);
                }
            }
        }
        
        // åŠ è½½ç°æœ‰ç©å®¶
        async function loadExistingPlayers(scene) {
            if (!supabaseClient) return;
            
            try {
                // åªåŠ è½½æœ€è¿‘2åˆ†é’Ÿå†…æ´»è·ƒçš„ç©å®¶
                const twoMinutesAgo = new Date(Date.now() - 2 * 60 * 1000).toISOString();
                
                const { data, error } = await supabaseClient
                    .from('balloon_positions')
                    .select('*')
                    .neq('player_id', playerId)
                    .gte('updated_at', twoMinutesAgo)  // åªåŠ è½½2åˆ†é’Ÿå†…æ›´æ–°çš„ç©å®¶
                    .order('updated_at', { ascending: false })
                    .limit(10);  // æœ€å¤šæ˜¾ç¤º10ä¸ªå…¶ä»–ç©å®¶
                
                if (error) {
                    console.error('âŒ åŠ è½½ç°æœ‰ç©å®¶å¤±è´¥:', error.message);
                    return;
                }
                
                if (data && data.length > 0) {
                    console.log('ğŸ‘¥ åŠ è½½æ´»è·ƒç©å®¶:', data.length, 'äºº');
                    data.forEach(player => {
                        if (!otherPlayers[player.player_id]) {
                            otherPlayers[player.player_id] = createOtherPlayerBalloon(scene, {
                                x: player.x,
                                y: player.y,
                                name: player.player_name
                            });
                            otherPlayers[player.player_id].lastUpdate = Date.now();
                        }
                    });
                } else {
                    console.log('ğŸ‘¥ å½“å‰æ²¡æœ‰å…¶ä»–æ´»è·ƒç©å®¶');
                }
                
                // æ¸…ç†æ•°æ®åº“ä¸­è¶…è¿‡5åˆ†é’Ÿçš„æ—§æ•°æ®
                cleanupOldDataInDatabase();
            } catch (err) {
                console.error('âŒ åŠ è½½ç°æœ‰ç©å®¶å¼‚å¸¸:', err);
            }
        }
        
        // æ¸…ç†ä¸æ´»è·ƒçš„ç©å®¶
        async function cleanupInactivePlayers(scene) {
            const now = Date.now();
            const TIMEOUT = 10000;  // 10ç§’è¶…æ—¶
            
            for (const playerId in otherPlayers) {
                if (now - otherPlayers[playerId].lastUpdate > TIMEOUT) {
                    console.log('ğŸ—‘ï¸ æ¸…ç†ä¸æ´»è·ƒç©å®¶:', playerId);
                    otherPlayers[playerId].container.destroy();
                    delete otherPlayers[playerId];
                }
            }
        }
        
        // æ¸…ç†æ•°æ®åº“ä¸­çš„æ—§æ•°æ®
        async function cleanupOldDataInDatabase() {
            if (!supabaseClient) return;
            
            try {
                // åˆ é™¤5åˆ†é’Ÿå‰çš„æ—§æ•°æ®
                const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
                
                const { error } = await supabaseClient
                    .from('balloon_positions')
                    .delete()
                    .lt('updated_at', fiveMinutesAgo);
                
                if (error) {
                    console.error('âŒ æ¸…ç†æ—§æ•°æ®å¤±è´¥:', error.message);
                } else {
                    console.log('ğŸ§¹ å·²æ¸…ç†5åˆ†é’Ÿå‰çš„æ—§æ•°æ®');
                }
            } catch (err) {
                console.error('âŒ æ¸…ç†æ—§æ•°æ®å¼‚å¸¸:', err);
            }
        }

        // ==================== æ›´æ–°åœºæ™¯å‡½æ•°ï¼ˆæ¯å¸§è°ƒç”¨ï¼‰====================
        function update(time, delta) {
            // ---------- æ›´æ–°ç™½äº‘ä½ç½®ï¼ˆç¼“æ…¢æ¨ªå‘ç§»åŠ¨ï¼‰----------
            clouds.forEach(cloud => {
                cloud.graphic.x += cloud.speed;
                
                // å¦‚æœäº‘æœµç§»å‡ºå±å¹•å³ä¾§ï¼Œåˆ™ä»å·¦ä¾§é‡æ–°è¿›å…¥
                if (cloud.graphic.x > config.width + 100) {
                    cloud.graphic.x = -100;
                    cloud.graphic.y = Math.random() * (config.height * 0.4) + 50;
                }
            });

            // ---------- å‘¼å¸æµ®åŠ¨æ•ˆæœ ----------
            // ä½¿ç”¨æ­£å¼¦å‡½æ•°åˆ›å»ºå¹³æ»‘çš„ä¸Šä¸‹æµ®åŠ¨æ•ˆæœ
            breatheOffset += 0.015;  // æ§åˆ¶å‘¼å¸é€Ÿåº¦ï¼ˆç¨å¾®æ…¢ä¸€ç‚¹æ›´ä¼˜é›…ï¼‰
            const breatheY = Math.sin(breatheOffset) * 8;  // æŒ¯å¹…ä¸º8åƒç´ 
            const breatheScale = 1 + Math.sin(breatheOffset) * 0.03;  // ç¼©æ”¾å˜åŒ– (0.97-1.03)

            // ---------- å¹³æ»‘ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½® ----------
            // è®¡ç®—æ°”çƒå½“å‰ä½ç½®ä¸ç›®æ ‡ä½ç½®çš„è·ç¦»
            const dx = targetX - balloon.x;
            const dy = targetY - balloon.y;
            const distance = Math.sqrt(dx * dx + dy * dy);

            // å¦‚æœè·ç¦»å¤§äº1åƒç´ ï¼Œåˆ™ç»§ç»­ç§»åŠ¨
            if (distance > 1) {
                // ä½¿ç”¨ç¼“åŠ¨æ•ˆæœï¼šæ¯å¸§ç§»åŠ¨è·ç¦»çš„4%ï¼ˆç¨æ…¢ä¸€ç‚¹æ›´ä¼˜é›…ï¼‰
                const easing = 0.04;
                balloon.x += dx * easing;
                balloon.y += dy * easing;
                
                // å®šæœŸå‘é€ä½ç½®æ›´æ–°ï¼ˆèŠ‚æµï¼‰
                if (time - lastUpdateTime > UPDATE_INTERVAL) {
                    sendPositionUpdate(balloon.x, balloon.y);
                    lastUpdateTime = time;
                }
            }

            // ---------- è®¡ç®—å€¾æ–œè§’åº¦ï¼ˆçµåŠ¨æ•ˆæœï¼‰----------
            // æ ¹æ®ç§»åŠ¨æ–¹å‘è®¡ç®—å€¾æ–œè§’åº¦
            const velocityX = balloon.x - previousX;
            previousX = balloon.x;
            
            // ç›®æ ‡å€¾æ–œè§’åº¦ï¼šå‘å·¦é£æ—¶è´Ÿè§’åº¦ï¼Œå‘å³é£æ—¶æ­£è§’åº¦
            const targetRotation = velocityX * 0.1;  // å€¾æ–œå¹…åº¦ç³»æ•°
            
            // å¹³æ»‘è¿‡æ¸¡åˆ°ç›®æ ‡è§’åº¦
            const currentRotation = balloon.angle * (Math.PI / 180);  // è½¬æ¢ä¸ºå¼§åº¦
            const targetRad = Phaser.Math.Clamp(targetRotation, -0.15, 0.15);  // é™åˆ¶æœ€å¤§å€¾æ–œè§’åº¦
            
            // ä½¿ç”¨çº¿æ€§æ’å€¼å¹³æ»‘è¿‡æ¸¡
            balloon.angle = Phaser.Math.Linear(balloon.angle, targetRad * (180 / Math.PI), 0.1);

            // ---------- åº”ç”¨å‘¼å¸æ•ˆæœ ----------
            // æ·»åŠ è½»å¾®çš„å‚ç›´æµ®åŠ¨
            const baseY = balloon.y;
            balloon.y = baseY + breatheY * 0.5;

            // åº”ç”¨ç¼©æ”¾æ•ˆæœï¼ˆæ¨¡æ‹Ÿçƒ­æ°”çƒçš„"å‘¼å¸"ï¼‰
            balloon.setScale(breatheScale);
            
            // ---------- ç”Ÿæˆæ¸¸æˆå…ƒç´  ----------
            spawnGameElements(this);
            
            // ---------- æ£€æµ‹ç¢°æ’ ----------
            checkCollisions();
            
            // ---------- æ¸…ç†è¶…å‡ºå±å¹•çš„å…ƒç´ å’Œè¿‡æœŸé‡‘å¸ ----------
            const now = Date.now();
            coins = coins.filter(coin => {
                if (coin.collected) return false;
                
                // æ£€æŸ¥æ˜¯å¦è¶…å‡ºå±å¹•
                const outOfBounds = coin.x < -50 || coin.x > config.width + 50 || 
                                   coin.y < -50 || coin.y > config.height + 50;
                
                // æ£€æŸ¥æ˜¯å¦è¶…è¿‡12ç§’ï¼ˆé‡‘å¸ä¼šåœ¨10ç§’åå¼€å§‹é—ªçƒï¼Œ12ç§’åæ¶ˆå¤±ï¼‰
                const isExpired = (now - coin.createTime) > 12000;
                
                // æ£€æŸ¥é‡‘å¸å›¾å½¢æ˜¯å¦å·²è¢«é”€æ¯
                const isDestroyed = !coin.graphic || coin.graphic.destroyed;
                
                if ((outOfBounds || isExpired || isDestroyed) && coin.graphic && !coin.graphic.destroyed) {
                    coin.graphic.destroy();
                }
                
                return !outOfBounds && !isExpired && !isDestroyed;
            });
            
            obstacles = obstacles.filter(obstacle => {
                const outOfBounds = obstacle.x < -100 || obstacle.x > config.width + 100;
                if (outOfBounds && obstacle.graphic && !obstacle.graphic.destroyed) {
                    obstacle.graphic.destroy();
                }
                return !outOfBounds;
            });
            
            // æ¸…ç†å·²æ”¶é›†çš„åŠ è¡€åŒ…
            healthPacks = healthPacks.filter(pack => {
                if (pack.collected) return false;
                
                const isDestroyed = !pack.graphic || pack.graphic.destroyed;
                if (isDestroyed && pack.graphic && !pack.graphic.destroyed) {
                    pack.graphic.destroy();
                }
                return !isDestroyed;
            });
            
            // ---------- æ›´æ–°å…¶ä»–ç©å®¶çš„æ°”çƒ ----------
            for (const playerId in otherPlayers) {
                const player = otherPlayers[playerId];
                const container = player.container;
                
                // å¹³æ»‘ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®
                const pdx = player.targetX - container.x;
                const pdy = player.targetY - container.y;
                const pdistance = Math.sqrt(pdx * pdx + pdy * pdy);
                
                if (pdistance > 1) {
                    const easing = 0.04;
                    container.x += pdx * easing;
                    container.y += pdy * easing;
                    
                    // è®¡ç®—å€¾æ–œè§’åº¦
                    const pVelocityX = pdx * easing;
                    const pTargetRotation = pVelocityX * 0.1;
                    const pTargetRad = Phaser.Math.Clamp(pTargetRotation, -0.15, 0.15);
                    container.angle = Phaser.Math.Linear(container.angle, pTargetRad * (180 / Math.PI), 0.1);
                }
                
                // æ·»åŠ å‘¼å¸æ•ˆæœ
                container.y += breatheY * 0.3;
                container.setScale(breatheScale * 0.95);  // å…¶ä»–ç©å®¶ç¨å¾®å°ä¸€ç‚¹
            }
            
            // ---------- æ›´æ–°å¹¿å‘Šæ°”çƒçš„æ™ƒåŠ¨æ•ˆæœ ----------
            adBalloonsObjects.forEach(adObj => {
                if (!adObj.container) return;
                
                // ç¼“æ…¢çš„å·¦å³æ™ƒåŠ¨
                adObj.swayOffset += 0.008;  // æ™ƒåŠ¨é€Ÿåº¦
                const swayX = Math.sin(adObj.swayOffset) * 15;  // æ™ƒåŠ¨å¹…åº¦ 15 åƒç´ 
                const swayY = Math.cos(adObj.swayOffset * 0.5) * 10;  // è½»å¾®ä¸Šä¸‹æµ®åŠ¨
                
                adObj.container.x = adObj.baseX + swayX;
                adObj.container.y = adObj.baseY + swayY;
                
                // è½»å¾®çš„å€¾æ–œ
                const swayAngle = Math.sin(adObj.swayOffset) * 3;  // å€¾æ–œè§’åº¦ Â±3åº¦
                adObj.container.angle = swayAngle;
            });
        }
        
        // ==================== é¡µé¢å…³é—­æ—¶æ¸…ç† ====================
        window.addEventListener('beforeunload', async () => {
            // åˆ é™¤è‡ªå·±çš„ä½ç½®è®°å½•
            if (!supabaseClient) return;
            
            try {
                await supabaseClient
                    .from('balloon_positions')
                    .delete()
                    .eq('player_id', playerId);
            } catch (err) {
                console.error('æ¸…ç†ä½ç½®è®°å½•å¤±è´¥:', err);
            }
        });
    </script>
</body>
</html>