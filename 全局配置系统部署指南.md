# 🌍 全局配置系统部署指南

## 更新时间：2026年2月12日
## 版本：v2.1.0

---

## ⚠️ 重要说明

这是一个**重大升级**！现在所有游戏配置都保存在 Supabase 数据库中，所有玩家共享相同的配置。

### 核心变化

**之前（v2.0.x）**：
- ❌ 配置保存在 `localStorage`（本地浏览器）
- ❌ 每个玩家有自己的配置
- ❌ 管理员设置不影响其他玩家
- ❌ 不同设备看到不同的游戏

**现在（v2.1.0）**：
- ✅ 配置保存在 Supabase 数据库（云端）
- ✅ 所有玩家使用相同的配置
- ✅ 管理员设置立即全局生效
- ✅ 所有设备看到相同的游戏

---

## 🚀 部署步骤（必须完成）

### 步骤1：登录 Supabase Dashboard

1. 访问：https://supabase.com/dashboard
2. 选择你的项目：`ksctfambipodjbrtjaby`
3. 进入 **SQL Editor**（左侧菜单）

### 步骤2：创建全局配置表

1. 点击 **"New Query"**（新建查询）
2. 复制 `setup_global_settings.sql` 文件的全部内容
3. 粘贴到 SQL 编辑器
4. 点击 **"Run"**（运行）按钮

#### SQL 脚本内容预览

```sql
-- 创建全局设置表
CREATE TABLE IF NOT EXISTS public.global_game_settings (
  id TEXT PRIMARY KEY DEFAULT 'default',
  
  -- 金币参数
  coin_spawn_rate DECIMAL DEFAULT 0.02,
  coin_max_count INTEGER DEFAULT 15,
  coin_lifetime INTEGER DEFAULT 12000,
  
  -- 钻石参数
  diamond_spawn_interval INTEGER DEFAULT 100000,
  diamond_spawn_count INTEGER DEFAULT 5,
  diamond_max_count INTEGER DEFAULT 5,
  
  -- 障碍物参数
  obstacle_spawn_rate DECIMAL DEFAULT 0.005,
  obstacle_max_count INTEGER DEFAULT 6,
  
  -- 加血包参数
  health_pack_interval INTEGER DEFAULT 100000,
  health_pack_count INTEGER DEFAULT 2,
  health_pack_lifetime INTEGER DEFAULT 8000,
  
  -- 广告气球设置（JSON格式）
  ad_balloons JSONB DEFAULT '[]'::jsonb,
  
  -- 支付设置（JSON格式）
  payment_settings JSONB DEFAULT '{...}'::jsonb,
  
  -- 更新时间
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_by TEXT DEFAULT 'admin'
);

-- 插入默认配置
INSERT INTO public.global_game_settings (id)
VALUES ('default')
ON CONFLICT (id) DO NOTHING;

-- 启用 RLS
ALTER TABLE public.global_game_settings ENABLE ROW LEVEL SECURITY;

-- 所有人可以读取
CREATE POLICY "所有人可以读取全局设置"
ON public.global_game_settings
FOR SELECT
TO public
USING (true);

-- 允许更新（客户端验证管理员权限）
CREATE POLICY "允许更新全局设置"
ON public.global_game_settings
FOR UPDATE
TO public
USING (true)
WITH CHECK (true);
```

### 步骤3：验证表创建成功

1. 在 SQL 编辑器中运行：
```sql
SELECT * FROM public.global_game_settings WHERE id = 'default';
```

2. **预期结果**：应该看到一条记录，包含所有默认值

3. 如果看到错误，请检查：
   - 是否运行了完整的 SQL 脚本
   - 是否有权限创建表
   - 网络连接是否正常

---

## ✅ 验证部署（10分钟测试）

### 测试1：管理员设置生效（5分钟）

#### 准备工作
- 使用2个不同的设备（或2个浏览器窗口）
- 设备A：管理员
- 设备B：普通玩家

#### 步骤A：设备A - 管理员修改配置
1. 访问游戏：https://my-balloon-game.vercel.app/
2. 输入名字登录
3. 点击"⚙️ 管理员设置"
4. 输入账号：`DDKJ`，密码：`DDKJ88888888`
5. 切换到"🎮 游戏参数"
6. 修改"金币最大数量"为 **8**
7. 点击"保存参数"
8. **检查**：是否提示"🌍 所有玩家将使用这些配置！"？

#### 步骤B：设备B - 普通玩家验证
1. 在设备B访问游戏（不要登录管理员）
2. 输入不同的名字登录
3. 等待金币生成
4. **检查**：金币数量是否不超过8个？（管理员设置的值）

#### 预期结果
- ✅ 设备B看到管理员设置的金币数量限制
- ✅ 设备B无法修改游戏参数（需要管理员权限）
- ✅ 配置立即生效，无需刷新

---

### 测试2：广告气球全局显示（3分钟）

#### 步骤A：设备A - 管理员添加广告
1. 管理员设置 → 广告管理
2. 添加一个广告气球：
   - 广告词：`测试广告`
   - 位置：`X=400, Y=300`
   - 透明度：`0.3`
3. 点击"添加广告气球"
4. **检查**：是否提示"🌍 所有玩家现在可以看到这个广告！"？

#### 步骤B：设备B - 普通玩家验证
1. 在设备B的游戏界面中观察
2. **检查**：是否看到"测试广告"背景气球？
3. **检查**：位置和透明度是否正确？

#### 预期结果
- ✅ 设备B立即看到管理员添加的广告
- ✅ 广告位置、透明度正确
- ✅ 玩家气球在广告之上

---

### 测试3：支付设置全局生效（2分钟）

#### 步骤A：设备A - 管理员设置支付
1. 管理员设置 → 支付设置
2. 上传支付宝收款码（任意图片）
3. **检查**：是否提示"🌍 所有玩家现在可以看到这个收款码！"？

#### 步骤B：设备B - 普通玩家验证
1. 在设备B点击"💰 充值"按钮
2. 选择"支付宝"支付方式
3. **检查**：是否看到管理员上传的收款码图片？

#### 预期结果
- ✅ 设备B看到管理员设置的收款码
- ✅ 不再显示"请管理员先设置收款码"
- ✅ 支付设置全局同步

---

## 📝 使用说明

### 管理员操作流程

#### 1. 修改游戏参数
```
访问游戏 → 管理员设置 → 游戏参数 → 修改数值 → 保存参数
```

**立即生效**：下次元素生成时使用新参数

#### 2. 添加广告气球
```
管理员设置 → 广告管理 → 填写信息 → 添加广告气球
```

**立即生效**：所有玩家立即看到新广告

#### 3. 设置支付方式
```
管理员设置 → 支付设置 → 上传收款码/填写信息 → 保存
```

**立即生效**：所有玩家充值时看到新设置

### 普通玩家体验

#### 自动加载配置
```
访问游戏 → 输入名字 → [自动加载全局配置] → 开始游戏
```

**特点**：
- ✅ 无需任何设置
- ✅ 自动使用最新配置
- ✅ 与所有玩家体验一致

---

## 🔧 技术细节

### 数据库结构

**表名**：`public.global_game_settings`

**主键**：`id = 'default'`（固定值，全表只有一条记录）

**字段列表**：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | TEXT | 固定为'default' |
| coin_spawn_rate | DECIMAL | 金币生成概率 |
| coin_max_count | INTEGER | 金币最大数量 |
| coin_lifetime | INTEGER | 金币存在时间 |
| diamond_spawn_interval | INTEGER | 钻石生成间隔 |
| diamond_spawn_count | INTEGER | 每次生成钻石数量 |
| diamond_max_count | INTEGER | 钻石最大数量 |
| obstacle_spawn_rate | DECIMAL | 障碍物生成概率 |
| obstacle_max_count | INTEGER | 障碍物最大数量 |
| health_pack_interval | INTEGER | 加血包生成间隔 |
| health_pack_count | INTEGER | 每次生成加血包数量 |
| health_pack_lifetime | INTEGER | 加血包停留时间 |
| ad_balloons | JSONB | 广告气球数据（JSON数组） |
| payment_settings | JSONB | 支付设置（JSON对象） |
| updated_at | TIMESTAMP | 最后更新时间 |
| updated_by | TEXT | 最后更新者 |

### 数据流程

#### 加载配置
```
玩家登录 
  → startGame()函数
  → loadGlobalSettings() 异步函数
  → SELECT * FROM global_game_settings WHERE id = 'default'
  → 更新本地变量（gameSettings, adBalloons, paymentSettings）
  → 初始化游戏
```

#### 保存配置
```
管理员修改配置
  → 点击保存按钮
  → saveGlobalSettings() 异步函数
  → UPDATE global_game_settings SET ... WHERE id = 'default'
  → 提示保存成功
```

### RLS（Row Level Security）策略

1. **读取策略**：所有人都可以读取（SELECT）
   ```sql
   CREATE POLICY "所有人可以读取全局设置"
   ON public.global_game_settings
   FOR SELECT TO public USING (true);
   ```

2. **更新策略**：所有人都可以更新（UPDATE）
   ```sql
   CREATE POLICY "允许更新全局设置"
   ON public.global_game_settings
   FOR UPDATE TO public USING (true) WITH CHECK (true);
   ```

⚠️ **注意**：管理员权限在客户端验证（账号：DDKJ，密码：DDKJ88888888）

---

## 🐛 常见问题

### Q1：为什么游戏启动后看不到配置？

**可能原因**：
1. Supabase 表未创建
2. 网络连接问题
3. 浏览器缓存旧版本

**解决方案**：
1. 检查 Supabase 中表是否存在
2. 打开浏览器 Console（F12）查看日志
3. 强制刷新：`Ctrl + F5`（Windows）或 `Cmd + Shift + R`（Mac）

### Q2：管理员修改配置后，其他玩家没有更新？

**可能原因**：
1. 其他玩家未刷新页面
2. 配置未成功保存到数据库

**解决方案**：
1. 其他玩家刷新页面
2. 管理员检查 Console 是否有保存成功的日志
3. 在 Supabase SQL Editor 中查询确认：
```sql
SELECT * FROM global_game_settings WHERE id = 'default';
```

### Q3：收款码上传后显示不出来？

**可能原因**：
1. 图片未保存到数据库
2. 图片太大（超过1MB）

**解决方案**：
1. 检查上传时是否有成功提示
2. 使用小一点的图片（建议<500KB）
3. 刷新页面重新测试

### Q4：所有玩家都能修改配置？

**回答**：
- ❌ 不能！只有知道管理员密码的人才能修改
- ✅ 但技术上，任何人都可以直接修改数据库（如果有Supabase访问权限）

**建议**：
- 不要泄露管理员密码
- 不要给其他人 Supabase 项目访问权限
- 未来版本可以实现更严格的权限控制

---

## 📊 监控和维护

### 查看当前配置

在 Supabase SQL Editor 中运行：

```sql
SELECT 
  id,
  coin_max_count AS 金币上限,
  obstacle_max_count AS 障碍物上限,
  health_pack_count AS 加血包数量,
  updated_at AS 最后更新时间,
  updated_by AS 更新者
FROM global_game_settings 
WHERE id = 'default';
```

### 查看广告数量

```sql
SELECT 
  id,
  jsonb_array_length(ad_balloons) AS 广告数量,
  ad_balloons
FROM global_game_settings 
WHERE id = 'default';
```

### 备份配置

```sql
-- 导出当前配置（复制结果保存）
SELECT * FROM global_game_settings WHERE id = 'default';
```

### 恢复默认配置

```sql
UPDATE global_game_settings
SET 
  coin_spawn_rate = 0.02,
  coin_max_count = 15,
  coin_lifetime = 12000,
  diamond_spawn_interval = 100000,
  diamond_spawn_count = 5,
  diamond_max_count = 5,
  obstacle_spawn_rate = 0.005,
  obstacle_max_count = 6,
  health_pack_interval = 100000,
  health_pack_count = 2,
  health_pack_lifetime = 8000,
  ad_balloons = '[]'::jsonb,
  payment_settings = '{
    "alipayQRCode": "",
    "wechatQRCode": "",
    "visaAccount": "",
    "visaCardLast4": "",
    "mastercardAccount": "",
    "mastercardCardLast4": ""
  }'::jsonb,
  updated_at = NOW(),
  updated_by = 'system_reset'
WHERE id = 'default';
```

---

## 🚀 下一步

1. **必须**：执行 `setup_global_settings.sql` 创建表
2. **推荐**：完成10分钟验证测试
3. **可选**：设置监控和定期备份

---

## 📞 支持

如果遇到问题：

1. 检查 Supabase Dashboard 中表是否正确创建
2. 查看浏览器 Console 日志
3. 提供截图和详细步骤描述

---

**版本：v2.1.0** | **更新时间：2026年2月12日** | **部署完成后立即生效** ✅
