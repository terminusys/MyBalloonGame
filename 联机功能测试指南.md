# 🎮 联机功能测试和故障排除指南

## 📝 概述

这份指南将帮你一步步测试和修复游戏的多人联机功能。

---

## 🔧 第一步：检查 Supabase 配置

### 1.1 登录 Supabase Dashboard

1. 访问：https://supabase.com/dashboard
2. 找到你的项目：`ksctfambipodjbrtjaby`

### 1.2 运行验证脚本

1. 在 Supabase Dashboard 中，点击左侧菜单：**SQL Editor**
2. 点击 **New query**
3. 复制并粘贴 `verify_realtime_setup.sql` 中的所有内容
4. 点击 **Run** 运行

**预期结果：**

应该看到类似这样的输出：

```
✅ balloon_positions 表存在
✅ balloon_positions 已添加到 Realtime Publication
✅ RLS 已启用
✅ RLS 策略配置完整（4 条）
✅ 索引已创建
```

**如果看到任何 ❌ 或 ⚠️：**

取消 SQL 脚本底部修复部分的注释，并运行修复脚本。

---

### 1.3 手动检查 Realtime 状态（重要！）

1. 在 Supabase Dashboard 中，点击左侧菜单：**Database** → **Replication**
2. 找到 `balloon_positions` 表
3. 确保 **Source** 列中的开关是 **✅ 开启状态**（绿色）
4. 如果是灰色的，点击开关将其启用

**这一步非常关键！** 如果这里没有启用，Realtime 功能就不会工作。

---

## 🌐 第二步：测试游戏

### 2.1 准备测试环境

你需要：
- **2个或更多浏览器标签页** 或
- **2台不同的设备**（手机 + 电脑）

### 2.2 第一个玩家（测试者A）

1. **打开游戏**
   - 访问：https://www.mysupergame.top/
   
2. **打开开发者工具**
   - 按 `F12` 键
   - 切换到 **Console（控制台）** 标签页

3. **登录游戏**
   - 输入用户名和密码登录

4. **查看控制台日志**

**正常情况应该看到：**

```
✅ Supabase 客户端初始化成功
🎈 当前玩家: 飞行员 XXX
🔌 [Realtime] 初始化 Supabase Realtime 连接...
🔌 [Realtime] Supabase URL: https://ksctfambipodjbrtjaby.supabase.co
🔌 [Realtime] 当前玩家ID: xxx-xxx-xxx
🔔 [Realtime] 订阅状态变化: SUBSCRIBED
✅ [Realtime] 连接成功！开始监听其他玩家...
👥 [LoadPlayers] 开始加载现有玩家...
👥 [LoadPlayers] 当前没有其他活跃玩家
```

**如果看到错误：**

```
❌ [Realtime] 连接失败！请检查 Supabase 配置
```

→ 返回第一步，检查 Supabase 配置

---

### 2.3 第二个玩家（测试者B）

1. **在新标签页打开游戏**
   - 访问：https://www.mysupergame.top/
   
2. **同样打开开发者工具** (F12)

3. **登录游戏**（使用不同的账号或注册新账号）

4. **移动你的气球**
   - 使用鼠标或触摸屏拖动气球

5. **查看控制台日志**

**应该看到：**

```
✅ [Realtime] 连接成功！
👥 [LoadPlayers] 加载活跃玩家: 1 人
👥 [LoadPlayers] 玩家列表: 飞行员 XXX (xxx-xxx-xxx)
🎈 [LoadPlayers] 创建玩家气球: 飞行员 XXX at 400 300
✅ [LoadPlayers] 当前其他玩家数量: 1
```

---

### 2.4 测试双向同步

1. **在测试者A的标签页中移动气球**
   
2. **切换到测试者B的标签页**
   - 应该能看到测试者A的气球在移动

3. **在测试者B的标签页中移动气球**

4. **切换到测试者A的标签页**
   - 应该能看到测试者B的气球在移动

**预期行为：**
- 每次移动气球时，控制台应该显示：
  ```
  📤 [Position] 发送位置更新: {...}
  ✅ [Position] 位置发送成功
  ```

- 其他玩家的标签页应该显示：
  ```
  📨 [Realtime] Channel 收到消息
  🔔 [Realtime] 收到更新 payload: {...}
  📡 收到其他玩家位置: 飞行员 XXX ...
  🔄 更新玩家位置: ...
  ```

---

## 🐛 第三步：故障排除

### 问题 1：Realtime 连接失败

**症状：**
```
❌ [Realtime] 连接失败！请检查 Supabase 配置
```

**解决方案：**

1. **检查 Supabase 项目状态**
   - 在 Supabase Dashboard 中查看项目是否正常运行
   - 项目状态应该是 "Active"

2. **检查 Realtime 功能是否启用**
   - Database → Replication
   - 确保 `balloon_positions` 表的 Realtime 已启用

3. **检查 Publication**
   - 在 SQL Editor 中运行：
     ```sql
     SELECT * FROM pg_publication_tables WHERE pubname = 'supabase_realtime';
     ```
   - 应该看到 `balloon_positions` 在结果中

4. **重新运行 setup_supabase.sql**
   - 复制 `setup_supabase.sql` 的内容
   - 在 SQL Editor 中运行

---

### 问题 2：看不到其他玩家

**症状：**
- Realtime 连接成功
- 但看不到其他玩家的气球

**解决方案：**

1. **检查是否真的有其他玩家在线**
   - 在 SQL Editor 中运行：
     ```sql
     SELECT * FROM public.balloon_positions 
     WHERE updated_at > NOW() - INTERVAL '2 minutes';
     ```
   - 应该能看到所有活跃玩家的记录

2. **检查位置是否正在发送**
   - 在控制台中查找：
     ```
     📤 [Position] 发送位置更新
     ✅ [Position] 位置发送成功
     ```
   - 如果没有这些日志，说明位置没有发送

3. **检查是否收到 Realtime 更新**
   - 在控制台中查找：
     ```
     📨 [Realtime] Channel 收到消息
     ```
   - 如果没有，说明 Realtime 订阅有问题

4. **尝试手动插入测试数据**
   - 在 SQL Editor 中运行：
     ```sql
     INSERT INTO public.balloon_positions (player_id, player_name, x, y, updated_at)
     VALUES ('test-player-123', '测试玩家', 400, 300, NOW())
     ON CONFLICT (player_id) DO UPDATE SET
       x = 400, y = 300, updated_at = NOW();
     ```
   - 刷新游戏页面，应该能看到这个测试玩家

---

### 问题 3：位置发送失败

**症状：**
```
❌ [Position] 发送位置失败: ...
```

**可能原因和解决方案：**

1. **RLS 策略问题**
   - 在 SQL Editor 中运行 `verify_realtime_setup.sql` 的修复部分
   - 确保所有4个 RLS 策略都存在

2. **权限问题**
   - 检查 Supabase Anon Key 是否正确
   - 在 `index.html` 中查找：
     ```javascript
     const SUPABASE_ANON_KEY = 'sb_publishable_...';
     ```
   - 与 Supabase Dashboard → Settings → API 中的 `anon public` key 对比

3. **表结构问题**
   - 在 SQL Editor 中运行：
     ```sql
     \d public.balloon_positions
     ```
   - 检查表结构是否正确

---

### 问题 4：看到错误 "relation does not exist"

**症状：**
```
relation "public.balloon_positions" does not exist
```

**解决方案：**

重新创建表：

```sql
-- 删除旧表（如果存在）
DROP TABLE IF EXISTS public.balloon_positions CASCADE;

-- 重新运行 setup_supabase.sql 的所有内容
```

---

### 问题 5：WebSocket 连接被阻断

**症状：**
- 在中国大陆访问时，Realtime 无法连接
- 控制台显示 WebSocket 连接超时

**解决方案：**

1. **确认 CloudFlare 配置正确**
   - 你已经用 CloudFlare 绕过墙了
   - 确保 WebSocket 支持已启用

2. **检查 Supabase Realtime 端点**
   - Supabase Realtime 使用 WebSocket
   - 端点通常是：`wss://ksctfambipodjbrtjaby.supabase.co/realtime/v1/websocket`

3. **测试 WebSocket 连接**
   - 在浏览器开发者工具中：
   - F12 → Network → WS（WebSocket）
   - 刷新页面
   - 应该能看到一个到 Supabase 的 WebSocket 连接

---

## 📊 完整的测试清单

完成以下所有检查项：

### Supabase 配置
- [ ] `balloon_positions` 表已创建
- [ ] Realtime Publication 已配置
- [ ] RLS 已启用且策略正确
- [ ] Replication 页面中表的 Realtime 开关已打开

### 游戏测试
- [ ] 可以正常登录游戏
- [ ] 控制台显示 Realtime 连接成功
- [ ] 可以看到 "位置发送成功" 的日志
- [ ] 多个标签页能互相看到对方的气球
- [ ] 气球移动有实时同步

### 网络测试
- [ ] 墙外可以访问
- [ ] 墙内通过 CloudFlare 可以访问
- [ ] WebSocket 连接正常

---

## 🎯 测试成功的标志

当一切正常时，你应该能：

1. ✅ 在多个设备/标签页同时打开游戏
2. ✅ 每个玩家都能看到其他玩家的气球
3. ✅ 气球移动实时同步，延迟小于1秒
4. ✅ 控制台没有任何错误信息
5. ✅ 玩家离开时，气球在其他设备上消失

---

## 📱 联系支持

如果按照这份指南仍然无法解决问题，请提供：

1. **Supabase Dashboard 截图**
   - Database → Replication 页面
   - SQL Editor 运行 `verify_realtime_setup.sql` 的结果

2. **浏览器控制台日志**
   - 完整的 Console 输出（复制或截图）

3. **网络面板截图**
   - F12 → Network → WS（WebSocket）
   - 显示 WebSocket 连接状态

4. **测试环境信息**
   - 浏览器类型和版本
   - 操作系统
   - 是否使用 VPN 或代理

---

**祝测试顺利！🎈✨**
