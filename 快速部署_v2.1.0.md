# ⚡ 快速部署指南 - v2.1.0

## 🚨 紧急：必须先执行此步骤！

---

## 第一步：创建数据库表（5分钟）

### 1. 打开 Supabase Dashboard

访问：https://supabase.com/dashboard/project/ksctfambipodjbrtjaby

### 2. 进入 SQL Editor

左侧菜单 → **SQL Editor**

### 3. 复制SQL脚本

打开文件：`setup_global_settings.sql`

**或者直接复制下面的内容**：

```sql
-- 创建全局设置表
CREATE TABLE IF NOT EXISTS public.global_game_settings (
  id TEXT PRIMARY KEY DEFAULT 'default',
  coin_spawn_rate DECIMAL DEFAULT 0.02,
  coin_max_count INTEGER DEFAULT 15,
  coin_lifetime INTEGER DEFAULT 12000,
  diamond_spawn_interval INTEGER DEFAULT 100000,
  diamond_spawn_count INTEGER DEFAULT 5,
  diamond_max_count INTEGER DEFAULT 5,
  obstacle_spawn_rate DECIMAL DEFAULT 0.005,
  obstacle_max_count INTEGER DEFAULT 6,
  health_pack_interval INTEGER DEFAULT 100000,
  health_pack_count INTEGER DEFAULT 2,
  health_pack_lifetime INTEGER DEFAULT 8000,
  ad_balloons JSONB DEFAULT '[]'::jsonb,
  payment_settings JSONB DEFAULT '{
    "alipayQRCode": "",
    "wechatQRCode": "",
    "visaAccount": "",
    "visaCardLast4": "",
    "mastercardAccount": "",
    "mastercardCardLast4": ""
  }'::jsonb,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_by TEXT DEFAULT 'admin'
);

-- 插入默认配置
INSERT INTO public.global_game_settings (id)
VALUES ('default')
ON CONFLICT (id) DO NOTHING;

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_global_settings_updated_at 
ON public.global_game_settings (updated_at);

-- 启用 RLS
ALTER TABLE public.global_game_settings ENABLE ROW LEVEL SECURITY;

-- 所有人可以读取
CREATE POLICY "所有人可以读取全局设置"
ON public.global_game_settings
FOR SELECT
TO public
USING (true);

-- 允许更新
CREATE POLICY "允许更新全局设置"
ON public.global_game_settings
FOR UPDATE
TO public
USING (true)
WITH CHECK (true);
```

### 4. 运行SQL

1. 粘贴到 SQL 编辑器
2. 点击 **"Run"** 按钮（或按 `Ctrl + Enter`）
3. 等待执行完成

### 5. 验证创建成功

运行这条查询：

```sql
SELECT * FROM public.global_game_settings WHERE id = 'default';
```

**预期结果**：应该看到一条记录，包含所有默认值。

✅ **如果看到记录，说明创建成功！**

---

## 第二步：等待自动部署（1-2分钟）

Vercel 会自动检测到代码更新并重新部署。

**访问**：https://my-balloon-game.vercel.app/

**强制刷新**：`Ctrl + F5`（Windows）或 `Cmd + Shift + R`（Mac）

---

## 第三步：快速测试（3分钟）

### 测试1：管理员设置（2分钟）

1. 访问游戏，输入名字登录
2. 点击 **"⚙️ 管理员设置"**
3. 输入账号：`DDKJ`，密码：`DDKJ88888888`
4. 修改 **"金币最大数量"** 为 `10`
5. 点击 **"保存参数"**
6. ✅ **检查**：是否提示 "🌍 所有玩家将使用这些配置！"？

### 测试2：其他设备验证（1分钟）

1. 用另一个设备（或浏览器无痕模式）访问游戏
2. 输入不同的名字登录
3. 等待金币生成
4. ✅ **检查**：金币数量是否不超过 10 个？

**如果通过，说明全局配置系统工作正常！** 🎉

---

## 第四步：测试广告和支付（可选）

### 测试广告（1分钟）

1. 管理员设置 → 广告管理
2. 添加一个测试广告：
   - 广告词：`测试`
   - 位置：`X=400, Y=300`
3. 用另一个设备查看
4. ✅ **检查**：是否看到广告？

### 测试支付（1分钟）

1. 管理员设置 → 支付设置
2. 上传支付宝收款码（任意图片）
3. 用另一个设备点击"充值"
4. 选择"支付宝"
5. ✅ **检查**：是否看到收款码？

---

## ⚠️ 如果出错

### 错误1：表创建失败

**症状**：SQL运行时报错

**解决**：
1. 检查是否连接到正确的项目
2. 检查网络连接
3. 尝试删除旧表（如果存在）：
```sql
DROP TABLE IF EXISTS public.global_game_settings CASCADE;
```
然后重新运行创建脚本

### 错误2：游戏加载失败

**症状**：Console显示错误

**解决**：
1. 强制刷新：`Ctrl + F5`
2. 清除浏览器缓存
3. 检查 Console 具体错误信息
4. 确认 Supabase 表已创建

### 错误3：配置不生效

**症状**：修改配置后其他玩家没有更新

**解决**：
1. 其他玩家刷新页面
2. 检查保存时是否有成功提示
3. 在 Supabase 中查询确认：
```sql
SELECT * FROM global_game_settings WHERE id = 'default';
```

---

## 📝 重要提示

### ✅ 现在的工作方式

- 所有配置保存在 **Supabase 云端**
- 所有玩家使用 **相同的配置**
- 管理员设置 **立即全局生效**

### ❌ 不再使用

- ~~localStorage~~（本地存储）
- ~~每个玩家独立配置~~

### 🔐 管理员权限

- 账号：`DDKJ`
- 密码：`DDKJ88888888`
- **请妥善保管密码！**

---

## 🎉 完成！

如果所有测试通过，说明全局配置系统部署成功！

**现在你可以**：
- ✅ 作为管理员控制所有游戏参数
- ✅ 添加广告，所有玩家可见
- ✅ 设置支付方式，全局统一
- ✅ 所有配置云端保存，永不丢失

---

**版本：v2.1.0** | **部署时间：<2分钟** | **测试时间：<5分钟** ⚡
