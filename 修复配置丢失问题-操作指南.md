# 🔧 修复配置刷新后丢失问题 - 操作指南

## 📋 问题描述

**现象：** 刷新浏览器后，管理员设置（广告设置、游戏参数、支付设置）都恢复到了默认值。

**原因：** Supabase数据库表结构与代码不匹配。旧的SQL脚本使用独立字段结构，而新代码期望使用JSONB字段结构。

---

## ✅ 解决方案

### 步骤1：在Supabase执行新SQL脚本

1. **访问Supabase控制台**
   - 网址：https://supabase.com/dashboard
   - 选择您的项目：`ksctfambipodjbrtjaby`

2. **打开SQL编辑器**
   - 左侧菜单 → **"SQL Editor"**
   - 点击 **"New query"**

3. **复制并执行以下SQL**

```sql
-- ==================== 全局游戏配置表 v2.0 ====================
-- 删除旧表
DROP TABLE IF EXISTS public.global_game_settings CASCADE;

-- 创建新表（使用JSONB字段）
CREATE TABLE IF NOT EXISTS public.global_game_settings (
  id TEXT PRIMARY KEY DEFAULT 'default',
  settings JSONB NOT NULL DEFAULT '{}'::jsonb,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 插入默认配置
INSERT INTO public.global_game_settings (id, settings) 
VALUES ('default', '{
  "coinSpawnRate": 0.02,
  "coinMaxCount": 15,
  "coinLifeTime": 12000,
  "diamondSpawnInterval": 100000,
  "diamondSpawnCount": 5,
  "diamondMaxCount": 5,
  "obstacleSpawnRate": 0.005,
  "obstacleMaxCount": 6,
  "healthPackInterval": 100000,
  "healthPackSpawnCount": 2,
  "healthPackLifeTime": 8000,
  "adBalloons": [],
  "paymentSettings": {
    "alipayQRCode": null,
    "wechatQRCode": null,
    "visaAccountName": "",
    "visaCardNumber": "",
    "mastercardAccountName": "",
    "mastercardCardNumber": ""
  }
}'::jsonb)
ON CONFLICT (id) DO NOTHING;

-- 启用 RLS
ALTER TABLE public.global_game_settings ENABLE ROW LEVEL SECURITY;

-- 删除旧策略
DROP POLICY IF EXISTS "所有人可以读取全局设置" ON public.global_game_settings;
DROP POLICY IF EXISTS "允许更新全局设置" ON public.global_game_settings;

-- 创建新策略
CREATE POLICY "所有人可以读取全局设置"
ON public.global_game_settings FOR SELECT TO public USING (true);

CREATE POLICY "允许更新全局设置"
ON public.global_game_settings FOR UPDATE TO public
USING (true) WITH CHECK (true);

CREATE POLICY "允许插入全局设置"
ON public.global_game_settings FOR INSERT TO public
WITH CHECK (true);

-- 查看结果
SELECT * FROM public.global_game_settings WHERE id = 'default';
```

4. **点击"Run"按钮**（或按 `Ctrl + Enter`）

5. **检查执行结果**
   - 底部应该显示一条记录
   - `id` 为 "default"
   - `settings` 包含所有配置的JSON对象
   - `updated_at` 显示当前时间

---

### 步骤2：验证修复

1. **刷新游戏页面**
   - 访问：https://my-balloon-game.vercel.app/
   - 强制刷新：`Ctrl + Shift + R`

2. **登录超级管理员**
   - 用户名：**DDKJ**
   - 密码：**DDKJ88888888**

3. **测试配置保存**
   - 点击"⚙️ 管理员设置"
   - 切换到"🎮 游戏参数"
   - 修改"金币最大数量"为 **20**
   - 点击"💾 保存游戏设置"
   - 等待提示"✅ 游戏设置已保存！"

4. **测试配置持久化**
   - **刷新浏览器**（`Ctrl + R` 或 `F5`）
   - 重新登录DDKJ
   - 打开"管理员设置" → "游戏参数"
   - **✅ 检查"金币最大数量"是否还是 20**
   - **✅ 如果是20，说明修复成功！**

---

### 步骤3：重新配置您的设置

由于表结构被重建，之前的配置已丢失，需要重新设置：

#### 📢 广告设置
1. 打开"管理员设置" → "广告设置"
2. 重新上传广告图片（**确保图片没有绿色边框**）
3. 设置位置和透明度
4. 点击"添加广告气球"

#### 💳 支付设置
1. 打开"管理员设置" → "支付设置"
2. 重新上传支付宝收款码
3. 重新上传微信收款码
4. 填写Visa/Mastercard信息
5. 点击"💾 保存支付设置"

#### 🎮 游戏参数
1. 根据您的需求调整各项参数
2. 点击"💾 保存游戏设置"

---

## 🔍 如何验证表结构是否正确

在Supabase的SQL Editor中执行：

```sql
-- 查看表结构
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'global_game_settings';
```

**正确的结果应该是：**
```
column_name  | data_type
-------------+--------------------------
id           | text
settings     | jsonb
updated_at   | timestamp with time zone
```

**如果看到 `coin_spawn_rate`、`coin_max_count` 等字段，说明表结构是旧的，需要重新执行步骤1！**

---

## 📊 查看当前配置

随时可以在SQL Editor中执行：

```sql
SELECT 
  id,
  settings->>'coinMaxCount' as 金币最大数量,
  settings->>'diamondMaxCount' as 钻石最大数量,
  jsonb_array_length(settings->'adBalloons') as 广告数量,
  updated_at as 更新时间
FROM global_game_settings 
WHERE id = 'default';
```

---

## ⚠️ 注意事项

1. **执行SQL会删除旧表**，所有旧配置将丢失，需要重新设置
2. **确保备份重要的广告图片和收款码**，重建表后需要重新上传
3. **只需执行一次SQL**，多次执行是安全的（使用了 `DROP IF EXISTS` 和 `ON CONFLICT DO NOTHING`）
4. **所有玩家共享同一份配置**，修改后立即对全部玩家生效

---

## 🎯 成功标志

- ✅ 修改配置后刷新页面，配置不会丢失
- ✅ 其他玩家也能看到管理员设置的广告
- ✅ 控制台显示"✅ 全局配置加载成功！"
- ✅ 控制台不再显示"⚠️ 未找到全局配置"

---

## 🆘 遇到问题？

如果执行SQL后仍有问题：

1. **检查RLS策略是否正确**
```sql
SELECT * FROM pg_policies WHERE tablename = 'global_game_settings';
```

2. **检查数据是否成功插入**
```sql
SELECT * FROM global_game_settings;
```

3. **查看浏览器控制台**（F12）
   - 应该看到"✅ 全局配置加载成功！"
   - 如果看到错误，请提供完整的错误信息

---

**按照本指南操作后，配置刷新丢失的问题将彻底解决！** 🎉
